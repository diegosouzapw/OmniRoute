# рдУрдордиреАрд░реВрдЯ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

ЁЯМР **Languages:** ЁЯЗ║ЁЯЗ╕ [English](../../ARCHITECTURE.md) | ЁЯЗзЁЯЗ╖ [Portugu├кs (Brasil)](../pt-BR/ARCHITECTURE.md) | ЁЯЗкЁЯЗ╕ [Espa├▒ol](../es/ARCHITECTURE.md) | ЁЯЗлЁЯЗ╖ [Fran├зais](../fr/ARCHITECTURE.md) | ЁЯЗоЁЯЗ╣ [Italiano](../it/ARCHITECTURE.md) | ЁЯЗ╖ЁЯЗ║ [╨а╤Г╤Б╤Б╨║╨╕╨╣](../ru/ARCHITECTURE.md) | ЁЯЗиЁЯЗ│ [ф╕нцЦЗ (чоАф╜У)](../zh-CN/ARCHITECTURE.md) | ЁЯЗйЁЯЗк [Deutsch](../de/ARCHITECTURE.md) | ЁЯЗоЁЯЗ│ [рд╣рд┐рдиреНрджреА](../in/ARCHITECTURE.md) | ЁЯЗ╣ЁЯЗн [р╣Др╕Чр╕в](../th/ARCHITECTURE.md) | ЁЯЗ║ЁЯЗж [╨г╨║╤А╨░╤Ч╨╜╤Б╤М╨║╨░](../uk-UA/ARCHITECTURE.md) | ЁЯЗ╕ЁЯЗж [╪з┘Д╪╣╪▒╪и┘К╪й](../ar/ARCHITECTURE.md) | ЁЯЗпЁЯЗ╡ [цЧецЬмшкЮ](../ja/ARCHITECTURE.md) | ЁЯЗ╗ЁЯЗ│ [Tiс║┐ng Viс╗Зt](../vi/ARCHITECTURE.md) | ЁЯЗзЁЯЗм [╨С╤К╨╗╨│╨░╤А╤Б╨║╨╕](../bg/ARCHITECTURE.md) | ЁЯЗйЁЯЗ░ [Dansk](../da/ARCHITECTURE.md) | ЁЯЗлЁЯЗо [Suomi](../fi/ARCHITECTURE.md) | ЁЯЗоЁЯЗ▒ [╫в╫С╫и╫Щ╫к](../he/ARCHITECTURE.md) | ЁЯЗнЁЯЗ║ [Magyar](../hu/ARCHITECTURE.md) | ЁЯЗоЁЯЗй [Bahasa Indonesia](../id/ARCHITECTURE.md) | ЁЯЗ░ЁЯЗ╖ [эХЬъ╡ньЦ┤](../ko/ARCHITECTURE.md) | ЁЯЗ▓ЁЯЗ╛ [Bahasa Melayu](../ms/ARCHITECTURE.md) | ЁЯЗ│ЁЯЗ▒ [Nederlands](../nl/ARCHITECTURE.md) | ЁЯЗ│ЁЯЗ┤ [Norsk](../no/ARCHITECTURE.md) | ЁЯЗ╡ЁЯЗ╣ [Portugu├кs (Portugal)](../pt/ARCHITECTURE.md) | ЁЯЗ╖ЁЯЗ┤ [Rom├вn─Г](../ro/ARCHITECTURE.md) | ЁЯЗ╡ЁЯЗ▒ [Polski](../pl/ARCHITECTURE.md) | ЁЯЗ╕ЁЯЗ░ [Sloven─Нina](../sk/ARCHITECTURE.md) | ЁЯЗ╕ЁЯЗк [Svenska](../sv/ARCHITECTURE.md) | ЁЯЗ╡ЁЯЗн [Filipino](../phi/ARCHITECTURE.md)

_рдЕрдВрддрд┐рдо рдЕрджреНрдпрддрди: 2026-02-18_

## рдХрд╛рд░реНрдпрдХрд╛рд░реА рд╕рд╛рд░рд╛рдВрд╢

рдУрдордиреАрд░реВрдЯ рдПрдХ рд╕реНрдерд╛рдиреАрдп рдПрдЖрдИ рд░реВрдЯрд┐рдВрдЧ рдЧреЗрдЯрд╡реЗ рдФрд░ рдиреЗрдХреНрд╕реНрдЯ.рдЬреЗрдПрд╕ рдкрд░ рдирд┐рд░реНрдорд┐рдд рдбреИрд╢рдмреЛрд░реНрдб рд╣реИред
рдпрд╣ рдПрдХ рдПрдХрд▓ OpenAI-рд╕рдВрдЧрдд рдПрдВрдбрдкреЙрдЗрдВрдЯ (`/v1/*`) рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдиреБрд╡рд╛рдж, рдлрд╝реЙрд▓рдмреИрдХ, рдЯреЛрдХрди рд░рд┐рдлреНрд░реЗрд╢ рдФрд░ рдЙрдкрдпреЛрдЧ рдЯреНрд░реИрдХрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдХрдИ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдкреНрд░рджрд╛рддрд╛рдУрдВ рдХреЗ рдмреАрдЪ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рд░реВрдЯ рдХрд░рддрд╛ рд╣реИред

рдореБрдЦреНрдп рдХреНрд╖рдорддрд╛рдПрдВ:

- рд╕реАрдПрд▓рдЖрдИ/рдЯреВрд▓реНрд╕ рдХреЗ рд▓рд┐рдП рдУрдкрдирдПрдЖрдИ-рд╕рдВрдЧрдд рдПрдкреАрдЖрдИ рд╕рддрд╣ (28 рдкреНрд░рджрд╛рддрд╛)
- рдкреНрд░рджрд╛рддрд╛ рдкреНрд░рд╛рд░реВрдкреЛрдВ рдореЗрдВ рдЕрдиреБрд░реЛрдз/рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЕрдиреБрд╡рд╛рдж
- рдореЙрдбрд▓ рдХреЙрдореНрдмреЛ рдлрд╝реЙрд▓рдмреИрдХ (рдорд▓реНрдЯреА-рдореЙрдбрд▓ рдЕрдиреБрдХреНрд░рдо)
- рдЦрд╛рддрд╛-рд╕реНрддрд░реАрдп рдлрд╝реЙрд▓рдмреИрдХ (рдкреНрд░рддрд┐ рдкреНрд░рджрд╛рддрд╛ рдмрд╣реБ-рдЦрд╛рддрд╛)
- OAuth + рдПрдкреАрдЖрдИ-рдХреБрдВрдЬреА рдкреНрд░рджрд╛рддрд╛ рдХрдиреЗрдХреНрд╢рди рдкреНрд░рдмрдВрдзрди
- `/v1/embeddings` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдореНрдмреЗрдбрд┐рдВрдЧ рдкреАрдврд╝реА (6 рдкреНрд░рджрд╛рддрд╛, 9 рдореЙрдбрд▓)
- `/v1/images/generations` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЫрд╡рд┐ рдирд┐рд░реНрдорд╛рдг (4 рдкреНрд░рджрд╛рддрд╛, 9 рдореЙрдбрд▓)
- рддрд░реНрдХ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП рдЯреИрдЧ рдкрд╛рд░реНрд╕рд┐рдВрдЧ (`<think>...</think>`) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪреЗрдВ
- рд╕рдЦреНрдд рдУрдкрдирдПрдЖрдИ рдПрд╕рдбреАрдХреЗ рд╕рдВрдЧрддрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛
- рдХреНрд░реЙрд╕-рдкреНрд░рджрд╛рддрд╛ рдЕрдиреБрдХреВрд▓рддрд╛ рдХреЗ рд▓рд┐рдП рднреВрдорд┐рдХрд╛ рд╕рд╛рдорд╛рдиреНрдпреАрдХрд░рдг (рдбреЗрд╡рд▓рдкрд░тЖТрд╕рд┐рд╕реНрдЯрдо, рд╕рд┐рд╕реНрдЯрдотЖТрдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛)ред
- рд╕рдВрд░рдЪрд┐рдд рдЖрдЙрдЯрдкреБрдЯ рд░реВрдкрд╛рдВрддрд░рдг (json_schema тЖТ рдЬреЗрдорд┐рдиреА рд░рд┐рд╕реНрдкреЙрдиреНрд╕рд╕реНрдХреАрдорд╛)
- рдкреНрд░рджрд╛рддрд╛рдУрдВ, рдЪрд╛рдмрд┐рдпрд╛рдБ, рдЙрдкрдирд╛рдо, рдХреЙрдореНрдмреЛ, рд╕реЗрдЯрд┐рдВрдЧреНрд╕, рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдиреАрдп рджреГрдврд╝рддрд╛
- рдЙрдкрдпреЛрдЧ/рд▓рд╛рдЧрдд рдЯреНрд░реИрдХрд┐рдВрдЧ рдФрд░ рдЕрдиреБрд░реЛрдз рд▓реЙрдЧрд┐рдВрдЧ
- рдорд▓реНрдЯреА-рдбрд┐рд╡рд╛рдЗрд╕/рд╕реНрдЯреЗрдЯ рд╕рд┐рдВрдХ рдХреЗ рд▓рд┐рдП рд╡реИрдХрд▓реНрдкрд┐рдХ рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ
- рдПрдкреАрдЖрдИ рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рдЖрдИрдкреА рдЕрдиреБрдорддрд┐ рд╕реВрдЪреА/рдмреНрд▓реЙрдХрд▓рд┐рд╕реНрдЯ
- рд╕реЛрдЪ рдмрдЬрдЯ рдкреНрд░рдмрдВрдзрди (рдкрд╛рд╕рдереНрд░реВ/рдСрдЯреЛ/рдХрд╕реНрдЯрдо/рдЕрдиреБрдХреВрд▓реА)
- рд╡реИрд╢реНрд╡рд┐рдХ рдкреНрд░рдгрд╛рд▓реА рд╢реАрдШреНрд░ рдЗрдВрдЬреЗрдХреНрд╢рди
- рд╕рддреНрд░ рдЯреНрд░реИрдХрд┐рдВрдЧ рдФрд░ рдлрд╝рд┐рдВрдЧрд░рдкреНрд░рд┐рдВрдЯрд┐рдВрдЧ
- рдкреНрд░рджрд╛рддрд╛-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐-рдЦрд╛рддрд╛ рдмрдврд╝реА рд╣реБрдИ рджрд░ рд╕реАрдорд┐рдд рдХрд░рдирд╛
- рдкреНрд░рджрд╛рддрд╛ рд▓рдЪреАрд▓реЗрдкрди рдХреЗ рд▓рд┐рдП рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░ рдкреИрдЯрд░реНрди
- рдореНрдпреВрдЯреЗрдХреНрд╕ рд▓реЙрдХрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдПрдВрдЯреА-рдердВрдбрд░рд┐рдВрдЧ рдЭреБрдВрдб рд╕реБрд░рдХреНрд╖рд╛
- рд╣рд╕реНрддрд╛рдХреНрд╖рд░-рдЖрдзрд╛рд░рд┐рдд рдЕрдиреБрд░реЛрдз рдбрд┐рдбреБрдкреНрд▓реАрдХреЗрд╢рди рдХреИрд╢
- рдбреЛрдореЗрди рдкрд░рдд: рдореЙрдбрд▓ рдЙрдкрд▓рдмреНрдзрддрд╛, рд▓рд╛рдЧрдд рдирд┐рдпрдо, рдлрд╝реЙрд▓рдмреИрдХ рдиреАрддрд┐, рд▓реЙрдХрдЖрдЙрдЯ рдиреАрддрд┐
- рдбреЛрдореЗрди рд╕реНрдерд┐рддрд┐ рджреГрдврд╝рддрд╛ (рдлрд╝реЙрд▓рдмреИрдХ, рдмрдЬрдЯ, рд▓реЙрдХрдЖрдЙрдЯ, рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░ рдХреЗ рд▓рд┐рдП SQLite рд░рд╛рдЗрдЯ-рдереНрд░реВ рдХреИрд╢)
- рдХреЗрдВрджреНрд░реАрдХреГрдд рдЕрдиреБрд░реЛрдз рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЗ рд▓рд┐рдП рдиреАрддрд┐ рдЗрдВрдЬрди (рд▓реЙрдХрдЖрдЙрдЯ тЖТ рдмрдЬрдЯ тЖТ рдлрд╝реЙрд▓рдмреИрдХ)
- p50/p95/p99 рд╡рд┐рд▓рдВрдмрддрд╛ рдПрдХрддреНрд░реАрдХрд░рдг рдХреЗ рд╕рд╛рде рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдВ
- рдПрдВрдб-рдЯреВ-рдПрдВрдб рдЯреНрд░реЗрд╕рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕рд╣рд╕рдВрдмрдВрдз рдЖрдИрдбреА (рдПрдХреНрд╕-рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ-рдЖрдИрдбреА)ред
- рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдСрдкреНрдЯ-рдЖрдЙрдЯ рдХреЗ рд╕рд╛рде рдЕрдиреБрдкрд╛рд▓рди рдСрдбрд┐рдЯ рд▓реЙрдЧрд┐рдВрдЧ
- рдПрд▓рдПрд▓рдПрдо рдЧреБрдгрд╡рддреНрддрд╛ рдЖрд╢реНрд╡рд╛рд╕рди рдХреЗ рд▓рд┐рдП рдЗрд╡рд▓ рдлреНрд░реЗрдорд╡рд░реНрдХ
- рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░ рд╕реНрдерд┐рддрд┐ рдХреЗ рд╕рд╛рде рд▓рдЪреАрд▓рд╛рдкрди рдпреВрдЖрдИ рдбреИрд╢рдмреЛрд░реНрдб
- рдореЙрдбреНрдпреВрд▓рд░ OAuth рдкреНрд░рджрд╛рддрд╛ (`src/lib/oauth/providers/` рдХреЗ рдЕрдВрддрд░реНрдЧрдд 12 рд╡реНрдпрдХреНрддрд┐рдЧрдд рдореЙрдбреНрдпреВрд▓)

рдкреНрд░рд╛рдердорд┐рдХ рд░рдирдЯрд╛рдЗрдо рдореЙрдбрд▓:

- `src/app/api/*` рдХреЗ рдЕрдВрддрд░реНрдЧрдд Next.js рдРрдк рд░реВрдЯ рдбреИрд╢рдмреЛрд░реНрдб рдПрдкреАрдЖрдИ рдФрд░ рд╕рдВрдЧрддрддрд╛ рдПрдкреАрдЖрдИ рджреЛрдиреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ
- `src/sse/*` + `open-sse/*` рдореЗрдВ рдПрдХ рд╕рд╛рдЭрд╛ SSE/рд░реВрдЯрд┐рдВрдЧ рдХреЛрд░ рдкреНрд░рджрд╛рддрд╛ рдирд┐рд╖реНрдкрд╛рджрди, рдЕрдиреБрд╡рд╛рдж, рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ, рдлрд╝реЙрд▓рдмреИрдХ рдФрд░ рдЙрдкрдпреЛрдЧ рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ

## рджрд╛рдпрд░рд╛ рдФрд░ рд╕реАрдорд╛рдПрдБ

### рджрд╛рдпрд░реЗ рдореЗрдВ

- рд╕реНрдерд╛рдиреАрдп рдЧреЗрдЯрд╡реЗ рд░рдирдЯрд╛рдЗрдо
- рдбреИрд╢рдмреЛрд░реНрдб рдкреНрд░рдмрдВрдзрди рдПрдкреАрдЖрдИ
- рдкреНрд░рджрд╛рддрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдЯреЛрдХрди рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ
- рдЕрдиреБрд╡рд╛рдж рдФрд░ рдПрд╕рдПрд╕рдИ рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдВ
- рд╕реНрдерд╛рдиреАрдп рд╕реНрдерд┐рддрд┐ + рдЙрдкрдпреЛрдЧ рдХреА рджреГрдврд╝рддрд╛
- рд╡реИрдХрд▓реНрдкрд┐рдХ рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди

### рджрд╛рдпрд░реЗ рд╕реЗ рдмрд╛рд╣рд░

- `NEXT_PUBLIC_CLOUD_URL` рдХреЗ рдкреАрдЫреЗ рдХреНрд▓рд╛рдЙрдб рд╕реЗрд╡рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди
- рд╕реНрдерд╛рдиреАрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдмрд╛рд╣рд░ рдкреНрд░рджрд╛рддрд╛ рдПрд╕рдПрд▓рдП/рдирд┐рдпрдВрддреНрд░рдг рд╡рд┐рдорд╛рди
- рдмрд╛рд╣рд░реА рд╕реАрдПрд▓рдЖрдИ рдмрд╛рдпрдиреЗрд░рд┐рдЬрд╝ рд╕реНрд╡рдпрдВ (рдХреНрд▓рд╛рдЙрдб рд╕реАрдПрд▓рдЖрдИ, рдХреЛрдбреЗрдХреНрд╕ рд╕реАрдПрд▓рдЖрдИ, рдЖрджрд┐)

## рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рд╕рд┐рд╕реНрдЯрдо рд╕рдВрджрд░реНрдн

```mermaid
flowchart LR
    subgraph Clients[Developer Clients]
        C1[Claude Code]
        C2[Codex CLI]
        C3[OpenClaw / Droid / Cline / Continue / Roo]
        C4[Custom OpenAI-compatible clients]
        BROWSER[Browser Dashboard]
    end

    subgraph Router[OmniRoute Local Process]
        API[V1 Compatibility API\n/v1/*]
        DASH[Dashboard + Management API\n/api/*]
        CORE[SSE + Translation Core\nopen-sse + src/sse]
        DB[(db.json)]
        UDB[(usage.json + log.txt)]
    end

    subgraph Upstreams[Upstream Providers]
        P1[OAuth Providers\nClaude/Codex/Gemini/Qwen/iFlow/GitHub/Kiro/Cursor/Antigravity]
        P2[API Key Providers\nOpenAI/Anthropic/OpenRouter/GLM/Kimi/MiniMax\nDeepSeek/Groq/xAI/Mistral/Perplexity\nTogether/Fireworks/Cerebras/Cohere/NVIDIA]
        P3[Compatible Nodes\nOpenAI-compatible / Anthropic-compatible]
    end

    subgraph Cloud[Optional Cloud Sync]
        CLOUD[Cloud Sync Endpoint\nNEXT_PUBLIC_CLOUD_URL]
    end

    C1 --> API
    C2 --> API
    C3 --> API
    C4 --> API
    BROWSER --> DASH

    API --> CORE
    DASH --> DB
    CORE --> DB
    CORE --> UDB

    CORE --> P1
    CORE --> P2
    CORE --> P3

    DASH --> CLOUD
```

## рдХреЛрд░ рд░рдирдЯрд╛рдЗрдо рдШрдЯрдХ

## 1) рдПрдкреАрдЖрдИ рдФрд░ рд░реВрдЯрд┐рдВрдЧ рд▓реЗрдпрд░ (рдиреЗрдХреНрд╕реНрдЯ.рдЬреЗрдПрд╕ рдРрдк рд░реВрдЯреНрд╕)

рдореБрдЦреНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ:

- рдЕрдиреБрдХреВрд▓рддрд╛ рдПрдкреАрдЖрдИ рдХреЗ рд▓рд┐рдП `src/app/api/v1/*` рдФрд░ `src/app/api/v1beta/*`
- рдкреНрд░рдмрдВрдзрди/рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдПрдкреАрдЖрдИ рдХреЗ рд▓рд┐рдП `src/app/api/*`
- рдЕрдЧрд▓рд╛ `next.config.mjs` рдорд╛рдирдЪрд┐рддреНрд░ `/v1/*` рд╕реЗ `/api/v1/*` рдореЗрдВ рдкреБрдирдГ рд▓рд┐рдЦрддрд╛ рд╣реИ

рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрдиреБрдХреВрд▓рддрд╛ рдорд╛рд░реНрдЧ:

-
- `src/app/api/v1/messages/route.ts`
- `src/app/api/v1/responses/route.ts`
- `src/app/api/v1/models/route.ts` - `custom: true` рдХреЗ рд╕рд╛рде рдХрд╕реНрдЯрдо рдореЙрдбрд▓ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ
- `src/app/api/v1/embeddings/route.ts` - рдПрдореНрдмреЗрдбрд┐рдВрдЧ рдЬреЗрдирд░реЗрд╢рди (6 рдкреНрд░рджрд╛рддрд╛)
- `src/app/api/v1/images/generations/route.ts` - рдЫрд╡рд┐ рдирд┐рд░реНрдорд╛рдг (рдПрдВрдЯреАрдЧреНрд░реЗрд╡рд┐рдЯреА/рдиреЗрдмрд┐рдпрд╕ рд╕рд╣рд┐рдд 4+ рдкреНрд░рджрд╛рддрд╛)
- `src/app/api/v1/messages/count_tokens/route.ts`
- `src/app/api/v1/providers/[provider]/chat/completions/route.ts` - рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд рдЪреИрдЯ
- `src/app/api/v1/providers/[provider]/embeddings/route.ts` - рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд рдПрдореНрдмреЗрдбрд┐рдВрдЧ
- `src/app/api/v1/providers/[provider]/images/generations/route.ts` - рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд рдЫрд╡рд┐рдпрд╛рдВ
- `src/app/api/v1beta/models/route.ts`
- `src/app/api/v1beta/models/[...path]/route.ts`

рдкреНрд░рдмрдВрдзрди рдбреЛрдореЗрди:

- рдкреНрд░рдорд╛рдгреАрдХрд░рдг/рд╕реЗрдЯрд┐рдВрдЧреНрд╕: `src/app/api/auth/*`, `src/app/api/settings/*`
- рдкреНрд░рджрд╛рддрд╛/рдХрдиреЗрдХреНрд╢рди: `src/app/api/providers*`
- рдкреНрд░рджрд╛рддрд╛ рдиреЛрдб: `src/app/api/provider-nodes*`
- рдХрд╕реНрдЯрдо рдореЙрдбрд▓: `src/app/api/provider-models` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ/рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ/рд╣рдЯрд╛рдПрдВ)
- рдореЙрдбрд▓ рдХреИрдЯрд▓реЙрдЧ: `src/app/api/models/catalog` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди: `src/app/api/settings/proxy` (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ/рдбрд┐рд▓реАрдЯ) + `src/app/api/settings/proxy/test` (рдкреЛрд╕реНрдЯ)
- OAuth: `src/app/api/oauth/*`
- рдХреБрдВрдЬреА/рдЙрдкрдирд╛рдо/рдХреЙрдореНрдмреЛрд╕/рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг: `src/app/api/keys*`, `src/app/api/models/alias`, `src/app/api/combos*`, `src/app/api/pricing`
- рдЙрдкрдпреЛрдЧ: `src/app/api/usage/*`
- рд╕рд┐рдВрдХ/рдХреНрд▓рд╛рдЙрдб: `src/app/api/sync/*`, `src/app/api/cloud/*`
- рд╕реАрдПрд▓рдЖрдИ рдЯреВрд▓реАрдВрдЧ рд╕рд╣рд╛рдпрдХ: `src/app/api/cli-tools/*`
- рдЖрдИрдкреА рдлрд╝рд┐рд▓реНрдЯрд░: `src/app/api/settings/ip-filter` (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- рд╕реЛрдЪ рдмрдЬрдЯ: `src/app/api/settings/thinking-budget` (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЙрдореНрдкреНрдЯ: `src/app/api/settings/system-prompt` (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- рд╕рддреНрд░: `src/app/api/sessions` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рджрд░ рд╕реАрдорд╛: `src/app/api/rate-limits` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рд▓рдЪреАрд▓рд╛рдкрди: `src/app/api/resilience` (рдкреНрд░рд╛рдкреНрдд/рдкреИрдЪ) - рдкреНрд░рджрд╛рддрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓, рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░, рджрд░ рд╕реАрдорд╛ рд╕реНрдерд┐рддрд┐
- рд▓рдЪреАрд▓рд╛рдкрди рд░реАрд╕реЗрдЯ: `src/app/api/resilience/reset` (рдкреЛрд╕реНрдЯ) - рдмреНрд░реЗрдХрд░ рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ + рдХреВрд▓рдбрд╛рдЙрди
- рдХреИрд╢ рдЖрдБрдХрдбрд╝реЗ: `src/app/api/cache/stats` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ/рд╣рдЯрд╛рдПрдБ)
- рдореЙрдбрд▓ рдЙрдкрд▓рдмреНрдзрддрд╛: `src/app/api/models/availability` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ/рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ)
- рдЯреЗрд▓реАрдореЗрдЯреНрд░реА: `src/app/api/telemetry/summary` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рдмрдЬрдЯ: `src/app/api/usage/budget` (рдкреНрд░рд╛рдкреНрдд/рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ)
- рдлрд╝реЙрд▓рдмреИрдХ рдЪреЗрди: `src/app/api/fallback/chains` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ/рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ/рд╣рдЯрд╛рдПрдБ)
- рдЕрдиреБрдкрд╛рд▓рди рд▓реЗрдЦрд╛рдкрд░реАрдХреНрд╖рд╛: `src/app/api/compliance/audit-log` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рдореВрд▓реНрдпрд╛рдВрдХрди: `src/app/api/evals` (рдкреНрд░рд╛рдкреНрдд/рдкреЛрд╕реНрдЯ), `src/app/api/evals/[suiteId]` (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- рдиреАрддрд┐рдпрд╛рдВ: `src/app/api/policies` (рдкреНрд░рд╛рдкреНрдд/рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ)

## 2) рдПрд╕рдПрд╕рдИ + рдЕрдиреБрд╡рд╛рдж рдХреЛрд░

рдореБрдЦреНрдп рдкреНрд░рд╡рд╛рд╣ рдореЙрдбреНрдпреВрд▓:

- рдкреНрд░рд╡реЗрд╢: `src/sse/handlers/chat.ts`
- рдХреЛрд░ рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди: `open-sse/handlers/chatCore.ts`
- рдкреНрд░рджрд╛рддрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдПрдбрд╛рдкреНрдЯрд░: `open-sse/executors/*`
- рдкреНрд░рд╛рд░реВрдк рдкрд╣рдЪрд╛рди/рдкреНрд░рджрд╛рддрд╛ рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди: `open-sse/services/provider.ts`
- рдореЙрдбрд▓ рдкрд╛рд░реНрд╕/рд░рд┐рдЬрд╝реЙрд▓реНрдпреВрд╢рди: `src/sse/services/model.ts`, `open-sse/services/model.ts`
- рдЦрд╛рддрд╛ рдлрд╝реЙрд▓рдмреИрдХ рддрд░реНрдХ: `open-sse/services/accountFallback.ts`
- рдЕрдиреБрд╡рд╛рдж рд░рдЬрд┐рд╕реНрдЯреНрд░реА: `open-sse/translator/index.ts`
- рд╕реНрдЯреНрд░реАрдо рдкрд░рд┐рд╡рд░реНрддрди: `open-sse/utils/stream.ts`, `open-sse/utils/streamHandler.ts`
- рдЙрдкрдпреЛрдЧ рдирд┐рд╖реНрдХрд░реНрд╖рдг/рд╕рд╛рдорд╛рдиреНрдпреАрдХрд░рдг: `open-sse/utils/usageTracking.ts`
- рдЯреИрдЧ рдкрд╛рд░реНрд╕рд░ рд╕реЛрдЪреЗрдВ: `open-sse/utils/thinkTagParser.ts`
- рдПрдВрдмреЗрдбрд┐рдВрдЧ рд╣реИрдВрдбрд▓рд░: `open-sse/handlers/embeddings.ts`
- рдПрдВрдмреЗрдбрд┐рдВрдЧ рдкреНрд░рджрд╛рддрд╛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА: `open-sse/config/embeddingRegistry.ts`
- рдЫрд╡рд┐ рдирд┐рд░реНрдорд╛рдг рд╣реИрдВрдбрд▓рд░: `open-sse/handlers/imageGeneration.ts`
- рдЫрд╡рд┐ рдкреНрд░рджрд╛рддрд╛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА: `open-sse/config/imageRegistry.ts`
- рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛: `open-sse/handlers/responseSanitizer.ts`
- рднреВрдорд┐рдХрд╛ рд╕рд╛рдорд╛рдиреНрдпреАрдХрд░рдг: `open-sse/services/roleNormalizer.ts`

рд╕реЗрд╡рд╛рдПрдБ (рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рддрд░реНрдХ):

- рдЦрд╛рддрд╛ рдЪрдпрди/рд╕реНрдХреЛрд░рд┐рдВрдЧ: `open-sse/services/accountSelector.ts`
- рд╕рдВрджрд░реНрдн рдЬреАрд╡рдирдЪрдХреНрд░ рдкреНрд░рдмрдВрдзрди: `open-sse/services/contextManager.ts`
- рдЖрдИрдкреА рдлрд╝рд┐рд▓реНрдЯрд░ рдкреНрд░рд╡рд░реНрддрди: `open-sse/services/ipFilter.ts`
- рд╕рддреНрд░ рдЯреНрд░реИрдХрд┐рдВрдЧ: `open-sse/services/sessionManager.ts`
- рдбреБрдкреНрд▓рд┐рдХреЗрд╢рди рдЕрдиреБрд░реЛрдз: `open-sse/services/signatureCache.ts`
- рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЙрдореНрдкреНрдЯ рдЗрдВрдЬреЗрдХреНрд╢рди: `open-sse/services/systemPrompt.ts`
- рд╕реЛрдЪ рдмрдЬрдЯ рдкреНрд░рдмрдВрдзрди: `open-sse/services/thinkingBudget.ts`
- рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдореЙрдбрд▓ рд░реВрдЯрд┐рдВрдЧ: `open-sse/services/wildcardRouter.ts`
- рджрд░ рд╕реАрдорд╛ рдкреНрд░рдмрдВрдзрди: `open-sse/services/rateLimitManager.ts`
- рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░: `open-sse/services/circuitBreaker.ts`

рдбреЛрдореЗрди рдкрд░рдд рдореЙрдбреНрдпреВрд▓:

- рдореЙрдбрд▓ рдЙрдкрд▓рдмреНрдзрддрд╛: `src/lib/domain/modelAvailability.ts`
- рд▓рд╛рдЧрдд рдирд┐рдпрдо/рдмрдЬрдЯ: `src/lib/domain/costRules.ts`
- рдлрд╝реЙрд▓рдмреИрдХ рдиреАрддрд┐: `src/lib/domain/fallbackPolicy.ts`
- рдХреЙрдореНрдмреЛ рд░рд┐рдЬрд╝реЙрд▓реНрд╡рд░: `src/lib/domain/comboResolver.ts`
- рддрд╛рд▓рд╛рдмрдВрджреА рдиреАрддрд┐: `src/lib/domain/lockoutPolicy.ts`
- рдиреАрддрд┐ рдЗрдВрдЬрди: `src/domain/policyEngine.ts` - рдХреЗрдВрджреНрд░реАрдХреГрдд рддрд╛рд▓рд╛рдмрдВрджреА тЖТ рдмрдЬрдЯ тЖТ рдлрд╝реЙрд▓рдмреИрдХ рдореВрд▓реНрдпрд╛рдВрдХрди
- рддреНрд░реБрдЯрд┐ рдХреЛрдб рд╕реВрдЪреА: `src/lib/domain/errorCodes.ts`
- рдЕрдиреБрд░реЛрдз рдЖрдИрдбреА: `src/lib/domain/requestId.ts`
- рдлрд╝реЗрдЪ рдЯрд╛рдЗрдордЖрдЙрдЯ: `src/lib/domain/fetchTimeout.ts`
- рдЕрдиреБрд░реЛрдз рдЯреЗрд▓реАрдореЗрдЯреНрд░реА: `src/lib/domain/requestTelemetry.ts`
- рдЕрдиреБрдкрд╛рд▓рди/рдСрдбрд┐рдЯ: `src/lib/domain/compliance/index.ts`
- рдЗрд╡рд▓ рдзрд╛рд╡рдХ: `src/lib/domain/evalRunner.ts`
- рдбреЛрдореЗрди рд╕реНрдерд┐рддрд┐ рджреГрдврд╝рддрд╛: `src/lib/db/domainState.ts` - рдлрд╝реЙрд▓рдмреИрдХ рдЪреЗрди, рдмрдЬрдЯ, рд▓рд╛рдЧрдд рдЗрддрд┐рд╣рд╛рд╕, рд▓реЙрдХрдЖрдЙрдЯ рд╕реНрдерд┐рддрд┐, рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░ рдХреЗ рд▓рд┐рдП SQLite CRUD

OAuth рдкреНрд░рджрд╛рддрд╛ рдореЙрдбреНрдпреВрд▓ (`src/lib/oauth/providers/` рдХреЗ рдЕрдВрддрд░реНрдЧрдд 12 рд╡реНрдпрдХреНрддрд┐рдЧрдд рдлрд╝рд╛рдЗрд▓реЗрдВ):

- рд░рдЬрд┐рд╕реНрдЯреНрд░реА рд╕реВрдЪрдХрд╛рдВрдХ: `src/lib/oauth/providers/index.ts`
- рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкреНрд░рджрд╛рддрд╛: `claude.ts`, `codex.ts`, `gemini.ts`, `antigravity.ts`, `iflow.ts`, `qwen.ts`, `kimi-coding.ts`, `github.ts`, `kiro.ts`, `cursor.ts`, `kilocode.ts`, `cline.ts`
- рдкрддрд▓рд╛ рдЖрд╡рд░рдг: `src/lib/oauth/providers.ts` - рдЕрд▓рдЧ-рдЕрд▓рдЧ рдореЙрдбреНрдпреВрд▓ рд╕реЗ рдкреБрдирдГ рдирд┐рд░реНрдпрд╛рдд

## 3) рджреГрдврд╝рддрд╛ рдкрд░рдд

рдкреНрд░рд╛рдердорд┐рдХ рд╕реНрдерд┐рддрд┐ рдбреАрдмреА:

-
- рдлрд╝рд╛рдЗрд▓: `${DATA_DIR}/db.json` (рдпрд╛ рд╕реЗрдЯ рд╣реЛрдиреЗ рдкрд░ `$XDG_CONFIG_HOME/omniroute/db.json`, рдЕрдиреНрдпрдерд╛ `~/.omniroute/db.json`)
- рд╕рдВрд╕реНрдерд╛рдПрдБ: рдкреНрд░рджрд╛рддрд╛ рдХрдиреЗрдХреНрд╢рди, рдкреНрд░рджрд╛рддрд╛ рдиреЛрдбреНрд╕, рдореЙрдбрд▓ рдЙрдкрдирд╛рдо, рдХреЙрдореНрдмреЛ, рдПрдкреАрдХреАрдЬрд╝, рд╕реЗрдЯрд┐рдВрдЧреНрд╕, рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг, **рдХрд╕реНрдЯрдо рдореЙрдбрд▓**, **рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд┐рдЧ**, **рдЖрдИрдкреАрдлрд┐рд▓реНрдЯрд░**, **рдерд┐рдВрдХрд┐рдВрдЧрдмрдЬрдЯ**, **рд╕рд┐рд╕реНрдЯрдордкреНрд░реЙрдореНрдкреНрдЯ**

рдЙрдкрдпреЛрдЧ рдбреАрдмреА:

- `src/lib/usageDb.ts`
- рдлрд╝рд╛рдЗрд▓реЗрдВ: `${DATA_DIR}/usage.json`, `${DATA_DIR}/log.txt`, `${DATA_DIR}/call_logs/`
- `localDb` рдХреЗ рд╕рдорд╛рди рдореВрд▓ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдиреАрддрд┐ рдХрд╛ рдкрд╛рд▓рди рдХрд░рддрд╛ рд╣реИ (`DATA_DIR`, рдлрд┐рд░ рд╕реЗрдЯ рд╣реЛрдиреЗ рдкрд░ `XDG_CONFIG_HOME/omniroute`)
- рдХреЗрдВрджреНрд░рд┐рдд рдЙрдк-рдореЙрдбреНрдпреВрд▓ рдореЗрдВ рд╡рд┐рдШрдЯрд┐рдд: `migrations.ts`, `usageHistory.ts`, `costCalculator.ts`, `usageStats.ts`, `callLogs.ts`

рдбреЛрдореЗрди рд╕реНрдерд┐рддрд┐ DB (SQLite):

- `src/lib/db/domainState.ts` - рдбреЛрдореЗрди рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП CRUD рд╕рдВрдЪрд╛рд▓рди
- рддрд╛рд▓рд┐рдХрд╛рдПрдБ (`src/lib/db/core.ts` рдореЗрдВ рдирд┐рд░реНрдорд┐рдд): `domain_fallback_chains`, `domain_budgets`, `domain_cost_history`, `domain_lockout_state`, `domain_circuit_breakers`
- рд░рд╛рдЗрдЯ-рдереНрд░реВ рдХреИрд╢ рдкреИрдЯрд░реНрди: рдЗрди-рдореЗрдореЛрд░реА рдореИрдкреНрд╕ рд░рдирдЯрд╛рдЗрдо рдкрд░ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд╣реЛрддреЗ рд╣реИрдВ; рдЙрддреНрдкрд░рд┐рд╡рд░реНрддрди SQLite рдХреЗ рд╕рд╛рде рд╕рдордХрд╛рд▓рд┐рдХ рд░реВрдк рд╕реЗ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ; рдХреЛрд▓реНрдб рд╕реНрдЯрд╛рд░реНрдЯ рдкрд░ рд░рд╛рдЬреНрдп рдХреЛ рдбреАрдмреА рд╕реЗ рдмрд╣рд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ

## 4) рдкреНрд░рд╛рдорд╛рдгрд┐рдХ + рд╕реБрд░рдХреНрд╖рд╛ рд╕рддрд╣реЗрдВ

- рдбреИрд╢рдмреЛрд░реНрдб рдХреБрдХреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг: `src/proxy.ts`, `src/app/api/auth/login/route.ts`
- рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдирд┐рд░реНрдорд╛рдг/рд╕рддреНрдпрд╛рдкрди: `src/shared/utils/apiKey.ts`
- рдкреНрд░рджрд╛рддрд╛ рд░рд╣рд╕реНрдп `providerConnections` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдореЗрдВ рдмрдиреЗ рд░рд╣реЗ
- `open-sse/utils/proxyFetch.ts` (env vars) рдФрд░ `open-sse/utils/networkProxy.ts` (рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рдпрд╛ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдпреЛрдЧреНрдп) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдкреНрд░реЙрдХреНрд╕реА рд╕рдорд░реНрдерди

## 5) рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ

- рд╢реЗрдбреНрдпреВрд▓рд░ init: `src/lib/initCloudSync.ts`, `src/shared/services/initializeCloudSync.ts`
- рдЖрд╡рдзрд┐рдХ рдХрд╛рд░реНрдп: `src/shared/services/cloudSyncScheduler.ts`
- рдирд┐рдпрдВрддреНрд░рдг рдорд╛рд░реНрдЧ: `src/app/api/sync/cloud/route.ts`

## рдЕрдиреБрд░реЛрдз рдЬреАрд╡рдирдЪрдХреНрд░ (`/v1/chat/completions`)

## рдХреЙрдореНрдмреЛ + рдЕрдХрд╛рдЙрдВрдЯ рдлрд╝реЙрд▓рдмреИрдХ рдлрд╝реНрд▓реЛ

```mermaid
flowchart TD
    A[Incoming model string] --> B{Is combo name?}
    B -- Yes --> C[Load combo models sequence]
    B -- No --> D[Single model path]

    C --> E[Try model N]
    E --> F[Resolve provider/model]
    D --> F

    F --> G[Select account credentials]
    G --> H{Credentials available?}
    H -- No --> I[Return provider unavailable]
    H -- Yes --> J[Execute request]

    J --> K{Success?}
    K -- Yes --> L[Return response]
    K -- No --> M{Fallback-eligible error?}

    M -- No --> N[Return error]
    M -- Yes --> O[Mark account unavailable cooldown]
    O --> P{Another account for provider?}
    P -- Yes --> G
    P -- No --> Q{In combo with next model?}
    Q -- Yes --> E
    Q -- No --> R[Return all unavailable]
```

рдлрд╝реЙрд▓рдмреИрдХ рдирд┐рд░реНрдгрдп рд╕реНрдерд┐рддрд┐ рдХреЛрдб рдФрд░ рддреНрд░реБрдЯрд┐-рд╕рдВрджреЗрд╢ рдЕрдиреБрдорд╛рдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `open-sse/services/accountFallback.ts` рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред

## OAuth рдСрдирдмреЛрд░реНрдбрд┐рдВрдЧ рдФрд░ рдЯреЛрдХрди рд░рд┐рдлреНрд░реЗрд╢ рдЬреАрд╡рдирдЪрдХреНрд░

```mermaid
sequenceDiagram
    autonumber
    participant UI as Dashboard UI
    participant OAuth as /api/oauth/[provider]/[action]
    participant ProvAuth as Provider Auth Server
    participant DB as localDb
    participant Test as /api/providers/[id]/test
    participant Exec as Provider Executor

    UI->>OAuth: GET authorize or device-code
    OAuth->>ProvAuth: create auth/device flow
    ProvAuth-->>OAuth: auth URL or device code payload
    OAuth-->>UI: flow data

    UI->>OAuth: POST exchange or poll
    OAuth->>ProvAuth: token exchange/poll
    ProvAuth-->>OAuth: access/refresh tokens
    OAuth->>DB: createProviderConnection(oauth data)
    OAuth-->>UI: success + connection id

    UI->>Test: POST /api/providers/[id]/test
    Test->>Exec: validate credentials / optional refresh
    Exec-->>Test: valid or refreshed token info
    Test->>DB: update status/tokens/errors
    Test-->>UI: validation result
```

рд▓рд╛рдЗрд╡ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЗ рджреМрд░рд╛рди рд░рд┐рдлреНрд░реЗрд╢ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрдХ `refreshCredentials()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `open-sse/handlers/chatCore.ts` рдХреЗ рдЕрдВрджрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

## рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ рдЬреАрд╡рдирдЪрдХреНрд░ (рд╕рдХреНрд╖рдо/рд╕рд┐рдВрдХ/рдЕрдХреНрд╖рдо)

```mermaid
sequenceDiagram
    autonumber
    participant UI as Endpoint Page UI
    participant Sync as /api/sync/cloud
    participant DB as localDb
    participant Cloud as External Cloud Sync
    participant Claude as ~/.claude/settings.json

    UI->>Sync: POST action=enable
    Sync->>DB: set cloudEnabled=true
    Sync->>DB: ensure API key exists
    Sync->>Cloud: POST /sync/{machineId} (providers/aliases/combos/keys)
    Cloud-->>Sync: sync result
    Sync->>Cloud: GET /{machineId}/v1/verify
    Sync-->>UI: enabled + verification status

    UI->>Sync: POST action=sync
    Sync->>Cloud: POST /sync/{machineId}
    Cloud-->>Sync: remote data
    Sync->>DB: update newer local tokens/status
    Sync-->>UI: synced

    UI->>Sync: POST action=disable
    Sync->>DB: set cloudEnabled=false
    Sync->>Cloud: DELETE /sync/{machineId}
    Sync->>Claude: switch ANTHROPIC_BASE_URL back to local (if needed)
    Sync-->>UI: disabled
```

рдХреНрд▓рд╛рдЙрдб рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдкрд░ рдЖрд╡рдзрд┐рдХ рд╕рд┐рдВрдХ `CloudSyncScheduler` рджреНрд╡рд╛рд░рд╛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

## рдбреЗрдЯрд╛ рдореЙрдбрд▓ рдФрд░ рд╕реНрдЯреЛрд░реЗрдЬ рдореИрдк

рднреМрддрд┐рдХ рднрдВрдбрд╛рд░рдг рдлрд╝рд╛рдЗрд▓реЗрдВ:

- рдореБрдЦреНрдп рд╕реНрдерд┐рддрд┐: `${DATA_DIR}/db.json` (рдпрд╛ рд╕реЗрдЯ рд╣реЛрдиреЗ рдкрд░ `$XDG_CONFIG_HOME/omniroute/db.json`, рдЕрдиреНрдпрдерд╛ `~/.omniroute/db.json`)
- рдЙрдкрдпреЛрдЧ рдЖрдБрдХрдбрд╝реЗ: `${DATA_DIR}/usage.json`
- рдЕрдиреБрд░реЛрдз рд▓реЙрдЧ рд▓рд╛рдЗрдиреЗрдВ: `${DATA_DIR}/log.txt`
- рд╡реИрдХрд▓реНрдкрд┐рдХ рдЕрдиреБрд╡рд╛рджрдХ/рдЕрдиреБрд░реЛрдз рдбрд┐рдмрдЧ рд╕рддреНрд░: `<repo>/logs/...`

## рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдЯреЛрдкреЛрд▓реЙрдЬреА

## рдореЙрдбреНрдпреВрд▓ рдореИрдкрд┐рдВрдЧ (рдирд┐рд░реНрдгрдп-рдорд╣рддреНрд╡рдкреВрд░реНрдг)

### рд░реВрдЯ рдФрд░ рдПрдкреАрдЖрдИ рдореЙрдбреНрдпреВрд▓

- `src/app/api/v1/*`, `src/app/api/v1beta/*`: рдЕрдиреБрдХреВрд▓рддрд╛ рдПрдкреАрдЖрдИ
- `src/app/api/v1/providers/[provider]/*`: рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд рдорд╛рд░реНрдЧ (рдЪреИрдЯ, рдПрдореНрдмреЗрдбрд┐рдВрдЧ, рдЪрд┐рддреНрд░)
- `src/app/api/providers*`: рдкреНрд░рджрд╛рддрд╛ CRUD, рд╕рддреНрдпрд╛рдкрди, рдкрд░реАрдХреНрд╖рдг
- `src/app/api/provider-nodes*`: рдХрд╕реНрдЯрдо рд╕рдВрдЧрдд рдиреЛрдб рдкреНрд░рдмрдВрдзрди
- `src/app/api/provider-models`: рдХрд╕реНрдЯрдо рдореЙрдбрд▓ рдкреНрд░рдмрдВрдзрди (CRUD)
- `src/app/api/models/catalog`: рдкреВрд░реНрдг рдореЙрдбрд▓ рдХреИрдЯрд▓реЙрдЧ рдПрдкреАрдЖрдИ (рдкреНрд░рджрд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕рдореВрд╣реАрдХреГрдд рд╕рднреА рдкреНрд░рдХрд╛рд░)
- `src/app/api/oauth/*`: OAuth/рдбрд┐рд╡рд╛рдЗрд╕-рдХреЛрдб рдкреНрд░рд╡рд╛рд╣
- `src/app/api/keys*`: рд╕реНрдерд╛рдиреАрдп рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдЬреАрд╡рдирдЪрдХреНрд░
- `src/app/api/models/alias`: рдЙрдкрдирд╛рдо рдкреНрд░рдмрдВрдзрди
- `src/app/api/combos*`: рдлрд╝реЙрд▓рдмреИрдХ рдХреЙрдореНрдмреЛ рдкреНрд░рдмрдВрдзрди
- `src/app/api/pricing`: рд▓рд╛рдЧрдд рдЧрдгрдирд╛ рдХреЗ рд▓рд┐рдП рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рдг рдУрд╡рд░рд░рд╛рдЗрдб рд╣реЛрддрд╛ рд╣реИ
- `src/app/api/settings/proxy`: рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ/рд╣рдЯрд╛рдПрдВ)
- `src/app/api/settings/proxy/test`: рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдкреНрд░реЙрдХреНрд╕реА рдХрдиреЗрдХреНрдЯрд┐рд╡рд┐рдЯреА рдЯреЗрд╕реНрдЯ (POST)
- `src/app/api/usage/*`: рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдФрд░ рд▓реЙрдЧ
- `src/app/api/sync/*` + `src/app/api/cloud/*`: рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ рдФрд░ рдХреНрд▓рд╛рдЙрдб-рдлреЗрд╕рд┐рдВрдЧ рд╕рд╣рд╛рдпрдХ
- `src/app/api/cli-tools/*`: рд╕реНрдерд╛рдиреАрдп рд╕реАрдПрд▓рдЖрдИ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд▓реЗрдЦрдХ/рдЪреЗрдХрд░реНрд╕
- `src/app/api/settings/ip-filter`: рдЖрдИрдкреА рдЕрдиреБрдорддрд┐ рд╕реВрдЪреА/рдмреНрд▓реЙрдХрд▓рд┐рд╕реНрдЯ (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- `src/app/api/settings/thinking-budget`: рд╕реЛрдЪ рдЯреЛрдХрди рдмрдЬрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- `src/app/api/settings/system-prompt`: рдЧреНрд▓реЛрдмрд▓ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЙрдореНрдкреНрдЯ (рдкреНрд░рд╛рдкреНрдд/рдкреБрдЯ)
- `src/app/api/sessions`: рд╕рдХреНрд░рд┐рдп рд╕рддреНрд░ рд╕реВрдЪреА (рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
- `src/app/api/rate-limits`: рдкреНрд░рддрд┐ рдЦрд╛рддрд╛ рджрд░ рд╕реАрдорд╛ рд╕реНрдерд┐рддрд┐ (GET)

### рд░реВрдЯрд┐рдВрдЧ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛрд░

- `src/sse/handlers/chat.ts`: рдЕрдиреБрд░реЛрдз рдкрд╛рд░реНрд╕, рдХреЙрдореНрдмреЛ рд╣реИрдВрдбрд▓рд┐рдВрдЧ, рдЦрд╛рддрд╛ рдЪрдпрди рд▓реВрдк
- `open-sse/handlers/chatCore.ts`: рдЕрдиреБрд╡рд╛рдж, рдирд┐рд╖реНрдкрд╛рджрдХ рдкреНрд░реЗрд╖рдг, рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕/рд░реАрдлреНрд░реЗрд╢ рд╣реИрдВрдбрд▓рд┐рдВрдЧ, рд╕реНрдЯреНрд░реАрдо рд╕реЗрдЯрдЕрдк
- `open-sse/executors/*`: рдкреНрд░рджрд╛рддрд╛-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдиреЗрдЯрд╡рд░реНрдХ рдФрд░ рдкреНрд░рд╛рд░реВрдк рд╡реНрдпрд╡рд╣рд╛рд░

### рдЕрдиреБрд╡рд╛рдж рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдФрд░ рдкреНрд░рд╛рд░реВрдк рдкрд░рд┐рд╡рд░реНрддрдХ

- `open-sse/translator/index.ts`: рдЕрдиреБрд╡рд╛рджрдХ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдФрд░ рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди
- рдЕрдиреБрд╡рд╛рджрдХреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз: `open-sse/translator/request/*`
- рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЕрдиреБрд╡рд╛рджрдХ: `open-sse/translator/response/*`
- рдкреНрд░рд╛рд░реВрдк рд╕реНрдерд┐рд░рд╛рдВрдХ: `open-sse/translator/formats.ts`

### рджреГрдврд╝рддрд╛

- `src/lib/localDb.ts`: рд▓рдЧрд╛рддрд╛рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди/рд╕реНрдерд┐рддрд┐
- `src/lib/usageDb.ts`: рдЙрдкрдпреЛрдЧ рдЗрддрд┐рд╣рд╛рд╕ рдФрд░ рд░реЛрд▓рд┐рдВрдЧ рдЕрдиреБрд░реЛрдз рд▓реЙрдЧ

## рдкреНрд░рджрд╛рддрд╛ рдирд┐рд╖реНрдкрд╛рджрдХ рдХрд╡рд░реЗрдЬ (рд░рдгрдиреАрддрд┐ рдкреИрдЯрд░реНрди)

рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рджрд╛рддрд╛ рдХреЗ рдкрд╛рд╕ `BaseExecutor` (`open-sse/executors/base.ts` рдореЗрдВ) рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдирд┐рд╖реНрдкрд╛рджрдХ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ URL рдирд┐рд░реНрдорд╛рдг, рд╣реЗрдбрд░ рдирд┐рд░реНрдорд╛рдг, рдШрд╛рддреАрдп рдмреИрдХрдСрдлрд╝ рдХреЗ рд╕рд╛рде рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕, рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рд░рд┐рдлреНрд░реЗрд╢ рд╣реБрдХ рдФрд░ `execute()` рдСрд░реНрдХреЗрд╕реНрдЯреНрд░реЗрд╢рди рд╡рд┐рдзрд┐ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

| рдирд┐рд╖реНрдкрд╛рджрдХ              | рдкреНрд░рджрд╛рддрд╛(рдУрдВ)                                                                                                                                                                  | рд╡рд┐рд╢реЗрд╖ рд╣реИрдВрдбрд▓рд┐рдВрдЧ                                                                          |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| `DefaultExecutor`     | рдУрдкрдирдПрдЖрдИ, рдХреНрд▓рд╛рдЙрдб, рдЬреЗрдорд┐рдиреА, рдХреНрд╡реЗрди, рдЖрдИрдлреНрд▓реЛ, рдУрдкрдирд░рд╛рдЙрдЯрд░, рдЬреАрдПрд▓рдПрдо, рдХрд┐рдореА, рдорд┐рдиреАрдореИрдХреНрд╕, рдбреАрдкрд╕реАрдХ, рдЧреНрд░реЛрдХ, рдПрдХреНрд╕рдПрдЖрдИ, рдорд┐рд╕реНрдЯреНрд░рд▓, рдкрд░реНрдкреНрд▓реЗрдХреНрд╕рд┐рдЯреА, рдЯреБрдЧреЗрджрд░, рдлрд╛рдпрд░рд╡рд░реНрдХреНрд╕, рд╕реЗрд░реЗрдмреНрд░рд╛, рдХреЛрд╣реЗрд░реЗ, рдПрдирд╡реАрдЖрдИрдбреАрдЖрдИрдП | рдкреНрд░рддрд┐ рдкреНрд░рджрд╛рддрд╛ рдбрд╛рдпрдирд╛рдорд┐рдХ рдпреВрдЖрд░рдПрд▓/рд╣реЗрдбрд░ рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди                                          |
| `AntigravityExecutor` | рдЧреВрдЧрд▓ рдПрдВрдЯреАрдЧреНрд░реЗрд╡рд┐рдЯреА                                                                                                                                                            | рдХрд╕реНрдЯрдо рдкреНрд░реЛрдЬреЗрдХреНрдЯ/рд╕рддреНрд░ рдЖрдИрдбреА, рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ-рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдХреЗ рдмрд╛рдж                             |
| `CodexExecutor`       | рдУрдкрдирдПрдЖрдИ рдХреЛрдбреЗрдХреНрд╕                                                                                                                                                               | рд╕рд┐рд╕реНрдЯрдо рдирд┐рд░реНрджреЗрд╢ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рддрд╛ рд╣реИ, рддрд░реНрдХ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИ                             |
| `CursorExecutor`      | рдХрд░реНрд╕рд░ рдЖрдИрдбреАрдИ                                                                                                                                                                  | рдХрдиреЗрдХреНрдЯрдЖрд░рдкреАрд╕реА рдкреНрд░реЛрдЯреЛрдХреЙрд▓, рдкреНрд░реЛрдЯреЛрдмрдл рдПрдиреНрдХреЛрдбрд┐рдВрдЧ, рдЪреЗрдХрд╕рдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз |
| `GithubExecutor`      | рдЧрд┐рдЯрд╣рдм рдХреЛрдкрд╛рдпрд▓рдЯ                                                                                                                                                                | рдХреЛрдкрд╛рдпрд▓рдЯ рдЯреЛрдХрди рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ, VSCode-рдирдХрд▓ рд╣реЗрдбрд░                                                |
| `KiroExecutor`        | рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рдХреЛрдбрд╡реНрд╣рд┐рд╕реНрдкрд░рд░/рдХрд┐рд░реЛ                                                                                                                                                 | рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рдЗрд╡реЗрдВрдЯрд╕реНрдЯреНрд░реАрдо рдмрд╛рдЗрдирд░реА рдкреНрд░рд╛рд░реВрдк тЖТ рдПрд╕рдПрд╕рдИ рд░реВрдкрд╛рдВрддрд░рдг                                 |
| `GeminiCLIExecutor`   | рдЬреЗрдорд┐рдиреА рд╕реАрдПрд▓рдЖрдИ                                                                                                                                                                | Google OAuth рдЯреЛрдХрди рддрд╛рдЬрд╝рд╛ рдЪрдХреНрд░                                                            |

рдЕрдиреНрдп рд╕рднреА рдкреНрд░рджрд╛рддрд╛ (рдХрд╕реНрдЯрдо рд╕рдВрдЧрдд рдиреЛрдбреНрд╕ рд╕рд╣рд┐рдд) `DefaultExecutor` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред

## рдкреНрд░рджрд╛рддрд╛ рд╕рдВрдЧрддрддрд╛ рдореИрдЯреНрд░рд┐рдХреНрд╕

| рдкреНрд░рджрд╛рддрд╛               | рдкреНрд░рд╛рд░реВрдк              | рдкреНрд░рд╛рдорд╛рдгрд┐рдХ                | рд╕реНрдЯреНрд░реАрдо           | рдиреЙрди-рд╕реНрдЯреНрд░реАрдо | рдЯреЛрдХрди рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ | рдЙрдкрдпреЛрдЧ рдПрдкреАрдЖрдИ         |
| --------------------- | -------------------- | ------------------------ | ----------------- | ----------- | --------------- | ------------------- |
| рдХреНрд▓рд╛рдЙрдб                | рдХреНрд▓рд╛рдЙрдб               | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА / OAuth      | тЬЕ                | тЬЕ          | тЬЕ              | тЪая╕П рдХреЗрд╡рд▓ рдПрдбрдорд┐рди       |
| рдорд┐рдереБрди                 | рдорд┐рдереБрди                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА / OAuth      | тЬЕ                | тЬЕ          | тЬЕ              | тЪая╕П рдХреНрд▓рд╛рдЙрдб рдХрдВрд╕реЛрд▓     |
| рдЬреЗрдорд┐рдиреА рд╕реАрдПрд▓рдЖрдИ         | рдорд┐рдереБрди-рдХреНрд▓реА           | OAuth                    | тЬЕ                | тЬЕ          | тЬЕ              | тЪая╕П рдХреНрд▓рд╛рдЙрдб рдХрдВрд╕реЛрд▓     |
| рдкреНрд░рддрд┐рдЧреБрд░реБрддреНрд╡рд╛рдХрд░реНрд╖рдг    | рдкреНрд░рддрд┐рдЧреБрд░реБрддреНрд╡рд╛рдХрд░реНрд╖рдг   | OAuth                    | тЬЕ                | тЬЕ          | тЬЕ              | тЬЕ рдкреВрд░реНрдг рдХреЛрдЯрд╛ рдПрдкреАрдЖрдИ |
| рдУрдкрдирдПрдЖрдИ                | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдХреЛрдбреЗрдХреНрд╕               | openai-рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдВ | OAuth                    | тЬЕ рдордЬрдмреВрд░          | тЭМ          | тЬЕ              | тЬЕ рджрд░ рд╕реАрдорд╛          |
| рдЧрд┐рдЯрд╣рдм рдХреЛрдкрд╛рдпрд▓рдЯ         | рдУрдкрдирд╛рдИ                | OAuth + рд╕рд╣рдкрд╛рдпрд▓рдЯ рдЯреЛрдХрди     | тЬЕ                | тЬЕ          | тЬЕ              | тЬЕ рдХреЛрдЯрд╛ рд╕реНрдиреИрдкрд╢реЙрдЯ    |
| рдХрд░реНрд╕рд░                 | рдХрд░реНрд╕рд░                | рдХрд╕реНрдЯрдо рдЪреЗрдХрд╕рдо              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдХрд┐рд░реЛ                  | рдХрд┐рд░реЛ                 | рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рдПрд╕рдПрд╕рдУ рдУрдЖрдИрдбреАрд╕реА | тЬЕ (рдЗрд╡реЗрдВрдЯрд╕реНрдЯреНрд░реАрдо) | тЭМ          | тЬЕ              | тЬЕ рдЙрдкрдпреЛрдЧ рд╕реАрдорд╛       |
| рдХреНрд╡реЗрди                 | рдУрдкрдирд╛рдИ                | OAuth                    | тЬЕ                | тЬЕ          | тЬЕ              | тЪая╕П рдкреНрд░рддрд┐ рдЕрдиреБрд░реЛрдз     |
| рдЖрдИрдлреНрд▓реЛ                | рдУрдкрдирд╛рдИ                | OAuth (рдмреЗрд╕рд┐рдХ)            | тЬЕ                | тЬЕ          | тЬЕ              | тЪая╕П рдкреНрд░рддрд┐ рдЕрдиреБрд░реЛрдз     |
| рдУрдкрдирд░рд╛рдЙрдЯрд░              | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдЬреАрдПрд▓рдПрдо/рдХрд┐рдореА/рдорд┐рдиреАрдореИрдХреНрд╕ | рдХреНрд▓рд╛рдЙрдб               | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдбреАрдкрд╕реАрдХ                | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдЧреНрд░реЛрдХ                 | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдПрдХреНрд╕рдПрдЖрдИ (рдЧреНрд░реЛрдХ)       | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдорд┐рд╕реНрдЯреНрд░рд▓              | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдЙрд▓рдЭрди                  | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдПрдХ рд╕рд╛рде рдПрдЖрдИ            | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдЖрддрд┐рд╢рдмрд╛рдЬреА рдПрдЖрдИ          | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рд╕реЗрд░реЗрдмреНрд░рд╕              | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рд╕рд╣рднрд╛рдЧреА                | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |
| рдПрдирд╡реАрдбрд┐рдпрд╛ рдПрдирдЖрдИрдПрдо       | рдУрдкрдирд╛рдИ                | рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА              | тЬЕ                | тЬЕ          | тЭМ              | тЭМ                  |

## рдкреНрд░рд╛рд░реВрдк рдЕрдиреБрд╡рд╛рдж рдХрд╡рд░реЗрдЬ

рдкрддрд╛ рд▓рдЧрд╛рдП рдЧрдП рд╕реНрд░реЛрдд рдкреНрд░рд╛рд░реВрдкреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

- `openai`
- `openai-responses`
- `claude`
- `gemini`

рд▓рдХреНрд╖реНрдп рдкреНрд░рд╛рд░реВрдкреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

- рдУрдкрдирдПрдЖрдИ рдЪреИрдЯ/рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдВ
  -рдХреНрд▓рд╛рдЙрдб
- рдорд┐рдереБрди/рдорд┐рдереБрди-рд╕реАрдПрд▓рдЖрдИ/рдПрдВрдЯреАрдЧреНрд░реЗрд╡рд┐рдЯреА рд▓рд┐рдлрд╛рдлрд╛
- рдХрд┐рд░реЛ
- рдХрд░реНрд╕рд░

рдЕрдиреБрд╡рд╛рдж **рд╣рдм рдкреНрд░рд╛рд░реВрдк рдХреЗ рд░реВрдк рдореЗрдВ рдУрдкрдирдПрдЖрдИ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ - рд╕рднреА рд░реВрдкрд╛рдВрддрд░рдг рдордзреНрдпрд╡рд░реНрддреА рдХреЗ рд░реВрдк рдореЗрдВ рдУрдкрдирдПрдЖрдИ рд╕реЗ рдЧреБрдЬрд░рддреЗ рд╣реИрдВ:

```
Source Format тЖТ OpenAI (hub) тЖТ Target Format
```

рд╕реНрд░реЛрдд рдкреЗрд▓реЛрдб рдЖрдХрд╛рд░ рдФрд░ рдкреНрд░рджрд╛рддрд╛ рд▓рдХреНрд╖реНрдп рдкреНрд░рд╛рд░реВрдк рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЕрдиреБрд╡рд╛рджреЛрдВ рдХрд╛ рдЪрдпрди рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЕрдиреБрд╡рд╛рдж рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдкрд░рддреЗрдВ:

- **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡рдЪреНрдЫрддрд╛** - рд╕рдЦреНрдд рдПрд╕рдбреАрдХреЗ рдЕрдиреБрдкрд╛рд▓рди рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдУрдкрдирдПрдЖрдИ-рдкреНрд░рд╛рд░реВрдк рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ (рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рдФрд░ рдЧреИрд░-рд╕реНрдЯреНрд░реАрдорд┐рдВрдЧ рджреЛрдиреЛрдВ) рд╕реЗ рдЧреИрд░-рдорд╛рдирдХ рдлрд╝реАрд▓реНрдб рд╣рдЯрд╛ рджреЗрддрд╛ рд╣реИ
- **рднреВрдорд┐рдХрд╛ рд╕рд╛рдорд╛рдиреНрдпреАрдХрд░рдг** - рдЧреИрд░-рдУрдкрдирдПрдЖрдИ рд▓рдХреНрд╖реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП `developer` тЖТ `system` рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рддрд╛ рд╣реИ; рд╕рд┐рд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдореЙрдбрд▓реЛрдВ рдХреЗ рд▓рд┐рдП `system` тЖТ `user` рдХрд╛ рд╡рд┐рд▓рдп (GLM, ERNIE)
- **рдЯреИрдЧ рдирд┐рд╖реНрдХрд░реНрд╖рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪреЗрдВ** - рдкрд╛рд░реНрд╕ `<think>...</think>` рд╕рд╛рдордЧреНрд░реА рдХреЛ `reasoning_content` рдлрд╝реАрд▓реНрдб рдореЗрдВ рдмреНрд▓реЙрдХ рдХрд░рддрд╛ рд╣реИ
- **рд╕рдВрд░рдЪрд┐рдд рдЖрдЙрдЯрдкреБрдЯ** - OpenAI `response_format.json_schema` рдХреЛ рдорд┐рдереБрди рдХреЗ `responseMimeType` + `responseSchema` рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рддрд╛ рд╣реИ

## рд╕рдорд░реНрдерд┐рдд рдПрдкреАрдЖрдИ рд╕рдорд╛рдкрди рдмрд┐рдВрджреБ

| рд╕рдорд╛рдкрди рдмрд┐рдВрджреБ                                        | рдкреНрд░рд╛рд░реВрдк              | рд╣реИрдВрдбрд▓рд░                                             |
| -------------------------------------------------- | -------------------- | -------------------------------------------------- | ------------------------ |
| `POST /v1/chat/completions`                        | рдУрдкрдирдПрдЖрдИ рдЪреИрдЯ           | `src/sse/handlers/chat.ts`                         |
| `POST /v1/messages`                                | рдХреНрд▓рд╛рдЙрдб рд╕рдВрджреЗрд╢         | рд╡рд╣реА рд╣реИрдВрдбрд▓рд░ (рд╕реНрд╡рддрдГ рдкрддрд╛ рдЪрд▓рд╛)                         |
| `POST /v1/responses`                               | рдУрдкрдирдПрдЖрдИ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ | `open-sse/handlers/responsesHandler.ts`            |
| `POST /v1/embeddings`                              | рдУрдкрдирдПрдЖрдИ рдПрдВрдмреЗрдбрд┐рдВрдЧреНрд╕    | `open-sse/handlers/embeddings.ts`                  |
| `GET /v1/embeddings`                               | рдореЙрдбрд▓ рд╕реВрдЪреА            | рдПрдкреАрдЖрдИ рдорд╛рд░реНрдЧ                                        |
| `POST /v1/images/generations`                      | OpenAI рдЫрд╡рд┐рдпрд╛рдБ        |                                                    |
| `GET /v1/images/generations`                       | рдореЙрдбрд▓ рд╕реВрдЪреА            | рдПрдкреАрдЖрдИ рдорд╛рд░реНрдЧ                                        |
| `POST /v1/providers/{provider}/chat/completions`   | рдУрдкрдирдПрдЖрдИ рдЪреИрдЯ           | рдореЙрдбрд▓ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд          |
|                                                    | рдУрдкрдирдПрдЖрдИ рдПрдВрдмреЗрдбрд┐рдВрдЧреНрд╕    | рдореЙрдбрд▓ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд          |
| `POST /v1/providers/{provider}/images/generations` | OpenAI рдЫрд╡рд┐рдпрд╛рдБ        | рдореЙрдбрд▓ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐-рдкреНрд░рджрд╛рддрд╛ рд╕рдорд░реНрдкрд┐рдд          |
| `POST /v1/messages/count_tokens`                   | рдХреНрд▓рд╛рдЙрдб рдЯреЛрдХрди рдЧрд┐рдирддреА    | рдПрдкреАрдЖрдИ рдорд╛рд░реНрдЧ                                        |
|                                                    | OpenAI рдореЙрдбрд▓ рд╕реВрдЪреА     | рдПрдкреАрдЖрдИ рдорд╛рд░реНрдЧ (рдЪреИрдЯ + рдПрдореНрдмреЗрдбрд┐рдВрдЧ + рдЫрд╡рд┐ + рдХрд╕реНрдЯрдо рдореЙрдбрд▓)   |
| `GET /api/models/catalog`                          | рдХреИрдЯрд▓реЙрдЧ               | рдкреНрд░рджрд╛рддрд╛ + рдкреНрд░рдХрд╛рд░                                   | рджреНрд╡рд╛рд░рд╛ рд╕рдореВрд╣реАрдХреГрдд рд╕рднреА рдореЙрдбрд▓ |
| `POST /v1beta/models/*:streamGenerateContent`      | рдорд┐рдереБрди рд░рд╛рд╢рд┐ рдХреЗ рдЬрд╛рддрдХ   | рдПрдкреАрдЖрдИ рдорд╛рд░реНрдЧ                                        |
|                                                    | рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд┐рдЧ     | рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди                      |
|                                                    | рдкреНрд░реЙрдХреНрд╕реА рдХрдиреЗрдХреНрдЯрд┐рд╡рд┐рдЯреА | рдкреНрд░реЙрдХреНрд╕реА рд╕реНрд╡рд╛рд╕реНрдереНрдп/рдХрдиреЗрдХреНрдЯрд┐рд╡рд┐рдЯреА рдкрд░реАрдХреНрд╖рдг рд╕рдорд╛рдкрди рдмрд┐рдВрджреБ |
|                                                    | рдХрд╕реНрдЯрдо рдореЙрдбрд▓           | рдкреНрд░рддрд┐ рдкреНрд░рджрд╛рддрд╛ рдХрд╕реНрдЯрдо рдореЙрдбрд▓ рдкреНрд░рдмрдВрдзрди                   |

## рдмрд╛рдпрдкрд╛рд╕ рд╣реИрдВрдбрд▓рд░

рдмрд╛рдИрдкрд╛рд╕ рд╣реИрдВрдбрд▓рд░ (`open-sse/utils/bypassHandler.ts`) рдХреНрд▓рд╛рдЙрдб рд╕реАрдПрд▓рдЖрдИ рд╕реЗ рдЬреНрдЮрд╛рдд "рдереНрд░реЛрдЕрд╡реЗ" рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ - рд╡рд╛рд░реНрдордЕрдк рдкрд┐рдВрдЧ, рд╢реАрд░реНрд╖рдХ рдирд┐рд╖реНрдХрд░реНрд╖рдг, рдФрд░ рдЯреЛрдХрди рдЧрд┐рдирддреА - рдФрд░ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдкреНрд░рджрд╛рддрд╛ рдЯреЛрдХрди рдХрд╛ рдЙрдкрднреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ **рдирдХрд▓реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рд▓реМрдЯрд╛рддрд╛ рд╣реИред рдпрд╣ рддрднреА рдЯреНрд░рд┐рдЧрд░ рд╣реЛрддрд╛ рд╣реИ рдЬрдм `User-Agent` рдореЗрдВ `claude-cli` рд╣реЛрддрд╛ рд╣реИред

## рд▓реЙрдЧрд░ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдВ

рдЕрдиреБрд░реЛрдз рд▓рдХрдбрд╝рд╣рд╛рд░рд╛ (`open-sse/utils/requestLogger.ts`) рдПрдХ 7-рдЪрд░рдг рдбреАрдмрдЧ рд▓реЙрдЧрд┐рдВрдЧ рдкрд╛рдЗрдкрд▓рд╛рдЗрди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдХреНрд╖рдо рд╣реИ, `ENABLE_REQUEST_LOGS=true` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдХреНрд╖рдо рд╣реИ:

рдкреНрд░рддреНрдпреЗрдХ рдЕрдиреБрд░реЛрдз рд╕рддреНрд░ рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓реЗрдВ `<repo>/logs/<session>/` рдкрд░ рд▓рд┐рдЦреА рдЬрд╛рддреА рд╣реИрдВред

## рд╡рд┐рдлрд▓рддрд╛ рдХреЗ рддрд░реАрдХреЗ рдФрд░ рд▓рдЪреАрд▓рд╛рдкрди

## 1) рдЦрд╛рддрд╛/рдкреНрд░рджрд╛рддрд╛ рдЙрдкрд▓рдмреНрдзрддрд╛

- рдХреНрд╖рдгрд┐рдХ/рджрд░/рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдкрд░ рдкреНрд░рджрд╛рддрд╛ рдЦрд╛рддрд╛ рдардВрдбрд╛ рд╣реЛ рдЧрдпрд╛
- рдЕрдиреБрд░реЛрдз рд╡рд┐рдлрд▓ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЦрд╛рддрд╛ рдлрд╝реЙрд▓рдмреИрдХ
- рд╡рд░реНрддрдорд╛рди рдореЙрдбрд▓/рдкреНрд░рджрд╛рддрд╛ рдкрде рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рдХреЙрдореНрдмреЛ рдореЙрдбрд▓ рдлрд╝реЙрд▓рдмреИрдХ

## 2) рдЯреЛрдХрди рд╕рдорд╛рдкреНрддрд┐

- рддрд╛рдЬрд╝рд╛ рдХрд░рдиреЗ рдпреЛрдЧреНрдп рдкреНрд░рджрд╛рддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХреЗ рд╕рд╛рде рдкреВрд░реНрд╡-рдЬрд╛рдВрдЪ рдФрд░ рддрд╛рдЬрд╝рд╛ рдХрд░реЗрдВ
- рдХреЛрд░ рдкрде рдореЗрдВ рддрд╛рдЬрд╝рд╛ рдкреНрд░рдпрд╛рд╕ рдХреЗ рдмрд╛рдж 401/403 рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ

## 3) рд╕реНрдЯреНрд░реАрдо рд╕реБрд░рдХреНрд╖рд╛

- рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ-рдЕрд╡реЗрдпрд░ рд╕реНрдЯреНрд░реАрдо рдирд┐рдпрдВрддреНрд░рдХ
- рдПрдВрдб-рдСрдл-рд╕реНрдЯреНрд░реАрдо рдлреНрд▓рд╢ рдФрд░ `[DONE]` рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдЕрдиреБрд╡рд╛рдж рд╕реНрдЯреНрд░реАрдо
- рдкреНрд░рджрд╛рддрд╛ рдЙрдкрдпреЛрдЧ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЕрдиреБрдкрд▓рдмреНрдз рд╣реЛрдиреЗ рдкрд░ рдЙрдкрдпреЛрдЧ рдЕрдиреБрдорд╛рди рдлрд╝реЙрд▓рдмреИрдХ

## 4) рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ рдЧрд┐рд░рд╛рд╡рдЯ

- рд╕рдордиреНрд╡рдпрди рддреНрд░реБрдЯрд┐рдпрд╛рдБ рд╕рд╛рдордиреЗ рдЖрддреА рд╣реИрдВ рд▓реЗрдХрд┐рди рд╕реНрдерд╛рдиреАрдп рд░рдирдЯрд╛рдЗрдо рдЬрд╛рд░реА рд░рд╣рддрд╛ рд╣реИ
- рд╢реЗрдбреНрдпреВрд▓рд░ рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕-рд╕рдХреНрд╖рдо рддрд░реНрдХ рд╣реИ, рд▓реЗрдХрд┐рди рдЖрд╡рдзрд┐рдХ рдирд┐рд╖реНрдкрд╛рджрди рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдПрдХрд▓-рдкреНрд░рдпрд╛рд╕ рд╕рд┐рдВрдХ рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ

## 5) рдбреЗрдЯрд╛ рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА

- рдЧреБрдо рдЪрд╛рдмрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдбреАрдмреА рдЖрдХрд╛рд░ рдорд╛рдЗрдЧреНрд░реЗрд╢рди/рдорд░рдореНрдордд
- рд▓реЛрдХрд▓рдбреАрдмреА рдФрд░ рдпреВрдЬрд╝рдбреАрдмреА рдХреЗ рд▓рд┐рдП рднреНрд░рд╖реНрдЯ JSON рд░реАрд╕реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдп

## рдЕрд╡рд▓реЛрдХрдирд╢реАрд▓рддрд╛ рдФрд░ рдкрд░рд┐рдЪрд╛рд▓рди рд╕рдВрдХреЗрдд

рд░рдирдЯрд╛рдЗрдо рджреГрд╢реНрдпрддрд╛ рд╕реНрд░реЛрдд:

- `src/sse/utils/logger.ts` рд╕реЗ рдХрдВрд╕реЛрд▓ рд▓реЙрдЧ
- `usage.json` рдореЗрдВ рдкреНрд░рддрд┐-рдЕрдиреБрд░реЛрдз рдЙрдкрдпреЛрдЧ рд╕рдореБрдЪреНрдЪрдп
- рдкрд╛рдареНрдп рдЕрдиреБрд░реЛрдз рд╕реНрдерд┐рддрд┐ рд▓реЙрдЧ рдЗрди `log.txt`
- `logs/` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╡реИрдХрд▓реНрдкрд┐рдХ рдЧрд╣рди рдЕрдиреБрд░реЛрдз/рдЕрдиреБрд╡рд╛рдж рд▓реЙрдЧ рдЬрдм `ENABLE_REQUEST_LOGS=true`
- рдпреВрдЖрдИ рдЦрдкрдд рдХреЗ рд▓рд┐рдП рдбреИрд╢рдмреЛрд░реНрдб рдЙрдкрдпреЛрдЧ рд╕рдорд╛рдкрди рдмрд┐рдВрджреБ (`/api/usage/*`)ред

## рд╕реБрд░рдХреНрд╖рд╛-рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕реАрдорд╛рдПрдБ

- JWT рд╕реАрдХреНрд░реЗрдЯ (`JWT_SECRET`) рдбреИрд╢рдмреЛрд░реНрдб рд╕рддреНрд░ рдХреБрдХреА рд╕рддреНрдпрд╛рдкрди/рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ
- рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб рдлрд╝реЙрд▓рдмреИрдХ (`INITIAL_PASSWORD`, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `123456`) рдХреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдореЗрдВ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
- рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдПрдЪрдПрдордПрд╕реА рд░рд╣рд╕реНрдп (`API_KEY_SECRET`) рдЙрддреНрдкрдиреНрди рд╕реНрдерд╛рдиреАрдп рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдкреНрд░рд╛рд░реВрдк рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ
- рдкреНрд░рджрд╛рддрд╛ рд░рд╣рд╕реНрдп (рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА/рдЯреЛрдХрди) рд╕реНрдерд╛рдиреАрдп рдбреАрдмреА рдореЗрдВ рдмрдиреЗ рд░рд╣рддреЗ рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рд╕реНрддрд░ рдкрд░ рд╕рдВрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
- рдХреНрд▓рд╛рдЙрдб рд╕рд┐рдВрдХ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдПрдкреАрдЖрдИ рдХреБрдВрдЬреА рдСрде + рдорд╢реАрди рдЖрдИрдбреА рд╕реЗрдореЗрдиреНрдЯрд┐рдХреНрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВ

## рдкрд░реНрдпрд╛рд╡рд░рдг рдФрд░ рд░рдирдЯрд╛рдЗрдо рдореИрдЯреНрд░рд┐рдХреНрд╕

рдХреЛрдб рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░:

- рдРрдк/рдСрде: `JWT_SECRET`, `INITIAL_PASSWORD`
- рднрдВрдбрд╛рд░рдг: `DATA_DIR`
- рд╕рдВрдЧрдд рдиреЛрдб рд╡реНрдпрд╡рд╣рд╛рд░: `ALLOW_MULTI_CONNECTIONS_PER_COMPAT_NODE`
- рд╡реИрдХрд▓реНрдкрд┐рдХ рд╕реНрдЯреЛрд░реЗрдЬ рдмреЗрд╕ рдУрд╡рд░рд░рд╛рдЗрдб (рд▓рд┐рдирдХреНрд╕/рдореИрдХрдУрдПрд╕ рдЬрдм `DATA_DIR` рд╕реЗрдЯ рди рд╣реЛ): `XDG_CONFIG_HOME`
- рд╕реБрд░рдХреНрд╖рд╛ рд╣реИрд╢рд┐рдВрдЧ: `API_KEY_SECRET`, `MACHINE_ID_SALT`
- рд▓реЙрдЧрд┐рдВрдЧ: `ENABLE_REQUEST_LOGS`
- рд╕рд┐рдВрдХ/рдХреНрд▓рд╛рдЙрдб рдпреВрдЖрд░рдПрд▓: `NEXT_PUBLIC_BASE_URL`, `NEXT_PUBLIC_CLOUD_URL`
- рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдкреНрд░реЙрдХреНрд╕реА: `HTTP_PROXY`, `HTTPS_PROXY`, `ALL_PROXY`, `NO_PROXY` рдФрд░ рд▓реЛрдЕрд░рдХреЗрд╕ рд╡реЗрд░рд┐рдПрдВрдЯ
- SOCKS5 рдлрд╝реАрдЪрд░ рдлрд╝реНрд▓реИрдЧ: `ENABLE_SOCKS5_PROXY`, `NEXT_PUBLIC_ENABLE_SOCKS5_PROXY`
- рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо/рд░рдирдЯрд╛рдЗрдо рд╕рд╣рд╛рдпрдХ (рдРрдк-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдирд╣реАрдВ): `APPDATA`, `NODE_ENV`, `PORT`, `HOSTNAME`

## рдЬреНрдЮрд╛рдд рд╡рд╛рд╕реНрддреБрд╢рд┐рд▓реНрдк рдиреЛрдЯреНрд╕

1. `usageDb` рдФрд░ `localDb` рдЕрдм рд▓реАрдЧреЗрд╕реА рдлрд╝рд╛рдЗрд▓ рдорд╛рдЗрдЧреНрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рдЖрдзрд╛рд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдиреАрддрд┐ (`DATA_DIR` -> `XDG_CONFIG_HOME/omniroute` -> `~/.omniroute`) рд╕рд╛рдЭрд╛ рдХрд░рддреЗ рд╣реИрдВред
2. `/api/v1/route.ts` рдПрдХ рд╕реНрдерд┐рд░ рдореЙрдбрд▓ рд╕реВрдЪреА рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдФрд░ рдпрд╣ `/v1/models` рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдореБрдЦреНрдп рдореЙрдбрд▓ рд╕реНрд░реЛрдд рдирд╣реАрдВ рд╣реИред
3. рдЕрдиреБрд░реЛрдз рд▓рдХрдбрд╝рд╣рд╛рд░рд╛ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдкрд░ рдкреВрд░реНрдг рд╣реЗрдбрд░/рдмреЙрдбреА рд▓рд┐рдЦрддрд╛ рд╣реИ; рд▓реЙрдЧ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдорд╛рдиреЗрдВред
4. рдХреНрд▓рд╛рдЙрдб рд╡реНрдпрд╡рд╣рд╛рд░ рд╕рд╣реА `NEXT_PUBLIC_BASE_URL` рдФрд░ рдХреНрд▓рд╛рдЙрдб рдПрдВрдбрдкреЙрдЗрдВрдЯ рд░реАрдЪреИрдмрд┐рд▓рд┐рдЯреА рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред
5. `open-sse/` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ `@omniroute/open-sse` **npm рдХрд╛рд░реНрдпрдХреНрд╖реЗрддреНрд░ рдкреИрдХреЗрдЬ** рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рд╕реНрд░реЛрдд рдХреЛрдб рдЗрд╕реЗ `@omniroute/open-sse/...` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрдпрд╛рдд рдХрд░рддрд╛ рд╣реИ (Next.js `transpilePackages` рджреНрд╡рд╛рд░рд╛ рд╣рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛)ред рдЗрд╕ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рдкрде рдЕрднреА рднреА рд╕реНрдерд┐рд░рддрд╛ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдирд╛рдо `open-sse/` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред
6. рдбреИрд╢рдмреЛрд░реНрдб рдореЗрдВ рдЪрд╛рд░реНрдЯ рд╕реБрд▓рдн, рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕ рд╡рд┐рдЬрд╝реБрдЕрд▓рд╛рдЗрдЬрд╝реЗрд╢рди (рдореЙрдбрд▓ рдЙрдкрдпреЛрдЧ рдмрд╛рд░ рдЪрд╛рд░реНрдЯ, рд╕рдлрд▓рддрд╛ рджрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд╛рддрд╛ рдмреНрд░реЗрдХрдбрд╛рдЙрди рдЯреЗрдмрд▓) рдХреЗ рд▓рд┐рдП **рд░рд┐рдЪрд╛рд░реНрдЯреНрд╕** (рдПрд╕рд╡реАрдЬреА-рдЖрдзрд╛рд░рд┐рдд) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред
7. E2E рдкрд░реАрдХреНрд╖рдг **Playwright** (`tests/e2e/`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, `npm run test:e2e` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЪрд▓рддреЗ рд╣реИрдВред рдпреВрдирд┐рдЯ рдкрд░реАрдХреНрд╖рдг **Node.js рдЯреЗрд╕реНрдЯ рд░рдирд░** (`tests/unit/`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ `npm run test:plan3` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЪрд▓рддреЗ рд╣реИрдВред `src/` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╕реНрд░реЛрдд рдХреЛрдб **рдЯрд╛рдЗрдкрд╕реНрдХреНрд░рд┐рдкреНрдЯ** (`.ts`/`.tsx`) рд╣реИ; `open-sse/` рдХрд╛рд░реНрдпрд╕реНрдерд╛рди рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ (`.js`) рдмрдирд╛ рд╣реБрдЖ рд╣реИред
8. рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдкреГрд╖реНрда рдХреЛ 5 рдЯреИрдм рдореЗрдВ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: рд╕реБрд░рдХреНрд╖рд╛, рд░реВрдЯрд┐рдВрдЧ (6 рд╡реИрд╢реНрд╡рд┐рдХ рд░рдгрдиреАрддрд┐рдпрд╛рдБ: рднрд░рдг-рдкреНрд░рдердо, рд░рд╛рдЙрдВрдб-рд░реЙрдмрд┐рди, рдкреА2рд╕реА, рдпрд╛рджреГрдЪреНрдЫрд┐рдХ, рдХрдо рд╕реЗ рдХрдо рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛, рд▓рд╛рдЧрдд-рдЕрдиреБрдХреВрд▓рд┐рдд), рд▓рдЪреАрд▓рд╛рдкрди (рд╕рдВрдкрд╛рджрди рдпреЛрдЧреНрдп рджрд░ рд╕реАрдорд╛, рд╕рд░реНрдХрд┐рдЯ рдмреНрд░реЗрдХрд░, рдиреАрддрд┐рдпрд╛рдВ), рдПрдЖрдИ (рд╕реЛрдЪ рдмрдЬрдЯ, рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЙрдореНрдкреНрдЯ, рдкреНрд░реЙрдореНрдкреНрдЯ рдХреИрд╢), рдЙрдиреНрдирдд (рдкреНрд░реЙрдХреНрд╕реА)ред

## рдкрд░рд┐рдЪрд╛рд▓рди рд╕рддреНрдпрд╛рдкрди рдЪреЗрдХрд▓рд┐рд╕реНрдЯ

- рд╕реНрд░реЛрдд рд╕реЗ рдирд┐рд░реНрдорд┐рдд: `npm run build`
- рдбреЙрдХрд░ рдЫрд╡рд┐ рдмрдирд╛рдПрдВ: `docker build -t omniroute .`
- рд╕реЗрд╡рд╛ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ рдФрд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ:
- `GET /api/settings`
- `GET /api/v1/models`
- рдЬрдм `PORT=20128` рд╣реЛ рддреЛ CLI рд▓рдХреНрд╖реНрдп рдЖрдзрд╛рд░ URL `http://<host>:20128/v1` рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
