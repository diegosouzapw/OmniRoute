ğŸŒ **Languages:** ğŸ‡ºğŸ‡¸ [English](../../CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡· [PortuguÃªs (Brasil)](../pt-BR/CODEBASE_DOCUMENTATION.md) | ğŸ‡ªğŸ‡¸ [EspaÃ±ol](../es/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡· [FranÃ§ais](../fr/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡¹ [Italiano](../it/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡º [Ğ ÑƒÑÑĞºĞ¸Ğ¹](../ru/CODEBASE_DOCUMENTATION.md) | ğŸ‡¨ğŸ‡³ [ä¸­æ–‡ (ç®€ä½“)](../zh-CN/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡ª [Deutsch](../de/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡³ [à¤¹à¤¿à¤¨à¥à¤¦à¥€](../in/CODEBASE_DOCUMENTATION.md) | ğŸ‡¹ğŸ‡­ [à¹„à¸—à¸¢](../th/CODEBASE_DOCUMENTATION.md) | ğŸ‡ºğŸ‡¦ [Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°](../uk-UA/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡¦ [Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©](../ar/CODEBASE_DOCUMENTATION.md) | ğŸ‡¯ğŸ‡µ [æ—¥æœ¬èª](../ja/CODEBASE_DOCUMENTATION.md) | ğŸ‡»ğŸ‡³ [Tiáº¿ng Viá»‡t](../vi/CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡¬ [Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸](../bg/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡° [Dansk](../da/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡® [Suomi](../fi/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡± [×¢×‘×¨×™×ª](../he/CODEBASE_DOCUMENTATION.md) | ğŸ‡­ğŸ‡º [Magyar](../hu/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡© [Bahasa Indonesia](../id/CODEBASE_DOCUMENTATION.md) | ğŸ‡°ğŸ‡· [í•œêµ­ì–´](../ko/CODEBASE_DOCUMENTATION.md) | ğŸ‡²ğŸ‡¾ [Bahasa Melayu](../ms/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡± [Nederlands](../nl/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡´ [Norsk](../no/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡¹ [PortuguÃªs (Portugal)](../pt/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡´ [RomÃ¢nÄƒ](../ro/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡± [Polski](../pl/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡° [SlovenÄina](../sk/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡ª [Svenska](../sv/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡­ [Filipino](../phi/CODEBASE_DOCUMENTATION.md)

#omniroute â€” ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

> **omniroute** ãƒãƒ«ãƒãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ AI ãƒ—ãƒ­ã‚­ã‚· ãƒ«ãƒ¼ã‚¿ãƒ¼ã«é–¢ã™ã‚‹åˆå¿ƒè€…å‘ã‘ã®åŒ…æ‹¬çš„ãªã‚¬ã‚¤ãƒ‰ã€‚

---

## 1. ã‚ªãƒ ãƒ‹ãƒ«ãƒ¼ãƒˆã¨ã¯ä½•ã§ã™ã‹?

ã‚ªãƒ ãƒ‹ãƒ«ãƒ¼ãƒˆã¯ã€AI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (Claude CLIã€Codexã€Cursor IDE ãªã©) ã¨ AI ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (Anthropicã€Googleã€OpenAIã€AWSã€GitHub ãªã©) ã®é–“ã«ä½ç½®ã™ã‚‹ **ãƒ—ãƒ­ã‚­ã‚· ãƒ«ãƒ¼ã‚¿ãƒ¼** ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€1 ã¤ã®å¤§ããªå•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã™ã€‚

> **ç•°ãªã‚‹ AI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ç•°ãªã‚‹ã€Œè¨€èªã€(API å½¢å¼) ã‚’è©±ã—ã€ç•°ãªã‚‹ AI ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚‚ç•°ãªã‚‹ã€Œè¨€èªã€ã‚’æœŸå¾…ã—ã¾ã™ã€‚** ã‚ªãƒ ãƒ‹ãƒ«ãƒ¼ãƒˆã¯ãã‚Œã‚‰ã®é–“ã§è‡ªå‹•çš„ã«ç¿»è¨³ã—ã¾ã™ã€‚

ã“ã‚Œã‚’å›½é€£ã®ä¸‡èƒ½ç¿»è¨³è€…ã®ã‚ˆã†ãªã‚‚ã®ã ã¨è€ƒãˆã¦ãã ã•ã„ã€‚ã©ã®ä»£è¡¨è€…ã‚‚ã‚ã‚‰ã‚†ã‚‹è¨€èªã‚’è©±ã™ã“ã¨ãŒã§ãã€ç¿»è¨³è€…ã¯ä»–ã®ä»£è¡¨è€…ã®ãŸã‚ã«ãã‚Œã‚’å¤‰æ›ã—ã¾ã™ã€‚

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ¦‚è¦

```mermaid
graph LR
    subgraph Clients
        A[Claude CLI]
        B[Codex]
        C[Cursor IDE]
        D[OpenAI-compatible]
    end

    subgraph omniroute
        E[Handler Layer]
        F[Translator Layer]
        G[Executor Layer]
        H[Services Layer]
    end

    subgraph Providers
        I[Anthropic Claude]
        J[Google Gemini]
        K[OpenAI / Codex]
        L[GitHub Copilot]
        M[AWS Kiro]
        N[Antigravity]
        O[Cursor API]
    end

    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> I
    G --> J
    G --> K
    G --> L
    G --> M
    G --> N
    G --> O
    H -.-> E
    H -.-> G
```

### åŸºæœ¬åŸå‰‡: ãƒãƒ–ã‚¢ãƒ³ãƒ‰ã‚¹ãƒãƒ¼ã‚¯å¤‰æ›

ã™ã¹ã¦ã®å½¢å¼å¤‰æ›ã¯ã€**OpenAI å½¢å¼ã‚’ãƒãƒ–ã¨ã—ã¦** é€šéã—ã¾ã™ã€‚

```
Client Format â†’ [OpenAI Hub] â†’ Provider Format    (request)
Provider Format â†’ [OpenAI Hub] â†’ Client Format    (response)
```

ã“ã‚Œã¯ã€**NÂ²** (ãƒšã‚¢ã”ã¨) ã§ã¯ãªãã€**N ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼** (ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã”ã¨ã« 1 äºº) ã ã‘ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

---

## 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ 

```
omniroute/
â”œâ”€â”€ open-sse/                  â† Core proxy library (portable, framework-agnostic)
â”‚   â”œâ”€â”€ index.js               â† Main entry point, exports everything
â”‚   â”œâ”€â”€ config/                â† Configuration & constants
â”‚   â”œâ”€â”€ executors/             â† Provider-specific request execution
â”‚   â”œâ”€â”€ handlers/              â† Request handling orchestration
â”‚   â”œâ”€â”€ services/              â† Business logic (auth, models, fallback, usage)
â”‚   â”œâ”€â”€ translator/            â† Format translation engine
â”‚   â”‚   â”œâ”€â”€ request/           â† Request translators (8 files)
â”‚   â”‚   â”œâ”€â”€ response/          â† Response translators (7 files)
â”‚   â”‚   â””â”€â”€ helpers/           â† Shared translation utilities (6 files)
â”‚   â””â”€â”€ utils/                 â† Utility functions
â”œâ”€â”€ src/                       â† Application layer (Express/Worker runtime)
â”‚   â”œâ”€â”€ app/                   â† Web UI, API routes, middleware
â”‚   â”œâ”€â”€ lib/                   â† Database, auth, and shared library code
â”‚   â”œâ”€â”€ mitm/                  â† Man-in-the-middle proxy utilities
â”‚   â”œâ”€â”€ models/                â† Database models
â”‚   â”œâ”€â”€ shared/                â† Shared utilities (wrappers around open-sse)
â”‚   â”œâ”€â”€ sse/                   â† SSE endpoint handlers
â”‚   â””â”€â”€ store/                 â† State management
â”œâ”€â”€ data/                      â† Runtime data (credentials, logs)
â”‚   â””â”€â”€ provider-credentials.json   (external credentials override, gitignored)
â””â”€â”€ tester/                    â† Test utilities
```

---

## 4. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã”ã¨ã®å†…è¨³

### 4.1 æ§‹æˆ (`open-sse/config/`)

ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æ§‹æˆã«é–¢ã™ã‚‹ **å”¯ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æº**ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ«                      | ç›®çš„                                                                                                                                                                                                                                                        |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `constants.ts`                | `PROVIDERS` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ãƒ™ãƒ¼ã‚¹ URLã€OAuth è³‡æ ¼æƒ…å ± (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãŠã‚ˆã³å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå«â€‹â€‹ã¾ã‚Œã¾ã™ã€‚ `HTTP_STATUS`ã€`ERROR_TYPES`ã€`COOLDOWN_MS`ã€`BACKOFF_CONFIG`ã€ãŠã‚ˆã³ `SKIP_PATTERNS` ã‚‚å®šç¾©ã—ã¾ã™ã€‚ |
| `credentialLoader.ts`         | `data/provider-credentials.json` ã‹ã‚‰å¤–éƒ¨è³‡æ ¼æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€`PROVIDERS` ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãã‚Œã‚‰ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚ä¸‹ä½äº’æ›æ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ã€ç§˜å¯†ã‚’ã‚½ãƒ¼ã‚¹ç®¡ç†ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚                                                                   |
| `providerModels.ts`           | ä¸­å¤®ãƒ¢ãƒ‡ãƒ« ãƒ¬ã‚¸ã‚¹ãƒˆãƒª: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ â†’ ãƒ¢ãƒ‡ãƒ« ID ã‚’ãƒãƒƒãƒ—ã—ã¾ã™ã€‚ `getModels()`ã€`getProviderByAlias()` ã®ã‚ˆã†ãªé–¢æ•°ã€‚                                                                                                                           |
| `codexInstructions.ts`        | Codex ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æŒ¿å…¥ã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ å‘½ä»¤ (ç·¨é›†åˆ¶ç´„ã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ ãƒ«ãƒ¼ãƒ«ã€æ‰¿èªãƒãƒªã‚·ãƒ¼)ã€‚                                                                                                                                                                  |
| `defaultThinkingSignature.ts` | Claude ãƒ¢ãƒ‡ãƒ«ã¨ Gemini ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã€Œæ€è€ƒã€ã‚·ã‚°ãƒãƒãƒ£ã€‚                                                                                                                                                                                             |
| `ollamaModels.ts`             | ãƒ­ãƒ¼ã‚«ãƒ« Ollama ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾© (åå‰ã€ã‚µã‚¤ã‚ºã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã€é‡å­åŒ–)ã€‚                                                                                                                                                                                   |

#### èªè¨¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A["App starts"] --> B["constants.ts defines PROVIDERS\nwith hardcoded defaults"]
    B --> C{"data/provider-credentials.json\nexists?"}
    C -->|Yes| D["credentialLoader reads JSON"]
    C -->|No| E["Use hardcoded defaults"]
    D --> F{"For each provider in JSON"}
    F --> G{"Provider exists\nin PROVIDERS?"}
    G -->|No| H["Log warning, skip"]
    G -->|Yes| I{"Value is object?"}
    I -->|No| J["Log warning, skip"]
    I -->|Yes| K["Merge clientId, clientSecret,\ntokenUrl, authUrl, refreshUrl"]
    K --> F
    H --> F
    J --> F
    F -->|Done| L["PROVIDERS ready with\nmerged credentials"]
    E --> L
```

---

### 4.2 å®Ÿè¡Œè€… (`open-sse/executors/`)

ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã¯ã€**æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’ä½¿ç”¨ã—ã¦**ãƒ—ãƒ­ãƒã‚¤ãƒ€å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯**ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã¾ã™ã€‚å„ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã¯ã€å¿…è¦ã«å¿œã˜ã¦åŸºæœ¬ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

```mermaid
classDiagram
    class BaseExecutor {
        +buildUrl(model, stream, options)
        +buildHeaders(credentials, stream, body)
        +transformRequest(body, model, stream, credentials)
        +execute(url, options)
        +shouldRetry(status, error)
        +refreshCredentials(credentials, log)
    }

    class DefaultExecutor {
        +refreshCredentials()
    }

    class AntigravityExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +shouldRetry()
        +refreshCredentials()
    }

    class CursorExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseResponse()
        +generateChecksum()
    }

    class KiroExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseEventStream()
        +refreshCredentials()
    }

    BaseExecutor <|-- DefaultExecutor
    BaseExecutor <|-- AntigravityExecutor
    BaseExecutor <|-- CursorExecutor
    BaseExecutor <|-- KiroExecutor
    BaseExecutor <|-- CodexExecutor
    BaseExecutor <|-- GeminiCLIExecutor
    BaseExecutor <|-- GithubExecutor
```

| åŸ·è¡Œè€…           | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼                                   | ä¸»ãªå°‚é–€åˆ†é‡                                                                                                                                |
| ---------------- | ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `base.ts`        | â€”                                              | æŠ½è±¡ãƒ™ãƒ¼ã‚¹: URL æ§‹ç¯‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã€å†è©¦è¡Œãƒ­ã‚¸ãƒƒã‚¯ã€è³‡æ ¼æƒ…å ±ã®æ›´æ–°                                                                              |
| `default.ts`     | ã‚¯ãƒ­ãƒ¼ãƒ‰ã€ã‚¸ã‚§ãƒŸãƒ‹ã€OpenAIã€GLMã€ã‚­ãƒŸã€MiniMax | æ¨™æº–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®æ±ç”¨ OAuth ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°                                                                                                 |
| `antigravity.ts` | Googleã‚¯ãƒ©ã‚¦ãƒ‰ã‚³ãƒ¼ãƒ‰                           | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID ã®ç”Ÿæˆã€ãƒãƒ«ãƒ URL ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®ã‚«ã‚¹ã‚¿ãƒ å†è©¦è¡Œè§£æ (ã€Œ2 æ™‚é–“ 7 åˆ† 23 ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆã€) |
| `cursor.ts`      | ã‚«ãƒ¼ã‚½ãƒ«IDE                                    | **æœ€ã‚‚è¤‡é›‘**: SHA-256 ãƒã‚§ãƒƒã‚¯ã‚µãƒ èªè¨¼ã€Protobuf ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€ãƒã‚¤ãƒŠãƒª EventStream â†’ SSE ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ                           |
| `codex.ts`       | OpenAI ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚¹                            | ã‚·ã‚¹ãƒ†ãƒ å‘½ä»¤ã®æŒ¿å…¥ã€æ€è€ƒãƒ¬ãƒ™ãƒ«ã®ç®¡ç†ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‰Šé™¤                                                                  |
| `gemini-cli.ts`  | Google Gemini CLI                              | ã‚«ã‚¹ã‚¿ãƒ  URL ã®æ§‹ç¯‰ (`streamGenerateContent`)ã€Google OAuth ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°                                                                  |
| `github.ts`      | GitHub ã‚³ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ                            | ãƒ‡ãƒ¥ã‚¢ãƒ« ãƒˆãƒ¼ã‚¯ãƒ³ ã‚·ã‚¹ãƒ†ãƒ  (GitHub OAuth + Copilot ãƒˆãƒ¼ã‚¯ãƒ³)ã€VSCode ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¨¡å€£                                                         |
| `kiro.ts`        | AWS CodeWhisperer                              | AWS EventStream ãƒã‚¤ãƒŠãƒªè§£æã€AMZN ã‚¤ãƒ™ãƒ³ãƒˆ ãƒ•ãƒ¬ãƒ¼ãƒ ã€ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®š                                                                          |
| `index.ts`       | â€”                                              | ãƒ•ã‚¡ã‚¯ãƒˆãƒª: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å â†’ ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼ ã‚¯ãƒ©ã‚¹ã‚’ãƒãƒƒãƒ—ã—ã¾ã™ã€‚                                  |

---

### 4.3 ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (`open-sse/handlers/`)

**ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¬ã‚¤ãƒ¤ãƒ¼** â€” å¤‰æ›ã€å®Ÿè¡Œã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’èª¿æ•´ã—ã¾ã™ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ«              | ç›®çš„                                                                                                                                                                                                            |
| --------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `chatCore.ts`         | **ä¸­å¤®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼** (ç´„ 600 è¡Œ)ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ã‚’å‡¦ç†ã—ã¾ã™: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œå‡ºâ†’å¤‰æ›â†’ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒâ†’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°/éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”â†’ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°â†’ã‚¨ãƒ©ãƒ¼å‡¦ç†â†’ä½¿ç”¨çŠ¶æ³ãƒ­ã‚°ã€‚ |
| `responsesHandler.ts` | OpenAI ã®å¿œç­” API ç”¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼: å¿œç­”å½¢å¼ã‚’å¤‰æ› â†’ ãƒãƒ£ãƒƒãƒˆå®Œäº† â†’ `chatCore` ã«é€ä¿¡ â†’ SSE ã‚’å¿œç­”å½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚                                                                                                |
| `embeddings.ts`       | åŸ‹ã‚è¾¼ã¿ç”Ÿæˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼: åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«â†’ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è§£æ±ºã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ API ã«ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã—ã€OpenAI äº’æ›ã®åŸ‹ã‚è¾¼ã¿å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚ 6 ã¤ä»¥ä¸Šã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚                                  |
| `imageGeneration.ts`  | ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼: ã‚¤ãƒ¡ãƒ¼ã‚¸ ãƒ¢ãƒ‡ãƒ« â†’ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è§£æ±ºã—ã€OpenAI äº’æ›ã€Gemini ã‚¤ãƒ¡ãƒ¼ã‚¸ (Antigravity)ã€ãŠã‚ˆã³ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (Nebius) ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ Base64 ã¾ãŸã¯ URL ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ã€‚       |

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« (chatCore.ts)

```mermaid
sequenceDiagram
    participant Client
    participant chatCore
    participant Translator
    participant Executor
    participant Provider

    Client->>chatCore: Request (any format)
    chatCore->>chatCore: Detect source format
    chatCore->>chatCore: Check bypass patterns
    chatCore->>chatCore: Resolve model & provider
    chatCore->>Translator: Translate request (source â†’ OpenAI â†’ target)
    chatCore->>Executor: Get executor for provider
    Executor->>Executor: Build URL, headers, transform request
    Executor->>Executor: Refresh credentials if needed
    Executor->>Provider: HTTP fetch (streaming or non-streaming)

    alt Streaming
        Provider-->>chatCore: SSE stream
        chatCore->>chatCore: Pipe through SSE transform stream
        Note over chatCore: Transform stream translates<br/>each chunk: target â†’ OpenAI â†’ source
        chatCore-->>Client: Translated SSE stream
    else Non-streaming
        Provider-->>chatCore: JSON response
        chatCore->>Translator: Translate response
        chatCore-->>Client: Translated JSON
    end

    alt Error (401, 429, 500...)
        chatCore->>Executor: Retry with credential refresh
        chatCore->>chatCore: Account fallback logic
    end
```

---

### 4.4 ã‚µãƒ¼ãƒ“ã‚¹ (`open-sse/services/`)

ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ«             | ç›®çš„                                                                                                                                                                                                                                                                                                                                  |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `provider.ts`        | **å½¢å¼æ¤œå‡º** (`detectFormat`): ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ¬æ–‡ã®æ§‹é€ ã‚’åˆ†æã—ã¦ã€Claude/OpenAI/Gemini/Antigravity/Responses å½¢å¼ã‚’è­˜åˆ¥ã—ã¾ã™ (Claude ã® `max_tokens` ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’å«ã‚€)ã€‚ã¾ãŸã€URL ã®æ§‹ç¯‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ§‹ç¯‰ã€æ€è€ƒæ§‹æˆã®æ­£è¦åŒ–ã‚‚è¡Œã„ã¾ã™ã€‚ `openai-compatible-*` ãŠã‚ˆã³ `anthropic-compatible-*` å‹•çš„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ |
| `model.ts`           | ãƒ¢ãƒ‡ãƒ«æ–‡å­—åˆ—è§£æ (`claude/model-name` â†’ `{provider: "claude", model: "model-name"}`)ã€è¡çªæ¤œå‡ºã«ã‚ˆã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è§£æ±ºã€å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º (ãƒ‘ã‚¹ ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«/åˆ¶å¾¡æ–‡å­—ã®æ‹’å¦)ã€ãŠã‚ˆã³éåŒæœŸã‚¨ã‚¤ãƒªã‚¢ã‚¹ ã‚²ãƒƒã‚¿ãƒ¼ ã‚µãƒãƒ¼ãƒˆã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«æƒ…å ±è§£æ±ºã€‚                                                                                                 |
| `accountFallback.ts` | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‡¦ç†: æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ• (1 ç§’ â†’ 2 ç§’ â†’ 4 ç§’ â†’ æœ€å¤§ 2 åˆ†)ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†ã€ã‚¨ãƒ©ãƒ¼åˆ†é¡ (ã©ã®ã‚¨ãƒ©ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã®ã‹ã€ãƒˆãƒªã‚¬ãƒ¼ã—ãªã„ã®ã‹)ã€‚                                                                                                                                                |
| `tokenRefresh.ts`    | **ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€**ã® OAuth ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°: Google (Geminiã€Antigravity)ã€Claudeã€Codexã€Qwenã€iFlowã€GitHub (OAuth + Copilot ãƒ‡ãƒ¥ã‚¢ãƒ« ãƒˆãƒ¼ã‚¯ãƒ³)ã€Kiro (AWS SSO OIDC + Social Auth)ã€‚å®Ÿè¡Œä¸­ã® Promise é‡è¤‡æ’é™¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹å†è©¦è¡ŒãŒå«ã¾ã‚Œã¾ã™ã€‚                                                                   |
| `combo.ts`           | **ã‚³ãƒ³ãƒœ ãƒ¢ãƒ‡ãƒ«**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ãƒ¢ãƒ‡ãƒ«ã®ãƒã‚§ãƒ¼ãƒ³ã€‚ãƒ¢ãƒ‡ãƒ« A ãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ¢ãƒ‡ãƒ« Bã€æ¬¡ã«ãƒ¢ãƒ‡ãƒ« C ãªã©ã‚’è©¦ã—ã¾ã™ã€‚å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã¾ã™ã€‚                                                                                                                                  |
| `usage.ts`           | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ API ã‹ã‚‰ã‚¯ã‚©ãƒ¼ã‚¿/ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ (GitHub Copilot ã‚¯ã‚©ãƒ¼ã‚¿ã€åé‡åŠ›ãƒ¢ãƒ‡ãƒ« ã‚¯ã‚©ãƒ¼ã‚¿ã€Codex ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€Kiro ä½¿ç”¨é‡ã®å†…è¨³ã€Claude è¨­å®š)ã€‚                                                                                                                                                                           |
| `accountSelector.ts` | ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ãŸã‚¹ãƒãƒ¼ãƒˆãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠ: å„ªå…ˆåº¦ã€å¥å…¨æ€§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ ãƒã‚¸ã‚·ãƒ§ãƒ³ã€ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³çŠ¶æ…‹ã‚’è€ƒæ…®ã—ã¦ã€å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æœ€é©ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¾ã™ã€‚                                                                                                                                            |
| `contextManager.ts`  | ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†: ãƒ‡ãƒãƒƒã‚°ã¨ãƒ­ã‚®ãƒ³ã‚°ã®ãŸã‚ã«ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ (ãƒªã‚¯ã‚¨ã‚¹ãƒˆ IDã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æƒ…å ±) ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆãŠã‚ˆã³è¿½è·¡ã—ã¾ã™ã€‚                                                                                                                         |
| `ipFilter.ts`        | IP ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡: ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹å‰ã«ã€è¨­å®šã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã«ç…§ã‚‰ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ IP ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚                                                                                                                                                        |
| `sessionManager.ts`  | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½è·¡: ãƒãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿½è·¡ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’ç›£è¦–ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚                                                                                                                                                |
| `signatureCache.ts`  | ãƒªã‚¯ã‚¨ã‚¹ãƒˆç½²åãƒ™ãƒ¼ã‚¹ã®é‡è¤‡æ’é™¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥: æœ€è¿‘ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç½²åã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã€æ™‚é–“æ å†…ã®åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå¿œç­”ã‚’è¿”ã™ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ã‚’é˜²ãã¾ã™ã€‚                                                                                                                                                          |
| `systemPrompt.ts`    | ã‚°ãƒ­ãƒ¼ãƒãƒ« ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®äº’æ›æ€§å‡¦ç†ã‚’ä½¿ç”¨ã—ã¦ã€æ§‹æˆå¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…ˆé ­ã¾ãŸã¯æœ«å°¾ã«è¿½åŠ ã—ã¾ã™ã€‚                                                                                                                                                              |
| `thinkingBudget.ts`  | æ¨è«–ãƒˆãƒ¼ã‚¯ãƒ³ã®äºˆç®—ç®¡ç†: æ€è€ƒ/æ¨è«–ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼ã€è‡ªå‹• (ã‚¹ãƒˆãƒªãƒƒãƒ—æ€è€ƒæ§‹æˆ)ã€ã‚«ã‚¹ã‚¿ãƒ  (å›ºå®šäºˆç®—)ã€ãŠã‚ˆã³é©å¿œå‹ (è¤‡é›‘ã•ã‚¹ã‚±ãƒ¼ãƒ«) ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚                                                                                                                                                           |
| `wildcardRouter.ts`  | ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ ãƒ¢ãƒ‡ãƒ« ãƒ‘ã‚¿ãƒ¼ãƒ³ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: å¯ç”¨æ€§ã¨å„ªå…ˆåº¦ã«åŸºã¥ã„ã¦ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ ãƒ‘ã‚¿ãƒ¼ãƒ³ (`*/claude-*` ãªã©) ã‚’å…·ä½“çš„ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼/ãƒ¢ãƒ‡ãƒ«ã®ãƒšã‚¢ã«è§£æ±ºã—ã¾ã™ã€‚                                                                                                                                                                  |

#### ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®é‡è¤‡æ’é™¤

```mermaid
sequenceDiagram
    participant R1 as Request 1
    participant R2 as Request 2
    participant Cache as refreshPromiseCache
    participant OAuth as OAuth Provider

    R1->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: No in-flight promise
    Cache->>OAuth: Start refresh
    R2->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: Found in-flight promise
    Cache-->>R2: Return existing promise
    OAuth-->>Cache: New access token
    Cache-->>R1: New access token
    Cache-->>R2: Same access token (shared)
    Cache->>Cache: Delete cache entry
```

#### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚¹ãƒ†ãƒ¼ãƒˆ ãƒã‚·ãƒ³

```mermaid
stateDiagram-v2
    [*] --> Active
    Active --> Error: Request fails (401/429/500)
    Error --> Cooldown: Apply backoff
    Cooldown --> Active: Cooldown expires
    Active --> Active: Request succeeds (reset backoff)

    state Error {
        [*] --> ClassifyError
        ClassifyError --> ShouldFallback: Rate limit / Auth / Transient
        ClassifyError --> NoFallback: 400 Bad Request
    }

    state Cooldown {
        [*] --> ExponentialBackoff
        ExponentialBackoff: Level 0 = 1s
        ExponentialBackoff: Level 1 = 2s
        ExponentialBackoff: Level 2 = 4s
        ExponentialBackoff: Max = 2min
    }
```

#### ã‚³ãƒ³ãƒœ ãƒ¢ãƒ‡ãƒ« ãƒã‚§ãƒ¼ãƒ³

```mermaid
flowchart LR
    A["Request with\ncombo model"] --> B["Model A"]
    B -->|"2xx Success"| C["Return response"]
    B -->|"429/401/500"| D{"Fallback\neligible?"}
    D -->|Yes| E["Model B"]
    D -->|No| F["Return error"]
    E -->|"2xx Success"| C
    E -->|"429/401/500"| G{"Fallback\neligible?"}
    G -->|Yes| H["Model C"]
    G -->|No| F
    H -->|"2xx Success"| C
    H -->|"Fail"| I["All failed â†’\nReturn last status"]
```

---

### 4.5 ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ (`open-sse/translator/`)

è‡ªå·±ç™»éŒ²ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ãŸ **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ã‚¨ãƒ³ã‚¸ãƒ³**ã€‚

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TD
    subgraph "Request Translation"
        A["Claude â†’ OpenAI"]
        B["Gemini â†’ OpenAI"]
        C["Antigravity â†’ OpenAI"]
        D["OpenAI Responses â†’ OpenAI"]
        E["OpenAI â†’ Claude"]
        F["OpenAI â†’ Gemini"]
        G["OpenAI â†’ Kiro"]
        H["OpenAI â†’ Cursor"]
    end

    subgraph "Response Translation"
        I["Claude â†’ OpenAI"]
        J["Gemini â†’ OpenAI"]
        K["Kiro â†’ OpenAI"]
        L["Cursor â†’ OpenAI"]
        M["OpenAI â†’ Claude"]
        N["OpenAI â†’ Antigravity"]
        O["OpenAI â†’ Responses"]
    end
```

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ãƒ•ã‚¡ã‚¤ãƒ«      | èª¬æ˜                                                                                                                                                                                                                                                           |
| ------------ | ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `request/`   | ç¿»è¨³è€…8å     | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–“ã§å¤‰æ›ã—ã¾ã™ã€‚å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã« `register(from, to, fn)` ã‚’ä»‹ã—ã¦è‡ªå·±ç™»éŒ²ã•ã‚Œã¾ã™ã€‚                                                                                                                                 |
| `response/`  | ç¿»è¨³è€… 7 å   | ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–“ã§å¤‰æ›ã—ã¾ã™ã€‚ SSE ã‚¤ãƒ™ãƒ³ãƒˆ ã‚¿ã‚¤ãƒ—ã€æ€è€ƒãƒ–ãƒ­ãƒƒã‚¯ã€ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’å‡¦ç†ã—ã¾ã™ã€‚                                                                                                                                       |
| `helpers/`   | 6äººã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ | å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: `claudeHelper` (ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæŠ½å‡ºã€ã‚·ãƒ³ã‚­ãƒ³ã‚°æ§‹æˆ)ã€`geminiHelper` (ãƒ‘ãƒ¼ãƒ„/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ãƒãƒƒãƒ”ãƒ³ã‚°)ã€`openaiHelper` (ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)ã€`toolCallHelper` (ID ç”Ÿæˆã€æ¬ è½å¿œç­”æŒ¿å…¥)ã€`maxTokensHelper`ã€`responsesApiHelper`ã€‚ |
| `index.ts`   | â€”             | å¤‰æ›ã‚¨ãƒ³ã‚¸ãƒ³: `translateRequest()`ã€`translateResponse()`ã€çŠ¶æ…‹ç®¡ç†ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã€‚                                                                                                                                                                              |
| `formats.ts` | â€”             | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®šæ•°: `OPENAI`ã€`CLAUDE`ã€`GEMINI`ã€`ANTIGRAVITY`ã€`KIRO`ã€`CURSOR`ã€`OPENAI_RESPONSES`ã€‚                                                                                                                                                          |

#### ä¸»ãªè¨­è¨ˆ: è‡ªå·±ç™»éŒ²ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

```javascript
// Each translator file calls register() on import:
import { register } from "../index.js";
register("claude", "openai", translateClaudeToOpenAI);

// The index.js imports all translator files, triggering registration:
import "./request/claude-to-openai.js"; // â† self-registers
```

---

### 4.6 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (`open-sse/utils/`)

| ãƒ•ã‚¡ã‚¤ãƒ«           | ç›®çš„                                                                                                                                                                                                                                                                                                      |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `error.ts`         | ã‚¨ãƒ©ãƒ¼å¿œç­”ã®æ§‹ç¯‰ (OpenAI äº’æ›å½¢å¼)ã€ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ  ã‚¨ãƒ©ãƒ¼è§£æã€ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®åé‡åŠ›å†è©¦è¡Œæ™‚é–“ã®æŠ½å‡ºã€SSE ã‚¨ãƒ©ãƒ¼ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€‚                                                                                                                                                               |
| `stream.ts`        | **SSE Transform Stream** â€” ã‚³ã‚¢ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€‚ 2 ã¤ã®ãƒ¢ãƒ¼ãƒ‰: `TRANSLATE` (å®Œå…¨ãªå½¢å¼ã®å¤‰æ›) ã¨ `PASSTHROUGH` (æ­£è¦åŒ– + ä½¿ç”¨æ³•ã®æŠ½å‡º)ã€‚ãƒãƒ£ãƒ³ã‚¯ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã€ä½¿ç”¨é‡ã®æ¨å®šã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ã®è¿½è·¡ã‚’å‡¦ç†ã—ã¾ã™ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ã”ã¨ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€/ãƒ‡ã‚³ãƒ¼ãƒ€ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯å…±æœ‰çŠ¶æ…‹ã‚’å›é¿ã—ã¾ã™ã€‚ |
| `streamHelpers.ts` | ä½ãƒ¬ãƒ™ãƒ« SSE ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: `parseSSELine` (ãƒ›ãƒ¯ã‚¤ãƒˆã‚¹ãƒšãƒ¼ã‚¹è€æ€§)ã€`hasValuableContent` (OpenAI/Claude/Gemini ã®ç©ºã®ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)ã€`fixInvalidId`ã€`formatSSE` (`perf_metrics` ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã‚‹å½¢å¼èªè­˜ SSE ã‚·ãƒªã‚¢ãƒ«åŒ–)ã€‚                                                                |
| `usageTracking.ts` | ä»»æ„ã®å½¢å¼ (Claude/OpenAI/Gemini/Responses) ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®æŠ½å‡ºã€åˆ¥å€‹ã®ãƒ„ãƒ¼ãƒ«/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ–‡å­—æ•°ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¯”ç‡ã«ã‚ˆã‚‹æ¨å®šã€ãƒãƒƒãƒ•ã‚¡ãƒ¼ã®è¿½åŠ  (2000 ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³)ã€å½¢å¼å›ºæœ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ANSI ã‚«ãƒ©ãƒ¼ã§ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ« ãƒ­ã‚®ãƒ³ã‚°ã€‚                                              |
| `requestLogger.ts` | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚° (`ENABLE_REQUEST_LOGS=true` ã«ã‚ˆã‚‹ã‚ªãƒ—ãƒˆã‚¤ãƒ³)ã€‚ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ã‚»ãƒƒã‚·ãƒ§ãƒ³ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™: `1_req_client.json` â†’ `7_res_client.txt`ã€‚ã™ã¹ã¦ã® I/O ã¯éåŒæœŸ (ãƒ•ã‚¡ã‚¤ã‚¢ ã‚¢ãƒ³ãƒ‰ ãƒ•ã‚©ãƒ¼ã‚²ãƒƒãƒˆ) ã§ã™ã€‚æ©Ÿå¯†ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚¹ã‚¯ã—ã¾ã™ã€‚                                  |
| `bypassHandler.ts` | Claude CLI ã‹ã‚‰ã®ç‰¹å®šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ (ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡ºã€ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã€ã‚«ã‚¦ãƒ³ãƒˆ) ã‚’å‚å—ã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å‘¼ã³å‡ºã•ãšã«å½ã®å¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¨éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚æ„å›³çš„ã« Claude CLI ã‚¹ã‚³ãƒ¼ãƒ—ã«é™å®šã•ã‚Œã¦ã„ã¾ã™ã€‚                                                                 |
| `networkProxy.ts`  | æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®é€ä¿¡ãƒ—ãƒ­ã‚­ã‚· URL ã‚’å„ªå…ˆé †ä½ã§è§£æ±ºã—ã¾ã™: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å›ºæœ‰ã®æ§‹æˆ â†’ ã‚°ãƒ­ãƒ¼ãƒãƒ«æ§‹æˆ â†’ ç’°å¢ƒå¤‰æ•° (`HTTPS_PROXY`/`HTTP_PROXY`/`ALL_PROXY`)ã€‚ `NO_PROXY` ã®é™¤å¤–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚è¨­å®šã‚’ 30 ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚                                                                        |

#### SSE ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```mermaid
flowchart TD
    A["Provider SSE stream"] --> B["TextDecoder\n(per-stream instance)"]
    B --> C["Buffer lines\n(split on newline)"]
    C --> D["parseSSELine()\n(trim whitespace, parse JSON)"]
    D --> E{"Mode?"}
    E -->|TRANSLATE| F["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E -->|PASSTHROUGH| G["fixInvalidId()\nnormalize chunk"]
    F --> H["hasValuableContent()\nfilter empty chunks"]
    G --> H
    H -->|"Has content"| I["extractUsage()\ntrack token counts"]
    H -->|"Empty"| J["Skip chunk"]
    I --> K["formatSSE()\nserialize + clean perf_metrics"]
    K --> L["TextEncoder\n(per-stream instance)"]
    L --> M["Enqueue to\nclient stream"]

    style A fill:#f9f,stroke:#333
    style M fill:#9f9,stroke:#333
```

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ãƒ­ã‚¬ãƒ¼ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ§‹é€ 

```
logs/
â””â”€â”€ claude_gemini_claude-sonnet_20260208_143045/
    â”œâ”€â”€ 1_req_client.json      â† Raw client request
    â”œâ”€â”€ 2_req_source.json      â† After initial conversion
    â”œâ”€â”€ 3_req_openai.json      â† OpenAI intermediate format
    â”œâ”€â”€ 4_req_target.json      â† Final target format
    â”œâ”€â”€ 5_res_provider.txt     â† Provider SSE chunks (streaming)
    â”œâ”€â”€ 5_res_provider.json    â† Provider response (non-streaming)
    â”œâ”€â”€ 6_res_openai.txt       â† OpenAI intermediate chunks
    â”œâ”€â”€ 7_res_client.txt       â† Client-facing SSE chunks
    â””â”€â”€ 6_error.json           â† Error details (if any)
```

---

### 4.7 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (`src/`)

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª  | ç›®çš„                                                                         |
| ------------- | ---------------------------------------------------------------------------- |
| `src/app/`    | Web UIã€API ãƒ«ãƒ¼ãƒˆã€Express ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€OAuth ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼      |
| `src/lib/`    | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ã‚¢ã‚¯ã‚»ã‚¹ (`localDb.ts`ã€`usageDb.ts`)ã€èªè¨¼ã€å…±æœ‰               |
| `src/mitm/`   | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å‚å—ã™ã‚‹ä¸­é–“è€…ãƒ—ãƒ­ã‚­ã‚· ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£            |
| `src/models/` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©                                                     |
| `src/shared/` | open-sse é–¢æ•° (ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã€ã‚¨ãƒ©ãƒ¼ãªã©) ã®ãƒ©ãƒƒãƒ‘ãƒ¼              |
| `src/sse/`    | open-sse ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ Express ãƒ«ãƒ¼ãƒˆã«æ¥ç¶šã™ã‚‹ SSE ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ |
| `src/store/`  | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†                                                     |

#### æ³¨ç›®ã™ã¹ã API ãƒ«ãƒ¼ãƒˆ

| ãƒ«ãƒ¼ãƒˆ                                        | ãƒ¡ã‚½ãƒƒãƒ‰       | ç›®çš„                                                                                                     |
| --------------------------------------------- | -------------- | -------------------------------------------------------------------------------------------------------- |
| `/api/provider-models`                        | å–å¾—/æŠ•ç¨¿/å‰Šé™¤ | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®ã‚«ã‚¹ã‚¿ãƒ  ãƒ¢ãƒ‡ãƒ«ã® CRUD                                                                 |
| `/api/models/catalog`                         | å…¥æ‰‹           | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ« (ãƒãƒ£ãƒƒãƒˆã€åŸ‹ã‚è¾¼ã¿ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚«ã‚¹ã‚¿ãƒ ) ã®é›†ç´„ã‚«ã‚¿ãƒ­ã‚° |
| `/api/settings/proxy`                         | å–å¾—/æŒ¿å…¥/å‰Šé™¤ | éšå±¤å‹é€ä¿¡ãƒ—ãƒ­ã‚­ã‚·æ§‹æˆ (`global/providers/combos/keys`)                                                  |
| `/api/settings/proxy/test`                    | æŠ•ç¨¿           | ãƒ—ãƒ­ã‚­ã‚·æ¥ç¶šã‚’æ¤œè¨¼ã—ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP/é…å»¶ã‚’è¿”ã—ã¾ã™ã€‚                                                     |
| `/v1/providers/[provider]/chat/completions`   | æŠ•ç¨¿           | ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã‚’å‚™ãˆãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®å°‚ç”¨ãƒãƒ£ãƒƒãƒˆè£œå®Œ                                                     |
| `/v1/providers/[provider]/embeddings`         | æŠ•ç¨¿           | ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã‚’å‚™ãˆãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®å°‚ç”¨åŸ‹ã‚è¾¼ã¿                                                         |
| `/v1/providers/[provider]/images/generations` | æŠ•ç¨¿           | ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã‚’å‚™ãˆãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®å°‚ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆ                                                     |
| `/api/settings/ip-filter`                     | GET/PUT        | IP ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ/ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†                                                                     |
| `/api/settings/thinking-budget`               | GET/PUT        | æ¨è«–ãƒˆãƒ¼ã‚¯ãƒ³ã®äºˆç®—æ§‹æˆ (ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼/è‡ªå‹•/ã‚«ã‚¹ã‚¿ãƒ /ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–)                                           |
| `/api/settings/system-prompt`                 | GET/PUT        | ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ« ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³                                |
| `/api/sessions`                               | å…¥æ‰‹           | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¿½è·¡ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹                                                                 |
| `/api/rate-limits`                            | å…¥æ‰‹           | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                                                                     |

---

## 5. ä¸»è¦ãªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### 5.1 ãƒãƒ–ã‚¢ãƒ³ãƒ‰ã‚¹ãƒãƒ¼ã‚¯å¤‰æ›

ã™ã¹ã¦ã®å½¢å¼ã¯ **OpenAI å½¢å¼ã‚’ãƒãƒ–**ã¨ã—ã¦å¤‰æ›ã—ã¾ã™ã€‚æ–°ã—ã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€N ãƒšã‚¢ã§ã¯ãªãã€**1 ãƒšã‚¢** ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼ (OpenAI ã¨ã®é–“) ã‚’ä½œæˆã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚

### 5.2 ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼æˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³

å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã¯ã€`BaseExecutor` ã‚’ç¶™æ‰¿ã™ã‚‹å°‚ç”¨ã®å®Ÿè¡Œã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ `executors/index.ts` ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªã¯ã€å®Ÿè¡Œæ™‚ã«æ­£ã—ã„ã‚‚ã®ã‚’é¸æŠã—ã¾ã™ã€‚

### 5.3 è‡ªå·±ç™»éŒ²ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ã‚·ã‚¹ãƒ†ãƒ 

ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã« `register()` ã‚’ä»‹ã—ã¦è‡ªèº«ã‚’ç™»éŒ²ã—ã¾ã™ã€‚æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã ã‘ã§ã™ã€‚

### 5.4 æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒ 429/401/500 ã‚’è¿”ã™ã¨ã€ã‚·ã‚¹ãƒ†ãƒ ã¯æ¬¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ã€æŒ‡æ•°é–¢æ•°çš„ãªã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ (1 ç§’ â†’ 2 ç§’ â†’ 4 ç§’ â†’ æœ€å¤§ 2 åˆ†) ã‚’é©ç”¨ã§ãã¾ã™ã€‚

### 5.5 ã‚³ãƒ³ãƒœãƒ¢ãƒ‡ãƒ«ãƒã‚§ãƒ¼ãƒ³

ã€Œã‚³ãƒ³ãƒœã€ã¯ã€è¤‡æ•°ã® `provider/model` æ–‡å­—åˆ—ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã™ã€‚æœ€åˆã®å‡¦ç†ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€è‡ªå‹•çš„ã«æ¬¡ã®å‡¦ç†ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚

### 5.6 ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ« ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¤‰æ›

å¿œç­”ã®å¤‰æ›ã¯ã€`initState()` ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’ä»‹ã—ã¦ã€SSE ãƒãƒ£ãƒ³ã‚¯å…¨ä½“ (æ€è€ƒãƒ–ãƒ­ãƒƒã‚¯ã®è¿½è·¡ã€ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®è“„ç©ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ) ã®çŠ¶æ…‹ã‚’ç¶­æŒã—ã¾ã™ã€‚

### 5.7 ä½¿ç”¨å®‰å…¨ãƒãƒƒãƒ•ã‚¡ãƒ¼

ã‚·ã‚¹ãƒ†ãƒ  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„å½¢å¼å¤‰æ›ã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã«ã‚ˆã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®åˆ¶é™ã«é”ã™ã‚‹ã®ã‚’é˜²ããŸã‚ã«ã€å ±å‘Šã•ã‚ŒãŸä½¿ç”¨é‡ã« 2000 ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒãƒ•ã‚¡ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

---

## 6. ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å½¢å¼

| ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ          | æ–¹å‘                | è­˜åˆ¥å­             |
| --------------------- | ------------------- | ------------------ |
| OpenAI ãƒãƒ£ãƒƒãƒˆã®å®Œäº† | ã‚½ãƒ¼ã‚¹ + ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | `openai`           |
| OpenAI ãƒ¬ã‚¹ãƒãƒ³ã‚¹ API | ã‚½ãƒ¼ã‚¹ + ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | `openai-responses` |
| äººé–“ã®ã‚¯ãƒ­ãƒ¼ãƒ‰        | ã‚½ãƒ¼ã‚¹ + ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | `claude`           |
| Google ã‚¸ã‚§ãƒŸãƒ‹       | ã‚½ãƒ¼ã‚¹ + ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | `gemini`           |
| Google Gemini CLI     | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã¿      | `gemini-cli`       |
| åé‡åŠ›                | ã‚½ãƒ¼ã‚¹ + ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | `antigravity`      |
| AWS ã‚­ãƒ­              | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã¿      | `kiro`             |
| ã‚«ãƒ¼ã‚½ãƒ«              | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã¿      | `cursor`           |

---

## 7. ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

| ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼             | èªè¨¼æ–¹æ³•                      | åŸ·è¡Œè€…       | é‡è¦ãªãƒ¡ãƒ¢                                                  |
| ------------------------ | ----------------------------- | ------------ | ----------------------------------------------------------- |
| äººé–“ã®ã‚¯ãƒ­ãƒ¼ãƒ‰           | API ã‚­ãƒ¼ã¾ãŸã¯ OAuth          | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | `x-api-key` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚                          |
| Google ã‚¸ã‚§ãƒŸãƒ‹          | API ã‚­ãƒ¼ã¾ãŸã¯ OAuth          | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | `x-goog-api-key` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚                     |
| Google Gemini CLI        | OAuth                         | ã‚¸ã‚§ãƒŸãƒ‹CLI  | `streamGenerateContent` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚        |
| åé‡åŠ›                   | OAuth                         | åé‡åŠ›       | ãƒãƒ«ãƒ URL ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã‚«ã‚¹ã‚¿ãƒ å†è©¦è¡Œè§£æ               |
| ã‚ªãƒ¼ãƒ—ãƒ³AI               | APIã‚­ãƒ¼                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | æ¨™æº–ãƒ™ã‚¢ãƒ©ãƒ¼èªè¨¼                                            |
| ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚¹             | OAuth                         | ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚¹ | ã‚·ã‚¹ãƒ†ãƒ å‘½ä»¤ã‚’æ³¨å…¥ã—ã€æ€è€ƒã‚’ç®¡ç†ã—ã¾ã™                      |
| GitHub ã‚³ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ      | OAuth + ã‚³ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ ãƒˆãƒ¼ã‚¯ãƒ³ | ã‚®ãƒƒãƒˆãƒãƒ–   | ãƒ‡ãƒ¥ã‚¢ãƒ« ãƒˆãƒ¼ã‚¯ãƒ³ã€VSCode ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¨¡å€£                    |
| ã‚­ãƒ­ (AWS)               | AWS SSO OIDC ã¾ãŸã¯ã‚½ãƒ¼ã‚·ãƒ£ãƒ« | ã‚­ãƒ­         | ãƒã‚¤ãƒŠãƒª EventStream è§£æ                                   |
| ã‚«ãƒ¼ã‚½ãƒ«IDE              | ãƒã‚§ãƒƒã‚¯ã‚µãƒ èªè¨¼              | ã‚«ãƒ¼ã‚½ãƒ«     | Protobuf ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€SHA-256 ãƒã‚§ãƒƒã‚¯ã‚µãƒ              |
| ã‚¯ã‚¦ã‚§ãƒ³                 | OAuth                         | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | æ¨™æº–èªè¨¼                                                    |
| iFlow                    | OAuth (ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ + ãƒ™ã‚¢ãƒ©ãƒ¼) | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | ãƒ‡ãƒ¥ã‚¢ãƒ«èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼                                        |
| ã‚ªãƒ¼ãƒ—ãƒ³ãƒ«ãƒ¼ã‚¿ãƒ¼         | APIã‚­ãƒ¼                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | æ¨™æº–ãƒ™ã‚¢ãƒ©ãƒ¼èªè¨¼                                            |
| GLMã€ã‚­ãƒŸã€ãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹  | APIã‚­ãƒ¼                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | Claude ã¨äº’æ›æ€§ãŒã‚ã‚‹ãŸã‚ã€`x-api-key` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ |
| `openai-compatible-*`    | APIã‚­ãƒ¼                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | å‹•çš„: ä»»æ„ã® OpenAI äº’æ›ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                      |
| `anthropic-compatible-*` | APIã‚­ãƒ¼                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ   | å‹•çš„: ã‚¯ãƒ­ãƒ¼ãƒ‰ã¨äº’æ›æ€§ã®ã‚ã‚‹ä»»æ„ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ            |

---

## 8. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®æ¦‚è¦

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor\nbuildUrl + buildHeaders"]
    D --> E["fetch(providerURL)"]
    E --> F["createSSEStream()\nTRANSLATE mode"]
    F --> G["parseSSELine()"]
    G --> H["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    H --> I["extractUsage()\n+ addBuffer"]
    I --> J["formatSSE()"]
    J --> K["Client receives\ntranslated SSE"]
    K --> L["logUsage()\nsaveRequestUsage()"]
```

### éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor.execute()"]
    D --> E["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E --> F["Return JSON\nresponse"]
```

### ãƒã‚¤ãƒ‘ã‚¹ ãƒ•ãƒ­ãƒ¼ (Claude CLI)

```mermaid
flowchart LR
    A["Claude CLI request"] --> B{"Match bypass\npattern?"}
    B -->|"Title/Warmup/Count"| C["Generate fake\nOpenAI response"]
    B -->|"No match"| D["Normal flow"]
    C --> E["Translate to\nsource format"]
    E --> F["Return without\ncalling provider"]
```
