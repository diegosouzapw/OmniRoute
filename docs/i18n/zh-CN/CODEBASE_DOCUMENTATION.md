ğŸŒ **Languages:** ğŸ‡ºğŸ‡¸ [English](../../CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡· [PortuguÃªs (Brasil)](../pt-BR/CODEBASE_DOCUMENTATION.md) | ğŸ‡ªğŸ‡¸ [EspaÃ±ol](../es/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡· [FranÃ§ais](../fr/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡¹ [Italiano](../it/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡º [Ğ ÑƒÑÑĞºĞ¸Ğ¹](../ru/CODEBASE_DOCUMENTATION.md) | ğŸ‡¨ğŸ‡³ [ä¸­æ–‡ (ç®€ä½“)](../zh-CN/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡ª [Deutsch](../de/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡³ [à¤¹à¤¿à¤¨à¥à¤¦à¥€](../in/CODEBASE_DOCUMENTATION.md) | ğŸ‡¹ğŸ‡­ [à¹„à¸—à¸¢](../th/CODEBASE_DOCUMENTATION.md) | ğŸ‡ºğŸ‡¦ [Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°](../uk-UA/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡¦ [Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©](../ar/CODEBASE_DOCUMENTATION.md) | ğŸ‡¯ğŸ‡µ [æ—¥æœ¬èª](../ja/CODEBASE_DOCUMENTATION.md) | ğŸ‡»ğŸ‡³ [Tiáº¿ng Viá»‡t](../vi/CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡¬ [Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸](../bg/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡° [Dansk](../da/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡® [Suomi](../fi/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡± [×¢×‘×¨×™×ª](../he/CODEBASE_DOCUMENTATION.md) | ğŸ‡­ğŸ‡º [Magyar](../hu/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡© [Bahasa Indonesia](../id/CODEBASE_DOCUMENTATION.md) | ğŸ‡°ğŸ‡· [í•œêµ­ì–´](../ko/CODEBASE_DOCUMENTATION.md) | ğŸ‡²ğŸ‡¾ [Bahasa Melayu](../ms/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡± [Nederlands](../nl/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡´ [Norsk](../no/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡¹ [PortuguÃªs (Portugal)](../pt/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡´ [RomÃ¢nÄƒ](../ro/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡± [Polski](../pl/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡° [SlovenÄina](../sk/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡ª [Svenska](../sv/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡­ [Filipino](../phi/CODEBASE_DOCUMENTATION.md)

#omniroute â€” ä»£ç åº“æ–‡æ¡£

> A comprehensive, beginner-friendly guide to the **omniroute** multi-provider AI proxy router.

---

## 1. ä»€ä¹ˆæ˜¯å…¨å‘ï¼Ÿ

omniroute æ˜¯ä¸€ä¸ª**ä»£ç†è·¯ç”±å™¨**ï¼Œä½äº AI å®¢æˆ·ç«¯ï¼ˆClaude CLIã€Codexã€Cursor IDE ç­‰ï¼‰å’Œ AI æä¾›å•†ï¼ˆAnthropicã€Googleã€OpenAIã€AWSã€GitHub ç­‰ï¼‰ä¹‹é—´ã€‚å®ƒè§£å†³äº†ä¸€ä¸ªå¤§é—®é¢˜ï¼š

> **ä¸åŒçš„ AI å®¢æˆ·ç«¯ä½¿ç”¨ä¸åŒçš„â€œè¯­è¨€â€ï¼ˆAPI æ ¼å¼ï¼‰ï¼Œä¸åŒçš„ AI æä¾›å•†ä¹ŸæœŸæœ›ä¸åŒçš„â€œè¯­è¨€â€ã€‚**omniroute è‡ªåŠ¨åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œç¿»è¯‘ã€‚

å¯ä»¥å°†å…¶æƒ³è±¡ä¸ºè”åˆå›½çš„é€šç”¨ç¿»è¯‘å™¨ - ä»»ä½•ä»£è¡¨éƒ½å¯ä»¥è¯´ä»»ä½•è¯­è¨€ï¼Œç¿»è¯‘å™¨å¯ä»¥å°†å…¶è½¬æ¢ä¸ºä»»ä½•å…¶ä»–ä»£è¡¨ã€‚

---

## 2. æ¶æ„æ¦‚è¿°

```mermaid
graph LR
    subgraph Clients
        A[Claude CLI]
        B[Codex]
        C[Cursor IDE]
        D[OpenAI-compatible]
    end

    subgraph omniroute
        E[Handler Layer]
        F[Translator Layer]
        G[Executor Layer]
        H[Services Layer]
    end

    subgraph Providers
        I[Anthropic Claude]
        J[Google Gemini]
        K[OpenAI / Codex]
        L[GitHub Copilot]
        M[AWS Kiro]
        N[Antigravity]
        O[Cursor API]
    end

    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> I
    G --> J
    G --> K
    G --> L
    G --> M
    G --> N
    G --> O
    H -.-> E
    H -.-> G
```

### æ ¸å¿ƒåŸåˆ™ï¼šè½´è¾å¼ç¿»è¯‘

All format translation passes through **OpenAI format as the hub**:

```
Client Format â†’ [OpenAI Hub] â†’ Provider Format    (request)
Provider Format â†’ [OpenAI Hub] â†’ Client Format    (response)
```

This means you only need **N translators** (one per format) instead of **NÂ²** (every pair).

---

## 3. é¡¹ç›®ç»“æ„

```
omniroute/
â”œâ”€â”€ open-sse/                  â† Core proxy library (portable, framework-agnostic)
â”‚   â”œâ”€â”€ index.js               â† Main entry point, exports everything
â”‚   â”œâ”€â”€ config/                â† Configuration & constants
â”‚   â”œâ”€â”€ executors/             â† Provider-specific request execution
â”‚   â”œâ”€â”€ handlers/              â† Request handling orchestration
â”‚   â”œâ”€â”€ services/              â† Business logic (auth, models, fallback, usage)
â”‚   â”œâ”€â”€ translator/            â† Format translation engine
â”‚   â”‚   â”œâ”€â”€ request/           â† Request translators (8 files)
â”‚   â”‚   â”œâ”€â”€ response/          â† Response translators (7 files)
â”‚   â”‚   â””â”€â”€ helpers/           â† Shared translation utilities (6 files)
â”‚   â””â”€â”€ utils/                 â† Utility functions
â”œâ”€â”€ src/                       â† Application layer (Express/Worker runtime)
â”‚   â”œâ”€â”€ app/                   â† Web UI, API routes, middleware
â”‚   â”œâ”€â”€ lib/                   â† Database, auth, and shared library code
â”‚   â”œâ”€â”€ mitm/                  â† Man-in-the-middle proxy utilities
â”‚   â”œâ”€â”€ models/                â† Database models
â”‚   â”œâ”€â”€ shared/                â† Shared utilities (wrappers around open-sse)
â”‚   â”œâ”€â”€ sse/                   â† SSE endpoint handlers
â”‚   â””â”€â”€ store/                 â† State management
â”œâ”€â”€ data/                      â† Runtime data (credentials, logs)
â”‚   â””â”€â”€ provider-credentials.json   (external credentials override, gitignored)
â””â”€â”€ tester/                    â† Test utilities
```

---

## 4. é€ä¸ªæ¨¡å—ç»†åˆ†

### 4.1 é…ç½® (`open-sse/config/`)

The **single source of truth** for all provider configuration.

| æ–‡ä»¶                          | ç›®çš„                                                                                                                                                                          |
| ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `constants.ts`                | `PROVIDERS` å¯¹è±¡ï¼ŒåŒ…å«æ¯ä¸ªæä¾›å•†çš„åŸºæœ¬ URLã€OAuth å‡­æ®ï¼ˆé»˜è®¤ï¼‰ã€æ ‡å¤´å’Œé»˜è®¤ç³»ç»Ÿæç¤ºã€‚è¿˜å®šä¹‰ `HTTP_STATUS`ã€`ERROR_TYPES`ã€`COOLDOWN_MS`ã€`BACKOFF_CONFIG` å’Œ `SKIP_PATTERNS`ã€‚ |
| `credentialLoader.ts`         | ä» `data/provider-credentials.json` åŠ è½½å¤–éƒ¨å‡­æ®ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶åˆ° `PROVIDERS` ä¸­çš„ç¡¬ç¼–ç é»˜è®¤å€¼ä¸Šã€‚è®©ç§˜å¯†ä¸å—æºä»£ç æ§åˆ¶ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹æ€§ã€‚                                   |
| `providerModels.ts`           | ä¸­å¤®æ¨¡å‹æ³¨å†Œè¡¨ï¼šæ˜ å°„æä¾›è€…åˆ«å â†’ æ¨¡å‹ IDã€‚ç±»ä¼¼ `getModels()`ã€`getProviderByAlias()` çš„å‡½æ•°ã€‚                                                                                 |
| `codexInstructions.ts`        | ç³»ç»ŸæŒ‡ä»¤æ³¨å…¥åˆ° Codex è¯·æ±‚ä¸­ï¼ˆç¼–è¾‘çº¦æŸã€æ²™ç®±è§„åˆ™ã€æ‰¹å‡†ç­–ç•¥ï¼‰ã€‚                                                                                                                 |
| `defaultThinkingSignature.ts` | å…‹åŠ³å¾·å’ŒåŒå­åº§æ¨¡å‹çš„é»˜è®¤â€œæ€è€ƒâ€ç­¾åã€‚                                                                                                                                          |
| `ollamaModels.ts`             | æœ¬åœ° Ollama æ¨¡å‹çš„æ¶æ„å®šä¹‰ï¼ˆåç§°ã€å¤§å°ã€ç³»åˆ—ã€é‡åŒ–ï¼‰ã€‚                                                                                                                        |

#### å‡­è¯åŠ è½½æµç¨‹

```mermaid
flowchart TD
    A["App starts"] --> B["constants.ts defines PROVIDERS\nwith hardcoded defaults"]
    B --> C{"data/provider-credentials.json\nexists?"}
    C -->|Yes| D["credentialLoader reads JSON"]
    C -->|No| E["Use hardcoded defaults"]
    D --> F{"For each provider in JSON"}
    F --> G{"Provider exists\nin PROVIDERS?"}
    G -->|No| H["Log warning, skip"]
    G -->|Yes| I{"Value is object?"}
    I -->|No| J["Log warning, skip"]
    I -->|Yes| K["Merge clientId, clientSecret,\ntokenUrl, authUrl, refreshUrl"]
    K --> F
    H --> F
    J --> F
    F -->|Done| L["PROVIDERS ready with\nmerged credentials"]
    E --> L
```

---

### 4.2 æ‰§è¡Œè€… (`open-sse/executors/`)

æ‰§è¡Œå™¨ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**å°è£…**ç‰¹å®šäºæä¾›è€…çš„é€»è¾‘**ã€‚æ¯ä¸ªæ‰§è¡Œå™¨æ ¹æ®éœ€è¦é‡å†™åŸºæœ¬æ–¹æ³•ã€‚

```mermaid
classDiagram
    class BaseExecutor {
        +buildUrl(model, stream, options)
        +buildHeaders(credentials, stream, body)
        +transformRequest(body, model, stream, credentials)
        +execute(url, options)
        +shouldRetry(status, error)
        +refreshCredentials(credentials, log)
    }

    class DefaultExecutor {
        +refreshCredentials()
    }

    class AntigravityExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +shouldRetry()
        +refreshCredentials()
    }

    class CursorExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseResponse()
        +generateChecksum()
    }

    class KiroExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseEventStream()
        +refreshCredentials()
    }

    BaseExecutor <|-- DefaultExecutor
    BaseExecutor <|-- AntigravityExecutor
    BaseExecutor <|-- CursorExecutor
    BaseExecutor <|-- KiroExecutor
    BaseExecutor <|-- CodexExecutor
    BaseExecutor <|-- GeminiCLIExecutor
    BaseExecutor <|-- GithubExecutor
```

| æ‰§è¡Œäºº           | ä¾›åº”å•†                                     | é‡ç‚¹ä¸“ä¸š                                                                             |
| ---------------- | ------------------------------------------ | ------------------------------------------------------------------------------------ |
| `base.ts`        | â€”                                          | æŠ½è±¡åŸºç¡€ï¼šURL æ„å»ºã€æ ‡å¤´ã€é‡è¯•é€»è¾‘ã€å‡­è¯åˆ·æ–°                                         |
| `default.ts`     | å…‹åŠ³å¾·ã€Geminiã€OpenAIã€GLMã€Kimiã€MiniMax | æ ‡å‡†æä¾›å•†çš„é€šç”¨ OAuth ä»¤ç‰Œåˆ·æ–°                                                      |
| `antigravity.ts` | è°·æ­Œäº‘ä»£ç                                  | é¡¹ç›®/ä¼šè¯ ID ç”Ÿæˆã€å¤š URL å›é€€ã€è‡ªå®šä¹‰é‡è¯•é”™è¯¯æ¶ˆæ¯è§£æï¼ˆâ€œ2 å°æ—¶ 7 åˆ† 23 ç§’åé‡ç½®â€ï¼‰  |
| `cursor.ts`      | å…‰æ ‡IDE                                    | **æœ€å¤æ‚**ï¼šSHA-256 æ ¡éªŒå’ŒéªŒè¯ã€Protobuf è¯·æ±‚ç¼–ç ã€äºŒè¿›åˆ¶ EventStream â†’ SSE å“åº”è§£æ |
| `codex.ts`       | OpenAI æ³•å…¸                                | æ³¨å…¥ç³»ç»ŸæŒ‡ä»¤ã€ç®¡ç†æ€ç»´æ°´å¹³ã€åˆ é™¤ä¸æ”¯æŒçš„å‚æ•°                                         |
| `gemini-cli.ts`  | è°·æ­Œ Gemini CLI                            | è‡ªå®šä¹‰ URL æ„å»º (`streamGenerateContent`)ã€Google OAuth ä»¤ç‰Œåˆ·æ–°                     |
| `github.ts`      | GitHub å‰¯é©¾é©¶                              | åŒä»¤ç‰Œç³»ç»Ÿï¼ˆGitHub OAuth + Copilot ä»¤ç‰Œï¼‰ï¼ŒVSCode æ ‡å¤´æ¨¡ä»¿                           |
| `kiro.ts`        | AWS ä»£ç è€³è¯­                               | AWS EventStream äºŒè¿›åˆ¶è§£æã€AMZN äº‹ä»¶æ¡†æ¶ã€ä»¤ç‰Œä¼°è®¡                                  |
| `index.ts`       | â€”                                          | å·¥å‚ï¼šåœ°å›¾æä¾›è€…åç§° â†’ æ‰§è¡Œå™¨ç±»ï¼Œå…·æœ‰é»˜è®¤åå¤‡                                        |

---

### 4.3 å¤„ç†ç¨‹åº (`open-sse/handlers/`)

**ç¼–æ’å±‚** â€” åè°ƒç¿»è¯‘ã€æ‰§è¡Œã€æµå¼ä¼ è¾“å’Œé”™è¯¯å¤„ç†ã€‚

| æ–‡ä»¶                  | ç›®çš„                                                                                                                             |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| `chatCore.ts`         | **ä¸­å¤®ç¼–æ’å™¨**ï¼ˆçº¦ 600 è¡Œï¼‰ã€‚å¤„ç†å®Œæ•´çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼šæ ¼å¼æ£€æµ‹â†’è½¬æ¢â†’æ‰§è¡Œç¨‹åºè°ƒåº¦â†’æµ/éæµå“åº”â†’ä»¤ç‰Œåˆ·æ–°â†’é”™è¯¯å¤„ç†â†’ä½¿ç”¨æ—¥å¿—è®°å½•ã€‚     |
| `responsesHandler.ts` | OpenAI å“åº” API çš„é€‚é…å™¨ï¼šè½¬æ¢å“åº”æ ¼å¼ â†’ èŠå¤©å®Œæˆ â†’ å‘é€åˆ° `chatCore` â†’ å°† SSE è½¬æ¢å›å“åº”æ ¼å¼ã€‚                                  |
| `embeddings.ts`       | åµŒå…¥ç”Ÿæˆå¤„ç†ç¨‹åºï¼šè§£æåµŒå…¥æ¨¡å‹â†’æä¾›è€…ï¼Œåˆ†æ´¾åˆ°æä¾›è€… APIï¼Œè¿”å›å…¼å®¹ OpenAI çš„åµŒå…¥å“åº”ã€‚æ”¯æŒ 6 ä¸ªä»¥ä¸Šæä¾›å•†ã€‚                       |
| `imageGeneration.ts`  | å›¾åƒç”Ÿæˆå¤„ç†ç¨‹åºï¼šè§£æå›¾åƒæ¨¡å‹â†’æä¾›ç¨‹åºï¼Œæ”¯æŒ OpenAI å…¼å®¹ã€Gemini-imageï¼ˆåé‡åŠ›ï¼‰å’Œåå¤‡ï¼ˆNebiusï¼‰æ¨¡å¼ã€‚è¿”å› base64 æˆ– URL å›¾åƒã€‚ |

#### è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ (chatCore.ts)

```mermaid
sequenceDiagram
    participant Client
    participant chatCore
    participant Translator
    participant Executor
    participant Provider

    Client->>chatCore: Request (any format)
    chatCore->>chatCore: Detect source format
    chatCore->>chatCore: Check bypass patterns
    chatCore->>chatCore: Resolve model & provider
    chatCore->>Translator: Translate request (source â†’ OpenAI â†’ target)
    chatCore->>Executor: Get executor for provider
    Executor->>Executor: Build URL, headers, transform request
    Executor->>Executor: Refresh credentials if needed
    Executor->>Provider: HTTP fetch (streaming or non-streaming)

    alt Streaming
        Provider-->>chatCore: SSE stream
        chatCore->>chatCore: Pipe through SSE transform stream
        Note over chatCore: Transform stream translates<br/>each chunk: target â†’ OpenAI â†’ source
        chatCore-->>Client: Translated SSE stream
    else Non-streaming
        Provider-->>chatCore: JSON response
        chatCore->>Translator: Translate response
        chatCore-->>Client: Translated JSON
    end

    alt Error (401, 429, 500...)
        chatCore->>Executor: Retry with credential refresh
        chatCore->>chatCore: Account fallback logic
    end
```

---

### 4.4 æœåŠ¡ (`open-sse/services/`)

æ”¯æŒå¤„ç†ç¨‹åºå’Œæ‰§è¡Œç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ã€‚

| æ–‡ä»¶                 | ç›®çš„                                                                                                                                                                                                                                                         |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `provider.ts`        | **æ ¼å¼æ£€æµ‹** (`detectFormat`)ï¼šåˆ†æè¯·æ±‚ä¸»ä½“ç»“æ„ä»¥è¯†åˆ« Claude/OpenAI/Gemini/Antigravity/Responses æ ¼å¼ï¼ˆåŒ…æ‹¬ Claude çš„ `max_tokens` å¯å‘å¼ï¼‰ã€‚å¦å¤–ï¼šURL æ„å»ºã€æ ‡å¤´æ„å»ºã€æ€è€ƒé…ç½®è§„èŒƒåŒ–ã€‚æ”¯æŒ `openai-compatible-*` å’Œ `anthropic-compatible-*` åŠ¨æ€æä¾›ç¨‹åºã€‚ |
| `model.ts`           | æ¨¡å‹å­—ç¬¦ä¸²è§£æ (`claude/model-name` â†’ `{provider: "claude", model: "model-name"}`)ã€å…·æœ‰å†²çªæ£€æµ‹çš„åˆ«åè§£æã€è¾“å…¥æ¸…ç†ï¼ˆæ‹’ç»è·¯å¾„éå†/æ§åˆ¶å­—ç¬¦ï¼‰ä»¥åŠå…·æœ‰å¼‚æ­¥åˆ«å getter æ”¯æŒçš„æ¨¡å‹ä¿¡æ¯è§£æã€‚                                                                    |
| `accountFallback.ts` | é€Ÿç‡é™åˆ¶å¤„ç†ï¼šæŒ‡æ•°é€€é¿ï¼ˆ1 ç§’ â†’ 2 ç§’ â†’ 4 ç§’ â†’ æœ€å¤§ 2 åˆ†é’Ÿï¼‰ã€å¸æˆ·å†·å´ç®¡ç†ã€é”™è¯¯åˆ†ç±»ï¼ˆå“ªäº›é”™è¯¯è§¦å‘å›é€€ï¼Œå“ªäº›é”™è¯¯ä¸è§¦å‘ï¼‰ã€‚                                                                                                                                     |
| `tokenRefresh.ts`    | **æ¯ä¸ªæä¾›å•†**çš„ OAuth ä»¤ç‰Œåˆ·æ–°ï¼šGoogleï¼ˆGeminiã€Antigravityï¼‰ã€Claudeã€Codexã€Qwenã€iFlowã€GitHubï¼ˆOAuth + Copilot åŒä»¤ç‰Œï¼‰ã€Kiroï¼ˆAWS SSO OIDC + ç¤¾äº¤èº«ä»½éªŒè¯ï¼‰ã€‚åŒ…æ‹¬æ­£åœ¨è¿›è¡Œçš„æ‰¿è¯ºé‡å¤æ•°æ®åˆ é™¤ç¼“å­˜å’ŒæŒ‡æ•°é€€é¿é‡è¯•ã€‚                                        |
| `combo.ts`           | **ç»„åˆæ¨¡å‹**ï¼šåå¤‡æ¨¡å‹é“¾ã€‚å¦‚æœæ¨¡å‹ A å› ç¬¦åˆåå¤‡æ¡ä»¶çš„é”™è¯¯è€Œå¤±è´¥ï¼Œè¯·å°è¯•æ¨¡å‹ Bï¼Œç„¶åæ˜¯æ¨¡å‹ Cï¼Œç­‰ç­‰ã€‚è¿”å›å®é™…çš„ä¸Šæ¸¸çŠ¶æ€ä»£ç ã€‚                                                                                                                                  |
| `usage.ts`           | ä»æä¾›å•† API è·å–é…é¢/ä½¿ç”¨æ•°æ®ï¼ˆGitHub Copilot é…é¢ã€Antigravity æ¨¡å‹é…é¢ã€Codex é€Ÿç‡é™åˆ¶ã€Kiro ä½¿ç”¨ç»†åˆ†ã€Claude è®¾ç½®ï¼‰ã€‚                                                                                                                                    |
| `accountSelector.ts` | å…·æœ‰è¯„åˆ†ç®—æ³•çš„æ™ºèƒ½å¸æˆ·é€‰æ‹©ï¼šè€ƒè™‘ä¼˜å…ˆçº§ã€å¥åº·çŠ¶æ€ã€å¾ªç¯ä½ç½®å’Œå†·å´çŠ¶æ€ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚é€‰æ‹©æœ€ä½³å¸æˆ·ã€‚                                                                                                                                                               |
| `contextManager.ts`  | è¯·æ±‚ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šä½¿ç”¨å…ƒæ•°æ®ï¼ˆè¯·æ±‚ IDã€æ—¶é—´æˆ³ã€æä¾›ç¨‹åºä¿¡æ¯ï¼‰åˆ›å»ºå’Œè·Ÿè¸ªæ¯ä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä»¥è¿›è¡Œè°ƒè¯•å’Œæ—¥å¿—è®°å½•ã€‚                                                                                                                                      |
| `ipFilter.ts`        | åŸºäºIPçš„è®¿é—®æ§åˆ¶ï¼šæ”¯æŒç™½åå•å’Œé»‘åå•æ¨¡å¼ã€‚åœ¨å¤„ç† API è¯·æ±‚ä¹‹å‰æ ¹æ®é…ç½®çš„è§„åˆ™éªŒè¯å®¢æˆ·ç«¯ IPã€‚                                                                                                                                                                   |
| `sessionManager.ts`  | ä½¿ç”¨å®¢æˆ·ç«¯æŒ‡çº¹è¿›è¡Œä¼šè¯è·Ÿè¸ªï¼šä½¿ç”¨æ•£åˆ—å®¢æˆ·ç«¯æ ‡è¯†ç¬¦è·Ÿè¸ªæ´»åŠ¨ä¼šè¯ã€ç›‘è§†è¯·æ±‚è®¡æ•°å¹¶æä¾›ä¼šè¯æŒ‡æ ‡ã€‚                                                                                                                                                                   |
| `signatureCache.ts`  | åŸºäºè¯·æ±‚ç­¾åçš„é‡å¤æ•°æ®åˆ é™¤ç¼“å­˜ï¼šé€šè¿‡ç¼“å­˜æœ€è¿‘çš„è¯·æ±‚ç­¾åå¹¶åœ¨æ—¶é—´çª—å£å†…è¿”å›ç›¸åŒè¯·æ±‚çš„ç¼“å­˜å“åº”æ¥é˜²æ­¢é‡å¤è¯·æ±‚ã€‚                                                                                                                                                   |
| `systemPrompt.ts`    | å…¨å±€ç³»ç»Ÿæç¤ºæ³¨å…¥ï¼šåœ¨æ‰€æœ‰è¯·æ±‚ä¹‹å‰æˆ–é™„åŠ ä¸€ä¸ªå¯é…ç½®çš„ç³»ç»Ÿæç¤ºï¼Œå¹¶è¿›è¡Œæ¯ä¸ªæä¾›å•†çš„å…¼å®¹æ€§å¤„ç†ã€‚                                                                                                                                                                   |
| `thinkingBudget.ts`  | æ¨ç†ä»¤ç‰Œé¢„ç®—ç®¡ç†ï¼šæ”¯æŒç›´é€šã€è‡ªåŠ¨ï¼ˆæ¡å¸¦æ€ç»´é…ç½®ï¼‰ã€è‡ªå®šä¹‰ï¼ˆå›ºå®šé¢„ç®—ï¼‰å’Œè‡ªé€‚åº”ï¼ˆå¤æ‚åº¦ç¼©æ”¾ï¼‰æ¨¡å¼æ¥æ§åˆ¶æ€ç»´/æ¨ç†ä»¤ç‰Œã€‚                                                                                                                                          |
| `wildcardRouter.ts`  | é€šé…ç¬¦æ¨¡å‹æ¨¡å¼è·¯ç”±ï¼šæ ¹æ®å¯ç”¨æ€§å’Œä¼˜å…ˆçº§å°†é€šé…ç¬¦æ¨¡å¼ï¼ˆä¾‹å¦‚ `*/claude-*`ï¼‰è§£æä¸ºå…·ä½“çš„æä¾›è€…/æ¨¡å‹å¯¹ã€‚                                                                                                                                                           |

#### ä»¤ç‰Œåˆ·æ–°é‡å¤æ•°æ®åˆ é™¤

```mermaid
sequenceDiagram
    participant R1 as Request 1
    participant R2 as Request 2
    participant Cache as refreshPromiseCache
    participant OAuth as OAuth Provider

    R1->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: No in-flight promise
    Cache->>OAuth: Start refresh
    R2->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: Found in-flight promise
    Cache-->>R2: Return existing promise
    OAuth-->>Cache: New access token
    Cache-->>R1: New access token
    Cache-->>R2: Same access token (shared)
    Cache->>Cache: Delete cache entry
```

#### å¸æˆ·å›é€€çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> Active
    Active --> Error: Request fails (401/429/500)
    Error --> Cooldown: Apply backoff
    Cooldown --> Active: Cooldown expires
    Active --> Active: Request succeeds (reset backoff)

    state Error {
        [*] --> ClassifyError
        ClassifyError --> ShouldFallback: Rate limit / Auth / Transient
        ClassifyError --> NoFallback: 400 Bad Request
    }

    state Cooldown {
        [*] --> ExponentialBackoff
        ExponentialBackoff: Level 0 = 1s
        ExponentialBackoff: Level 1 = 2s
        ExponentialBackoff: Level 2 = 4s
        ExponentialBackoff: Max = 2min
    }
```

#### ç»„åˆæ¨¡å‹é“¾

```mermaid
flowchart LR
    A["Request with\ncombo model"] --> B["Model A"]
    B -->|"2xx Success"| C["Return response"]
    B -->|"429/401/500"| D{"Fallback\neligible?"}
    D -->|Yes| E["Model B"]
    D -->|No| F["Return error"]
    E -->|"2xx Success"| C
    E -->|"429/401/500"| G{"Fallback\neligible?"}
    G -->|Yes| H["Model C"]
    G -->|No| F
    H -->|"2xx Success"| C
    H -->|"Fail"| I["All failed â†’\nReturn last status"]
```

---

### 4.5 ç¿»è¯‘å™¨ (`open-sse/translator/`)

ä½¿ç”¨è‡ªæ³¨å†Œæ’ä»¶ç³»ç»Ÿçš„ **æ ¼å¼ç¿»è¯‘å¼•æ“**ã€‚

#### æ¶æ„

```mermaid
graph TD
    subgraph "Request Translation"
        A["Claude â†’ OpenAI"]
        B["Gemini â†’ OpenAI"]
        C["Antigravity â†’ OpenAI"]
        D["OpenAI Responses â†’ OpenAI"]
        E["OpenAI â†’ Claude"]
        F["OpenAI â†’ Gemini"]
        G["OpenAI â†’ Kiro"]
        H["OpenAI â†’ Cursor"]
    end

    subgraph "Response Translation"
        I["Claude â†’ OpenAI"]
        J["Gemini â†’ OpenAI"]
        K["Kiro â†’ OpenAI"]
        L["Cursor â†’ OpenAI"]
        M["OpenAI â†’ Claude"]
        N["OpenAI â†’ Antigravity"]
        O["OpenAI â†’ Responses"]
    end
```

| ç›®å½•         | æ–‡ä»¶     | æè¿°                                                                                                                                                                                                     |
| ------------ | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `request/`   | 8 ä½è¯‘å‘˜ | åœ¨æ ¼å¼ä¹‹é—´è½¬æ¢è¯·æ±‚æ­£æ–‡ã€‚æ¯ä¸ªæ–‡ä»¶åœ¨å¯¼å…¥æ—¶é€šè¿‡ `register(from, to, fn)` è‡ªè¡Œæ³¨å†Œã€‚                                                                                                                         |
| `response/`  | 7 åç¿»è¯‘ | åœ¨æ ¼å¼ä¹‹é—´è½¬æ¢æµå“åº”å—ã€‚å¤„ç† SSE äº‹ä»¶ç±»å‹ã€æ€ç»´å—ã€å·¥å…·è°ƒç”¨ã€‚                                                                                                                                            |
| `helpers/`   | 6 å¸®æ‰‹   | å…±äº«å®ç”¨ç¨‹åºï¼š`claudeHelper`ï¼ˆç³»ç»Ÿæç¤ºæå–ã€æ€è€ƒé…ç½®ï¼‰ã€`geminiHelper`ï¼ˆéƒ¨åˆ†/å†…å®¹æ˜ å°„ï¼‰ã€`openaiHelper`ï¼ˆæ ¼å¼è¿‡æ»¤ï¼‰ã€`toolCallHelper`ï¼ˆIDç”Ÿæˆã€ç¼ºå¤±å“åº”æ³¨å…¥ï¼‰ã€`maxTokensHelper`ã€`responsesApiHelper`ã€‚ |
| `index.ts`   | â€”        | ç¿»è¯‘å¼•æ“ï¼š`translateRequest()`ã€`translateResponse()`ã€çŠ¶æ€ç®¡ç†ã€æ³¨å†Œè¡¨ã€‚                                                                                                                                |
| `formats.ts` | â€”        | æ ¼å¼å¸¸é‡ï¼š`OPENAI`ã€`CLAUDE`ã€`GEMINI`ã€`ANTIGRAVITY`ã€`KIRO`ã€`CURSOR`ã€`OPENAI_RESPONSES`ã€‚                                                                                                            |

#### å…³é”®è®¾è®¡ï¼šè‡ªæ³¨å†Œæ’ä»¶

```javascript
// Each translator file calls register() on import:
import { register } from "../index.js";
register("claude", "openai", translateClaudeToOpenAI);

// The index.js imports all translator files, triggering registration:
import "./request/claude-to-openai.js"; // â† self-registers
```

---

### 4.6 å®ç”¨ç¨‹åº (`open-sse/utils/`)

| æ–‡ä»¶               | ç›®çš„                                                                                                                                                                                              |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `error.ts`         | é”™è¯¯å“åº”æ„å»ºï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰ã€ä¸Šæ¸¸é”™è¯¯è§£æã€ä»é”™è¯¯æ¶ˆæ¯ä¸­æå–åé‡åŠ›é‡è¯•æ—¶é—´ã€SSE é”™è¯¯æµã€‚                                                                                                       |
| `stream.ts`        | **SSE Transform Stream** â€” æ ¸å¿ƒæµç®¡é“ã€‚ä¸¤ç§æ¨¡å¼ï¼š`TRANSLATE`ï¼ˆå®Œæ•´æ ¼å¼ç¿»è¯‘ï¼‰å’Œ`PASSTHROUGH`ï¼ˆè§„èŒƒåŒ–+æå–ä½¿ç”¨ï¼‰ã€‚å¤„ç†å—ç¼“å†²ã€ä½¿ç”¨æƒ…å†µä¼°è®¡ã€å†…å®¹é•¿åº¦è·Ÿè¸ªã€‚æ¯ä¸ªæµç¼–ç å™¨/è§£ç å™¨å®ä¾‹é¿å…å…±äº«çŠ¶æ€ã€‚     |
| `streamHelpers.ts` | ä½çº§ SSE å®ç”¨ç¨‹åºï¼š`parseSSELine`ï¼ˆç©ºç™½å®¹å¿ï¼‰ã€`hasValuableContent`ï¼ˆè¿‡æ»¤ OpenAI/Claude/Gemini çš„ç©ºå—ï¼‰ã€`fixInvalidId`ã€`formatSSE`ï¼ˆå…·æœ‰ `perf_metrics` æ¸…ç†åŠŸèƒ½çš„æ ¼å¼æ„ŸçŸ¥ SSE åºåˆ—åŒ–ï¼‰ã€‚       |
| `usageTracking.ts` | ä»ä»»ä½•æ ¼å¼ï¼ˆClaude/OpenAI/Gemini/Responsesï¼‰æå–ä»¤ç‰Œä½¿ç”¨æƒ…å†µï¼Œä½¿ç”¨å•ç‹¬çš„å·¥å…·/æ¶ˆæ¯å­—ç¬¦/ä»¤ç‰Œæ¯”ç‡è¿›è¡Œä¼°è®¡ï¼Œç¼“å†²åŒºæ·»åŠ ï¼ˆ2000 ä¸ªä»¤ç‰Œå®‰å…¨è£•åº¦ï¼‰ï¼Œç‰¹å®šäºæ ¼å¼çš„å­—æ®µè¿‡æ»¤ï¼Œä½¿ç”¨ ANSI é¢œè‰²çš„æ§åˆ¶å°æ—¥å¿—è®°å½•ã€‚ |
| `requestLogger.ts` | åŸºäºæ–‡ä»¶çš„è¯·æ±‚æ—¥å¿—è®°å½•ï¼ˆé€šè¿‡ `ENABLE_REQUEST_LOGS=true` é€‰æ‹©åŠ å…¥ï¼‰ã€‚åˆ›å»ºåŒ…å«ç¼–å·æ–‡ä»¶çš„ä¼šè¯æ–‡ä»¶å¤¹ï¼š`1_req_client.json` â†’ `7_res_client.txt`ã€‚æ‰€æœ‰ I/O éƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆå³å‘å³å¼ƒï¼‰ã€‚å±è”½æ•æ„Ÿæ ‡å¤´ã€‚       |
| `bypassHandler.ts` | æ‹¦æˆªæ¥è‡ª Claude CLI çš„ç‰¹å®šæ¨¡å¼ï¼ˆæ ‡é¢˜æå–ã€é¢„çƒ­ã€è®¡æ•°ï¼‰å¹¶è¿”å›è™šå‡å“åº”ï¼Œè€Œæ— éœ€è°ƒç”¨ä»»ä½•æä¾›è€…ã€‚æ”¯æŒæµå¼ä¼ è¾“å’Œéæµå¼ä¼ è¾“ã€‚æœ‰æ„é™åˆ¶ä¸º Claude CLI èŒƒå›´ã€‚                                                |
| `networkProxy.ts`  | ä¼˜å…ˆè§£æç»™å®šæä¾›ç¨‹åºçš„å‡ºç«™ä»£ç† URLï¼šæä¾›ç¨‹åºç‰¹å®šçš„é…ç½® â†’ å…¨å±€é…ç½® â†’ ç¯å¢ƒå˜é‡ (`HTTPS_PROXY`/`HTTP_PROXY`/`ALL_PROXY`)ã€‚æ”¯æŒ `NO_PROXY` æ’é™¤ã€‚ç¼“å­˜é…ç½® 30 ç§’ã€‚                                     |

#### SSE æµåª’ä½“ç®¡é“

```mermaid
flowchart TD
    A["Provider SSE stream"] --> B["TextDecoder\n(per-stream instance)"]
    B --> C["Buffer lines\n(split on newline)"]
    C --> D["parseSSELine()\n(trim whitespace, parse JSON)"]
    D --> E{"Mode?"}
    E -->|TRANSLATE| F["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E -->|PASSTHROUGH| G["fixInvalidId()\nnormalize chunk"]
    F --> H["hasValuableContent()\nfilter empty chunks"]
    G --> H
    H -->|"Has content"| I["extractUsage()\ntrack token counts"]
    H -->|"Empty"| J["Skip chunk"]
    I --> K["formatSSE()\nserialize + clean perf_metrics"]
    K --> L["TextEncoder\n(per-stream instance)"]
    L --> M["Enqueue to\nclient stream"]

    style A fill:#f9f,stroke:#333
    style M fill:#9f9,stroke:#333
```

#### è¯·æ±‚è®°å½•å™¨ä¼šè¯ç»“æ„

```
logs/
â””â”€â”€ claude_gemini_claude-sonnet_20260208_143045/
    â”œâ”€â”€ 1_req_client.json      â† Raw client request
    â”œâ”€â”€ 2_req_source.json      â† After initial conversion
    â”œâ”€â”€ 3_req_openai.json      â† OpenAI intermediate format
    â”œâ”€â”€ 4_req_target.json      â† Final target format
    â”œâ”€â”€ 5_res_provider.txt     â† Provider SSE chunks (streaming)
    â”œâ”€â”€ 5_res_provider.json    â† Provider response (non-streaming)
    â”œâ”€â”€ 6_res_openai.txt       â† OpenAI intermediate chunks
    â”œâ”€â”€ 7_res_client.txt       â† Client-facing SSE chunks
    â””â”€â”€ 6_error.json           â† Error details (if any)
```

---

### 4.7 åº”ç”¨å±‚ (`src/`)

| ç›®å½•          | ç›®çš„                                                     |
| ------------- | -------------------------------------------------------- |
| `src/app/`    | Web UIã€API è·¯ç”±ã€Express ä¸­é—´ä»¶ã€OAuth å›è°ƒå¤„ç†ç¨‹åº     |
| `src/lib/`    | æ•°æ®åº“è®¿é—®ï¼ˆ`localDb.ts`ã€`usageDb.ts`ï¼‰ã€èº«ä»½éªŒè¯ã€å…±äº« |
| `src/mitm/`   | ç”¨äºæ‹¦æˆªæä¾›å•†æµé‡çš„ä¸­é—´äººä»£ç†å®ç”¨ç¨‹åº                   |
| `src/models/` | æ•°æ®åº“æ¨¡å‹å®šä¹‰                                           |
| `src/shared/` | open-sse å‡½æ•°ï¼ˆæä¾›ç¨‹åºã€æµã€é”™è¯¯ç­‰ï¼‰çš„åŒ…è£…å™¨            |
| `src/sse/`    | å°† open-sse åº“è¿æ¥åˆ° Express è·¯ç”±çš„ SSE ç«¯ç‚¹å¤„ç†ç¨‹åº     |
| `src/store/`  | åº”ç”¨çŠ¶æ€ç®¡ç†                                             |

#### å€¼å¾—æ³¨æ„çš„ API è·¯ç”±

| è·¯çº¿                                          | æ–¹æ³•           | ç›®çš„                                                         |
| --------------------------------------------- | -------------- | ------------------------------------------------------------ |
| `/api/provider-models`                        | è·å–/å‘å¸ƒ/åˆ é™¤ | é’ˆå¯¹æ¯ä¸ªæä¾›å•†çš„è‡ªå®šä¹‰æ¨¡å‹çš„ CRUD                            |
| `/api/models/catalog`                         | è·å–           | æŒ‰æä¾›å•†åˆ†ç»„çš„æ‰€æœ‰æ¨¡å‹ï¼ˆèŠå¤©ã€åµŒå…¥ã€å›¾åƒã€è‡ªå®šä¹‰ï¼‰çš„èšåˆç›®å½• |
| `/api/settings/proxy`                         | è·å–/æ”¾ç½®/åˆ é™¤ | åˆ†å±‚å‡ºç«™ä»£ç†é…ç½® (`global/providers/combos/keys`)            |
| `/api/settings/proxy/test`                    | å‘å¸ƒ           | éªŒè¯ä»£ç†è¿æ¥å¹¶è¿”å›å…¬å…± IP/å»¶è¿Ÿ                               |
| `/v1/providers/[provider]/chat/completions`   | å‘å¸ƒ           | é€šè¿‡æ¨¡å‹éªŒè¯å®Œæˆæ¯ä¸ªæä¾›å•†çš„ä¸“ç”¨èŠå¤©                         |
| `/v1/providers/[provider]/embeddings`         | å‘å¸ƒ           | å…·æœ‰æ¨¡å‹éªŒè¯åŠŸèƒ½çš„ä¸“ç”¨æ¯ä¸ªæä¾›å•†åµŒå…¥                         |
| `/v1/providers/[provider]/images/generations` | å‘å¸ƒ           | é€šè¿‡æ¨¡å‹éªŒè¯ç”Ÿæˆä¸“ç”¨çš„æ¯ä¸ªæä¾›å•†å›¾åƒ                         |
| `/api/settings/ip-filter`                     | è·å–/æ”¾ç½®      | IP å…è®¸åˆ—è¡¨/é˜»æ­¢åˆ—è¡¨ç®¡ç†                                     |
| `/api/settings/thinking-budget`               | è·å–/æ”¾ç½®      | æ¨ç†ä»£å¸é¢„ç®—é…ç½®ï¼ˆç›´é€š/è‡ªåŠ¨/è‡ªå®šä¹‰/è‡ªé€‚åº”ï¼‰                  |
| `/api/settings/system-prompt`                 | è·å–/æ”¾ç½®      | æ‰€æœ‰è¯·æ±‚çš„å…¨å±€ç³»ç»Ÿæç¤ºæ³¨å…¥                                   |
| `/api/sessions`                               | è·å–           | æ´»åŠ¨ä¼šè¯è·Ÿè¸ªå’ŒæŒ‡æ ‡                                           |
| `/api/rate-limits`                            | è·å–           | æ¯ä¸ªå¸æˆ·çš„é€Ÿç‡é™åˆ¶çŠ¶æ€                                       |

---

## 5. å…³é”®è®¾è®¡æ¨¡å¼

### 5.1 è½´è¾å¼ç¿»è¯‘

æ‰€æœ‰æ ¼å¼å‡é€šè¿‡ **OpenAI æ ¼å¼ä½œä¸ºä¸­å¿ƒ**è¿›è¡Œè½¬æ¢ã€‚æ·»åŠ æ–°çš„æä¾›è€…åªéœ€è¦ç¼–å†™**ä¸€å¯¹**ç¿»è¯‘å™¨ï¼ˆåˆ°/æ¥è‡ª OpenAIï¼‰ï¼Œè€Œä¸æ˜¯ N å¯¹ã€‚

### 5.2 æ‰§è¡Œè€…ç­–ç•¥æ¨¡å¼

æ¯ä¸ªæä¾›è€…éƒ½æœ‰ä¸€ä¸ªç»§æ‰¿è‡ª `BaseExecutor` çš„ä¸“ç”¨æ‰§è¡Œå™¨ç±»ã€‚ `executors/index.ts` ä¸­çš„å·¥å‚åœ¨è¿è¡Œæ—¶é€‰æ‹©æ­£ç¡®çš„ä¸€ä¸ªã€‚

### 5.3 è‡ªæ³¨å†Œæ’ä»¶ç³»ç»Ÿ

ç¿»è¯‘å™¨æ¨¡å—åœ¨å¯¼å…¥æ—¶é€šè¿‡ `register()` æ³¨å†Œè‡ªèº«ã€‚æ·»åŠ æ–°ç¿»è¯‘å™¨åªæ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶å°†å…¶å¯¼å…¥ã€‚

### 5.4 å…·æœ‰æŒ‡æ•°é€€é¿çš„è´¦æˆ·å›é€€

å½“æä¾›è€…è¿”å› 429/401/500 æ—¶ï¼Œç³»ç»Ÿå¯ä»¥åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¸æˆ·ï¼Œåº”ç”¨æŒ‡æ•°å†·å´æ—¶é—´ï¼ˆ1 ç§’ â†’ 2 ç§’ â†’ 4 ç§’ â†’ æœ€é•¿ 2 åˆ†é’Ÿï¼‰ã€‚

### 5.5 ç»„åˆæ¨¡å‹é“¾

â€œç»„åˆâ€å°†å¤šä¸ª `provider/model` å­—ç¬¦ä¸²ç»„åˆåœ¨ä¸€èµ·ã€‚å¦‚æœç¬¬ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™è‡ªåŠ¨å›é€€åˆ°ä¸‹ä¸€ä¸ªã€‚

### 5.6 æœ‰çŠ¶æ€æµå¼ç¿»è¯‘

å“åº”ç¿»è¯‘é€šè¿‡ `initState()` æœºåˆ¶ç»´æŠ¤è·¨ SSE å—çš„çŠ¶æ€ï¼ˆæ€ç»´å—è·Ÿè¸ªã€å·¥å…·è°ƒç”¨ç§¯ç´¯ã€å†…å®¹å—ç´¢å¼•ï¼‰ã€‚

### 5.7 ä½¿ç”¨å®‰å…¨ç¼“å†²åŒº

åœ¨æŠ¥å‘Šçš„ä½¿ç”¨æƒ…å†µä¸­æ·»åŠ äº† 2000 ä¸ªä»¤ç‰Œç¼“å†²åŒºï¼Œä»¥é˜²æ­¢å®¢æˆ·ç«¯ç”±äºç³»ç»Ÿæç¤ºå’Œæ ¼å¼è½¬æ¢çš„å¼€é”€è€Œè¾¾åˆ°ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ã€‚

---

## 6. æ”¯æŒçš„æ ¼å¼

| æ ¼å¼            | æ–¹å‘      | æ ‡è¯†ç¬¦             |
| --------------- | --------- | ------------------ |
| OpenAI èŠå¤©å®Œæˆ | æ¥æº+ç›®æ ‡ | `openai`           |
| OpenAI å“åº” API | æ¥æº+ç›®æ ‡ | `openai-responses` |
| äººç±»å…‹åŠ³å¾·      | æ¥æº+ç›®æ ‡ | `claude`           |
| è°·æ­ŒåŒå­åº§      | æ¥æº+ç›®æ ‡ | `gemini`           |
| è°·æ­Œ Gemini CLI | ä»…ç›®æ ‡    | `gemini-cli`       |
| åé‡åŠ›          | æ¥æº+ç›®æ ‡ | `antigravity`      |
| AWS åŸºç½—        | AWSä»…ç›®æ ‡ | `kiro`             |
| å…‰æ ‡            | ä»…ç›®æ ‡    | `cursor`           |

---

## 7. æ”¯æŒçš„æä¾›å•†

| ä¾›åº”å•†                   | è®¤è¯æ–¹å¼             | æ‰§è¡Œäºº    | è¦ç‚¹                              |
| ------------------------ | -------------------- | --------- | --------------------------------- |
| äººç±»å…‹åŠ³å¾·               | API å¯†é’¥æˆ– OAuth     | é»˜è®¤      | ä½¿ç”¨ `x-api-key` æ ‡å¤´             |
| è°·æ­ŒåŒå­åº§               | API å¯†é’¥æˆ– OAuth     | é»˜è®¤      | ä½¿ç”¨ `x-goog-api-key` æ ‡å¤´        |
| è°·æ­Œ Gemini CLI          | OAuth                | GeminiCLI | ä½¿ç”¨ `streamGenerateContent` ç«¯ç‚¹ |
| åé‡åŠ›                   | OAuth                | åé‡åŠ›    | å¤š URL å›é€€ã€è‡ªå®šä¹‰é‡è¯•è§£æ       |
| å¼€æ”¾äººå·¥æ™ºèƒ½             | API å¯†é’¥             | é»˜è®¤      | æ ‡å‡†æŒæœ‰è€…èº«ä»½éªŒè¯                |
| æ³•å…¸                     | OAuth                | æ³•å…¸      | æ³¨å…¥ç³»ç»ŸæŒ‡ä»¤ï¼Œç®¡ç†æ€ç»´            |
| GitHub å‰¯é©¾é©¶            | OAuth + Copilot ä»¤ç‰Œ | GitHub    | åŒä»¤ç‰Œï¼ŒVSCode æ ‡å¤´æ¨¡ä»¿           |
| åŸºç½— (AWS)               | AWS SSO OIDC æˆ–ç¤¾äº¤  | åŸºç½—      | äºŒè¿›åˆ¶EventStreamè§£æ             |
| å…‰æ ‡IDE                  | æ ¡éªŒå’ŒéªŒè¯           | å…‰æ ‡      | Protobuf ç¼–ç ã€SHA-256 æ ¡éªŒå’Œ     |
| å¥æ–‡                     | OAuth                | é»˜è®¤      | æ ‡å‡†æˆæƒ                          |
| iFlow                    | OAuthï¼ˆåŸºæœ¬ + æ‰¿è½½ï¼‰ | é»˜è®¤      | åŒé‡èº«ä»½éªŒè¯æ ‡å¤´                  |
| å¼€æ”¾è·¯ç”±å™¨               | API å¯†é’¥             | é»˜è®¤      | æ ‡å‡†æŒæœ‰è€…èº«ä»½éªŒè¯                |
| GLMã€Kimiã€MiniMax       | API å¯†é’¥             | é»˜è®¤      | å…‹åŠ³å¾·å…¼å®¹ï¼Œä½¿ç”¨ `x-api-key`      |
| `openai-compatible-*`    | API å¯†é’¥             | é»˜è®¤      | åŠ¨æ€ï¼šä»»ä½• OpenAI å…¼å®¹ç«¯ç‚¹        |
| `anthropic-compatible-*` | API å¯†é’¥             | é»˜è®¤      | åŠ¨æ€ï¼šä»»ä½•ä¸ Claude å…¼å®¹çš„ç«¯ç‚¹    |

---

## 8. æ•°æ®æµæ€»ç»“

### æµåª’ä½“è¯·æ±‚

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor\nbuildUrl + buildHeaders"]
    D --> E["fetch(providerURL)"]
    E --> F["createSSEStream()\nTRANSLATE mode"]
    F --> G["parseSSELine()"]
    G --> H["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    H --> I["extractUsage()\n+ addBuffer"]
    I --> J["formatSSE()"]
    J --> K["Client receives\ntranslated SSE"]
    K --> L["logUsage()\nsaveRequestUsage()"]
```

### éæµå¼è¯·æ±‚

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor.execute()"]
    D --> E["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E --> F["Return JSON\nresponse"]
```

### æ—è·¯æµç¨‹ï¼ˆClaude CLIï¼‰

```mermaid
flowchart LR
    A["Claude CLI request"] --> B{"Match bypass\npattern?"}
    B -->|"Title/Warmup/Count"| C["Generate fake\nOpenAI response"]
    B -->|"No match"| D["Normal flow"]
    C --> E["Translate to\nsource format"]
    E --> F["Return without\ncalling provider"]
```
