# omniroute â€” ×ª×™×¢×•×“ ×‘×¡×™×¡ ×§×•×“

ğŸŒ **Languages:** ğŸ‡ºğŸ‡¸ [English](../../CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡· [PortuguÃªs (Brasil)](../pt-BR/CODEBASE_DOCUMENTATION.md) | ğŸ‡ªğŸ‡¸ [EspaÃ±ol](../es/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡· [FranÃ§ais](../fr/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡¹ [Italiano](../it/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡º [Ğ ÑƒÑÑĞºĞ¸Ğ¹](../ru/CODEBASE_DOCUMENTATION.md) | ğŸ‡¨ğŸ‡³ [ä¸­æ–‡ (ç®€ä½“)](../zh-CN/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡ª [Deutsch](../de/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡³ [à¤¹à¤¿à¤¨à¥à¤¦à¥€](../in/CODEBASE_DOCUMENTATION.md) | ğŸ‡¹ğŸ‡­ [à¹„à¸—à¸¢](../th/CODEBASE_DOCUMENTATION.md) | ğŸ‡ºğŸ‡¦ [Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°](../uk-UA/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡¦ [Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©](../ar/CODEBASE_DOCUMENTATION.md) | ğŸ‡¯ğŸ‡µ [æ—¥æœ¬èª](../ja/CODEBASE_DOCUMENTATION.md) | ğŸ‡»ğŸ‡³ [Tiáº¿ng Viá»‡t](../vi/CODEBASE_DOCUMENTATION.md) | ğŸ‡§ğŸ‡¬ [Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸](../bg/CODEBASE_DOCUMENTATION.md) | ğŸ‡©ğŸ‡° [Dansk](../da/CODEBASE_DOCUMENTATION.md) | ğŸ‡«ğŸ‡® [Suomi](../fi/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡± [×¢×‘×¨×™×ª](../he/CODEBASE_DOCUMENTATION.md) | ğŸ‡­ğŸ‡º [Magyar](../hu/CODEBASE_DOCUMENTATION.md) | ğŸ‡®ğŸ‡© [Bahasa Indonesia](../id/CODEBASE_DOCUMENTATION.md) | ğŸ‡°ğŸ‡· [í•œêµ­ì–´](../ko/CODEBASE_DOCUMENTATION.md) | ğŸ‡²ğŸ‡¾ [Bahasa Melayu](../ms/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡± [Nederlands](../nl/CODEBASE_DOCUMENTATION.md) | ğŸ‡³ğŸ‡´ [Norsk](../no/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡¹ [PortuguÃªs (Portugal)](../pt/CODEBASE_DOCUMENTATION.md) | ğŸ‡·ğŸ‡´ [RomÃ¢nÄƒ](../ro/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡± [Polski](../pl/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡° [SlovenÄina](../sk/CODEBASE_DOCUMENTATION.md) | ğŸ‡¸ğŸ‡ª [Svenska](../sv/CODEBASE_DOCUMENTATION.md) | ğŸ‡µğŸ‡­ [Filipino](../phi/CODEBASE_DOCUMENTATION.md)

> ××“×¨×™×š ××§×™×£ ×•×™×“×™×“×•×ª×™ ×œ××ª×—×™×œ×™× ×œ× ×ª×‘ ×”-Proxy **omniroute** ××¨×•×‘×” ×¡×¤×§×™ AI.

---

## 1. ××”×• omnirroute?

omniroute ×”×•× **× ×ª×‘ ×¤×¨×•×§×¡×™** ×©×™×•×©×‘ ×‘×™×Ÿ ×œ×§×•×—×•×ª AI (×§×œ×•×“ CLI, Codex, Cursor IDE ×•×›×•') ×•×¡×¤×§×™ AI (Anthropic, Google, OpenAI, AWS, GitHub ×•×›×•'). ×–×” ×¤×•×ª×¨ ×‘×¢×™×” ××—×ª ×’×“×•×œ×”:

> **×œ×§×•×—×•×ª AI ×©×•× ×™× ××“×‘×¨×™× "×©×¤×•×ª" ×©×•× ×•×ª (×¤×•×¨××˜×™× ×©×œ API), ×•×¡×¤×§×™ AI ×©×•× ×™× ××¦×¤×™× ×’× ×œ"×©×¤×•×ª" ×©×•× ×•×ª.** omniroute ××ª×¨×’× ×‘×™× ×™×”× ×‘××•×¤×Ÿ ××•×˜×•××˜×™.

×ª×—×©×•×‘ ×¢×œ ×–×” ×›××• ××ª×¨×’× ××•× ×™×‘×¨×¡×œ×™ ×‘××•"× - ×›×œ × ×¦×™×’ ×™×›×•×œ ×œ×“×‘×¨ ×›×œ ×©×¤×”, ×•×”××ª×¨×’× ×××™×¨ ××•×ª×• ×¢×‘×•×¨ ×›×œ × ×¦×™×’ ××—×¨.

---

## 2. ×¡×§×™×¨×ª ××“×¨×™×›×œ×•×ª

```mermaid
graph LR
    subgraph Clients
        A[Claude CLI]
        B[Codex]
        C[Cursor IDE]
        D[OpenAI-compatible]
    end

    subgraph omniroute
        E[Handler Layer]
        F[Translator Layer]
        G[Executor Layer]
        H[Services Layer]
    end

    subgraph Providers
        I[Anthropic Claude]
        J[Google Gemini]
        K[OpenAI / Codex]
        L[GitHub Copilot]
        M[AWS Kiro]
        N[Antigravity]
        O[Cursor API]
    end

    A --> E
    B --> E
    C --> E
    D --> E
    E --> F
    F --> G
    G --> I
    G --> J
    G --> K
    G --> L
    G --> M
    G --> N
    G --> O
    H -.-> E
    H -.-> G
```

### ×¢×§×¨×•×Ÿ ×œ×™×‘×”: ×ª×¨×’×•× ×¨×›×–×ª ×•×“×™×‘×•×¨

×›×œ ×ª×¨×’×•× ×”×¤×•×¨××˜ ×¢×•×‘×¨ ×“×¨×š **×¤×•×¨××˜ OpenAI ×›××¨×›×–**:

```
Client Format â†’ [OpenAI Hub] â†’ Provider Format    (request)
Provider Format â†’ [OpenAI Hub] â†’ Client Format    (response)
```

×”××©××¢×•×ª ×”×™× ×©××ª×” ×¦×¨×™×š ×¨×§ **N ××ª×¨×’××™×** (××—×“ ×œ×›×œ ×¤×•×¨××˜) ×‘××§×•× **NÂ²** (×›×œ ×–×•×’).

---

## 3. ××‘× ×” ×”×¤×¨×•×™×§×˜

```
omniroute/
â”œâ”€â”€ open-sse/                  â† Core proxy library (portable, framework-agnostic)
â”‚   â”œâ”€â”€ index.js               â† Main entry point, exports everything
â”‚   â”œâ”€â”€ config/                â† Configuration & constants
â”‚   â”œâ”€â”€ executors/             â† Provider-specific request execution
â”‚   â”œâ”€â”€ handlers/              â† Request handling orchestration
â”‚   â”œâ”€â”€ services/              â† Business logic (auth, models, fallback, usage)
â”‚   â”œâ”€â”€ translator/            â† Format translation engine
â”‚   â”‚   â”œâ”€â”€ request/           â† Request translators (8 files)
â”‚   â”‚   â”œâ”€â”€ response/          â† Response translators (7 files)
â”‚   â”‚   â””â”€â”€ helpers/           â† Shared translation utilities (6 files)
â”‚   â””â”€â”€ utils/                 â† Utility functions
â”œâ”€â”€ src/                       â† Application layer (Express/Worker runtime)
â”‚   â”œâ”€â”€ app/                   â† Web UI, API routes, middleware
â”‚   â”œâ”€â”€ lib/                   â† Database, auth, and shared library code
â”‚   â”œâ”€â”€ mitm/                  â† Man-in-the-middle proxy utilities
â”‚   â”œâ”€â”€ models/                â† Database models
â”‚   â”œâ”€â”€ shared/                â† Shared utilities (wrappers around open-sse)
â”‚   â”œâ”€â”€ sse/                   â† SSE endpoint handlers
â”‚   â””â”€â”€ store/                 â† State management
â”œâ”€â”€ data/                      â† Runtime data (credentials, logs)
â”‚   â””â”€â”€ provider-credentials.json   (external credentials override, gitignored)
â””â”€â”€ tester/                    â† Test utilities
```

---

## 4. ×¤×™×¨×•×˜ ××•×“×•×œ ××—×¨ ××•×“×•×œ

### 4.1 Config (`open-sse/config/`)

**××§×•×¨ ×”×××ª ×”×™×—×™×“** ×œ×›×œ ×ª×¦×•×¨×ª ×”×¡×¤×§×™×.

| ×§×•×‘×¥                          | ××˜×¨×”                                                                                                                                                                                                           |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `constants.ts`                | ××•×‘×™×™×§×˜ `PROVIDERS` ×¢× ×›×ª×•×‘×•×ª URL ×‘×¡×™×¡×™×•×ª, ××™×©×•×¨×™ OAuth (×‘×¨×™×¨×ª ××—×“×œ), ×›×•×ª×¨×•×ª ×•×”× ×—×™×•×ª ××¢×¨×›×ª ×‘×¨×™×¨×ª ××—×“×œ ×¢×‘×•×¨ ×›×œ ×¡×¤×§. ××’×“×™×¨ ×’× ××ª `HTTP_STATUS`, `ERROR_TYPES`, `COOLDOWN_MS`, `BACKOFF_CONFIG` ×•`SKIP_PATTERNS`. |
| `credentialLoader.ts`         | ×˜×•×¢×Ÿ ××™×©×•×¨×™× ×—×™×¦×•× ×™×™× ×-`data/provider-credentials.json` ×•×××–×’ ××•×ª× ×¢×œ ×¤× ×™ ×‘×¨×™×¨×•×ª ×”××—×“×œ ×”××§×•×“×“×•×ª ×‘-`PROVIDERS`. ×©×•××¨ ×¡×•×“×•×ª ××—×•×¥ ×œ×©×œ×™×˜×ª ×”××§×•×¨ ×ª×•×š ×©××™×¨×” ×¢×œ ×ª××™××•×ª ×œ××—×•×¨.                                        |
| `providerModels.ts`           | ×¨×™×©×•× ××•×“×œ×™× ××¨×›×–×™: ×›×™× ×•×™×™× ×©×œ ×¡×¤×§×™ ××¤×•×ª â†’ ××–×”×™ ××•×“×œ. ×¤×•× ×§×¦×™×•×ª ×›××• `getModels()`, `getProviderByAlias()`.                                                                                                      |
| `codexInstructions.ts`        | ×”×•×¨××•×ª ××¢×¨×›×ª ×©×”×•×–×¨×§×• ×œ×‘×§×©×•×ª Codex (××™×œ×•×¦×™ ×¢×¨×™×›×”, ×›×œ×œ×™ ××¨×’×– ×—×•×œ, ××“×™× ×™×•×ª ××™×©×•×¨).                                                                                                                                |
| `defaultThinkingSignature.ts` | ×‘×¨×™×¨×ª ×”××—×“×œ ×©×œ ×—×ª×™××•×ª "×—×©×™×‘×”" ×¢×‘×•×¨ ×“×’××™ ×§×œ×•×“ ×•×’'××™× ×™.                                                                                                                                                          |
| `ollamaModels.ts`             | ×”×’×“×¨×ª ×¡×›××” ×œ××•×“×œ×™× ××§×•××™×™× ×©×œ ××•×œ××” (×©×, ×’×•×“×œ, ××©×¤×—×”, ×›×™××•×ª).                                                                                                                                                  |

#### ×–×¨×™××ª ×˜×¢×™× ×ª ××™×©×•×¨×™×

```mermaid
flowchart TD
    A["App starts"] --> B["constants.ts defines PROVIDERS\nwith hardcoded defaults"]
    B --> C{"data/provider-credentials.json\nexists?"}
    C -->|Yes| D["credentialLoader reads JSON"]
    C -->|No| E["Use hardcoded defaults"]
    D --> F{"For each provider in JSON"}
    F --> G{"Provider exists\nin PROVIDERS?"}
    G -->|No| H["Log warning, skip"]
    G -->|Yes| I{"Value is object?"}
    I -->|No| J["Log warning, skip"]
    I -->|Yes| K["Merge clientId, clientSecret,\ntokenUrl, authUrl, refreshUrl"]
    K --> F
    H --> F
    J --> F
    F -->|Done| L["PROVIDERS ready with\nmerged credentials"]
    E --> L
```

---

### 4.2 ××‘×¦×¢×™× (`open-sse/executors/`)

××‘×¦×¢×™× ×¢×•×˜×¤×™× **×”×™×’×™×•×Ÿ ×¡×¤×¦×™×¤×™ ×œ×¡×¤×§** ×‘×××¦×¢×•×ª **×“×¤×•×¡ ×”××¡×˜×¨×˜×’×™×”**. ×›×œ ××‘×¦×¢ ×¢×•×§×£ ××ª ×©×™×˜×•×ª ×”×‘×¡×™×¡ ×œ×¤×™ ×”×¦×•×¨×š.

```mermaid
classDiagram
    class BaseExecutor {
        +buildUrl(model, stream, options)
        +buildHeaders(credentials, stream, body)
        +transformRequest(body, model, stream, credentials)
        +execute(url, options)
        +shouldRetry(status, error)
        +refreshCredentials(credentials, log)
    }

    class DefaultExecutor {
        +refreshCredentials()
    }

    class AntigravityExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +shouldRetry()
        +refreshCredentials()
    }

    class CursorExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseResponse()
        +generateChecksum()
    }

    class KiroExecutor {
        +buildUrl()
        +buildHeaders()
        +transformRequest()
        +parseEventStream()
        +refreshCredentials()
    }

    BaseExecutor <|-- DefaultExecutor
    BaseExecutor <|-- AntigravityExecutor
    BaseExecutor <|-- CursorExecutor
    BaseExecutor <|-- KiroExecutor
    BaseExecutor <|-- CodexExecutor
    BaseExecutor <|-- GeminiCLIExecutor
    BaseExecutor <|-- GithubExecutor
```

| ××•×¦×™× ×œ×¤×•×¢×œ      | ×¡×¤×§                                      | ×”×ª××—×•×™×•×ª ××¤×ª×—                                                                                                        |
| ---------------- | ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `base.ts`        | â€”                                        | ×‘×¡×™×¡ ×ª×§×¦×™×¨: ×‘× ×™×™×ª ×›×ª×•×‘×ª URL, ×›×•×ª×¨×•×ª, ×”×’×™×•×Ÿ × ×™×¡×™×•×Ÿ ×—×•×–×¨, ×¨×¢× ×•×Ÿ ××™×©×•×¨×™×                                                |
| `default.ts`     | ×§×œ×•×“, ×’'××™× ×™, OpenAI, GLM, Kimi, MiniMax | ×¨×¢× ×•×Ÿ ××¡×™××•×Ÿ OAuth ×›×œ×œ×™ ×¢×‘×•×¨ ×¡×¤×§×™× ×¡×˜× ×“×¨×˜×™×™×                                                                         |
| `antigravity.ts` | Google Cloud Code                        | ×™×¦×™×¨×ª ××–×”×” ×¤×¨×•×™×§×˜/×”×¤×¢×œ×”, × ×™×ª×•×§ ×¨×‘ ×©×œ ×›×ª×•×‘×•×ª ××ª×¨×™×, × ×™×¡×™×•×Ÿ ×—×•×–×¨ ××•×ª×× ××™×©×™×ª ×œ× ×ª×— ××”×•×“×¢×•×ª ×©×’×™××” ("××™×¤×•×¡ ×œ××—×¨ 2h7m23s") |
| `cursor.ts`      | ×”×¡××Ÿ IDE                                 | **×”××•×¨×›×‘×™× ×‘×™×•×ª×¨**: SHA-256 checksum auth, ×§×™×“×•×“ ×‘×§×©×ª Protobuf, EventStream ×‘×™× ××¨×™ â†’ × ×™×ª×•×— ×ª×’×•×‘×ª SSE                 |
| `codex.ts`       | OpenAI Codex                             | ××–×¨×™×§ ×”×•×¨××•×ª ××¢×¨×›×ª, ×× ×”×œ ×¨××•×ª ×—×©×™×‘×”, ××¡×™×¨ ×¤×¨××˜×¨×™× ×œ× × ×ª××›×™×                                                          |
| `gemini-cli.ts`  | Google Gemini CLI                        | ×‘× ×™×™×ª ×›×ª×•×‘×ª ××ª×¨ ××•×ª×××ª ××™×©×™×ª (`streamGenerateContent`), ×¨×¢× ×•×Ÿ ××¡×™××•×Ÿ OAuth ×©×œ Google                                 |
| `github.ts`      | GitHub Copilot                           | ××¢×¨×›×ª ××¡×™××•×Ÿ ×›×¤×•×œ (GitHub OAuth + Token Copilot), ×—×™×§×•×™ ×›×•×ª×¨×ª VSCode                                                 |
| `kiro.ts`        | AWS CodeWhisperer                        | × ×™×ª×•×— ×‘×™× ××¨×™ ×©×œ AWS EventStream, ××¡×’×¨×•×ª ××™×¨×•×¢×™ AMZN, ×”×¢×¨×›×ª ××¡×™××•×Ÿ                                                    |
| `index.ts`       | â€”                                        | ××¤×¢×œ: ×©× ×¡×¤×§ ××¤×•×ª â†’ ××—×œ×§×ª executor, ×¢× ×‘×¨×™×¨×ª ××—×“×œ                                                                    |

---

### 4.3 ××˜×¤×œ×™× (`open-sse/handlers/`)

**×©×›×‘×ª ×”×ª×–××•×¨** - ××ª×××ª ×ª×¨×’×•×, ×‘×™×¦×•×¢, ×¡×˜×¨×™××™× ×’ ×•×˜×™×¤×•×œ ×‘×©×’×™××•×ª.

| ×§×•×‘×¥                  | ××˜×¨×”                                                                                                                                                                    |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `chatCore.ts`         | **××ª×–××¨ ××¨×›×–×™** (~600 ×©×•×¨×•×ª). ××˜×¤×œ ×‘××—×–×•×¨ ×”×—×™×™× ×”××œ× ×©×œ ×”×‘×§×©×”: ×–×™×”×•×™ ×¤×•×¨××˜ â† ×ª×¨×’×•× â† ×©×œ×™×—×ª ××‘×¦×¢ â† ×ª×’×•×‘×ª ×¡×˜×¨×™××™× ×’/×œ× ×–×¨×™××” â† ×¨×¢× ×•×Ÿ ××¡×™××•×Ÿ â† ×˜×™×¤×•×œ ×‘×©×’×™××•×ª â† ×¨×™×©×•× ×©×™××•×©. |
| `responsesHandler.ts` | ××ª×× ×¢×‘×•×¨ ×”-API ×©×œ ×ª×’×•×‘×•×ª ×©×œ OpenAI: ×××™×¨ ×¤×•×¨××˜ ×ª×’×•×‘×•×ª â† ×”×©×œ××•×ª ×¦'××˜ â† ×©×•×œ×— ×œ-`chatCore` â†’ ×××™×¨ SSE ×‘×—×–×¨×” ×œ×¤×•×¨××˜ ×ª×’×•×‘×•×ª.                                                |
| `embeddings.ts`       | ××˜×¤×œ ×‘×™×¦×™×¨×ª ×”×˜×‘×¢×”: ×¤×•×ª×¨ ××•×“×œ ×”×˜××¢×” â†’ ×¡×¤×§, ×©×•×œ×— ×œ×¡×¤×§ API, ××—×–×™×¨ ×ª×’×•×‘×ª ×”×˜×‘×¢×” ×ª×•×××ª OpenAI. ×ª×•××š ×‘-6 ×¡×¤×§×™× ×•××¢×œ×”.                                                          |
| `imageGeneration.ts`  | ××˜×¤×œ ×‘×”×¤×§×ª ×ª××•× ×”: ×¤×•×ª×¨ ××ª ××•×“×œ ×”×ª××•× ×” â†’ ×¡×¤×§, ×ª×•××š ×‘××¦×‘×™ OpenAI, ×ª××•× ×ª ×ª××•××™× (×× ×˜×™ ×›×‘×™×“×”) ×•-Nebius. ××—×–×™×¨×” ×ª××•× ×•×ª base64 ××• ×›×ª×•×‘×ª URL.                                  |

#### ××—×–×•×¨ ×—×™×™× ×©×œ ×‘×§×©×” (chatCore.ts)

```mermaid
sequenceDiagram
    participant Client
    participant chatCore
    participant Translator
    participant Executor
    participant Provider

    Client->>chatCore: Request (any format)
    chatCore->>chatCore: Detect source format
    chatCore->>chatCore: Check bypass patterns
    chatCore->>chatCore: Resolve model & provider
    chatCore->>Translator: Translate request (source â†’ OpenAI â†’ target)
    chatCore->>Executor: Get executor for provider
    Executor->>Executor: Build URL, headers, transform request
    Executor->>Executor: Refresh credentials if needed
    Executor->>Provider: HTTP fetch (streaming or non-streaming)

    alt Streaming
        Provider-->>chatCore: SSE stream
        chatCore->>chatCore: Pipe through SSE transform stream
        Note over chatCore: Transform stream translates<br/>each chunk: target â†’ OpenAI â†’ source
        chatCore-->>Client: Translated SSE stream
    else Non-streaming
        Provider-->>chatCore: JSON response
        chatCore->>Translator: Translate response
        chatCore-->>Client: Translated JSON
    end

    alt Error (401, 429, 500...)
        chatCore->>Executor: Retry with credential refresh
        chatCore->>chatCore: Account fallback logic
    end
```

---

### 4.4 ×©×™×¨×•×ª×™× (`open-sse/services/`)

×”×™×’×™×•×Ÿ ×¢×¡×§×™ ×”×ª×•××š ×‘××˜×¤×œ×™× ×•×‘××‘×¦×¢×™×.

| ×§×•×‘×¥                 | ××˜×¨×”                                                                                                                                                                                                                                                                                                         |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `provider.ts`        | **×–×™×”×•×™ ×¤×•×¨××˜×™×** (`detectFormat`): ×× ×ª×— ××ª ××‘× ×” ×’×•×£ ×”×‘×§×©×” ×›×“×™ ×œ×–×”×•×ª ×¤×•×¨××˜×™× ×©×œ ×§×œ×•×“/OpenAI/Gemini/Antigravity/Responses (×›×•×œ×œ `max_tokens` ×”×™×•×¨×™×¡×˜×™×§×” ×¢×‘×•×¨ ×§×œ×•×“). ×›××• ×›×Ÿ: ×‘× ×™×™×ª ×›×ª×•×‘×ª URL, ×‘× ×™×™×ª ×›×•×ª×¨×•×ª, × ×•×¨××œ×™×–×¦×™×” ×©×œ ×ª×¦×•×¨×ª ×—×©×™×‘×”. ×ª×•××š ×‘×¡×¤×§×™× ×“×™× ××™×™× ×©×œ `openai-compatible-*` ×•`anthropic-compatible-*`. |
| `model.ts`           | × ×™×ª×•×— ××—×¨×•×–×ª ××•×“×œ (`claude/model-name` â†’ `{provider: "claude", model: "model-name"}`), ×¨×–×•×œ×•×¦×™×™×ª ×›×™× ×•×™ ×¢× ×–×™×”×•×™ ×”×ª× ×’×©×•×ª, ×—×™×˜×•×™ ×§×œ×˜ (×“×•×—×” ×—×¦×™×™×ª × ×ª×™×‘/×ª×•×•×™× ×‘×§×¨×”), ×•×¨×–×•×œ×•×¦×™×™×ª ××™×“×¢ ×¢×œ ×“×’× ×¢× ×ª××™×›×” ×‘-Getter ×›×™× ×•×™ ××¡×™× ×›×¨×•×Ÿ.                                                                                    |
| `accountFallback.ts` | ×˜×™×¤×•×œ ×‘××’×‘×œ×ª ×§×¦×‘: ×”×©×‘×ª×” ××§×¡×¤×•× × ×¦×™××œ×™×ª (1 ×©× ×™×•×ª â†’ 2 ×©× ×™×•×ª â†’ 4 ×©× ×™×•×ª â†’ ××§×¡×™××•× 2 ×“×§×•×ª), × ×™×”×•×œ ×”×ª×§×¨×¨×•×ª ×—×©×‘×•× ×•×ª, ×¡×™×•×•×’ ×©×’×™××•×ª (××©×¨ ×”×©×’×™××•×ª ××¢×•×¨×¨×•×ª × ×¤×™×œ×” ×œ×¢×•××ª ×œ×).                                                                                                                                              |
| `tokenRefresh.ts`    | ×¨×¢× ×•×Ÿ ××¡×™××•×Ÿ OAuth ×¢×‘×•×¨ **×›×œ ×¡×¤×§**: Google (Gemini, Antigravity), Claude, Codex, Qwen, iFlow, GitHub (OAuth + Copilot dual-token), Kiro (AWS SSO OIDC + Social Auth). ×›×•×œ×œ ××˜××•×Ÿ ×”×‘×˜×—×” ×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×‘××”×œ×š ×”×˜×™×¡×” ×•× ×™×¡×™×•×Ÿ ×—×•×–×¨ ×¢× ×”×©×‘×ª×” ××§×¡×¤×•× × ×¦×™××œ×™×ª.                                                      |
| `combo.ts`           | **×“×’××™ ××©×•×œ×‘×™×**: ×¨×©×ª×•×ª ×©×œ ×“×’××™ ×—×œ×•×“×”. ×× ×“×’× A × ×›×©×œ ×¢× ×©×’×™××” ××ª××™××”, × ×¡×” ××ª ×“×’× B, ×•×œ××—×¨ ××›×Ÿ C ×•×›×•'. ××—×–×™×¨×” ×§×•×“×™ ×¡×˜×˜×•×¡ ×‘×¤×•×¢×œ ×‘××¢×œ×” ×”×–×¨×.                                                                                                                                                                    |
| `usage.ts`           | ×©×•××‘ × ×ª×•× ×™ ××›×¡×”/×©×™××•×© ×××©×§×™ API ×©×œ ×¡×¤×§×™× (××›×¡×•×ª GitHub Copilot, ××›×¡×•×ª ×©×œ ××•×“×œ×™× × ×’×“ ×›×‘×™×“×”, ××’×‘×œ×•×ª ×ª×¢×¨×™×£ Codex, ×ª×§×œ×•×ª ×©×™××•×© ×‘-Kiro, ×”×’×“×¨×•×ª ×§×œ×•×“).                                                                                                                                                             |
| `accountSelector.ts` | ×‘×—×™×¨×ª ×—×©×‘×•×Ÿ ×—×›××” ×¢× ××œ×’×•×¨×™×ª× × ×™×§×•×“: ×œ×•×§×— ×‘×—×©×‘×•×Ÿ ×¢×“×™×¤×•×ª, ××¦×‘ ×‘×¨×™××•×ª×™, ××™×§×•× ×¡×™×‘×•×‘×™ ×•××¦×‘ ×¦×™× ×•×Ÿ ×›×“×™ ×œ×‘×—×•×¨ ××ª ×”×—×©×‘×•×Ÿ ×”××•×¤×˜×™××œ×™ ×¢×‘×•×¨ ×›×œ ×‘×§×©×”.                                                                                                                                                                     |
| `contextManager.ts`  | × ×™×”×•×œ ××—×–×•×¨ ×”×—×™×™× ×©×œ ×‘×§×©×ª ×”×§×©×¨: ×™×•×¦×¨ ×•×¢×•×§×‘ ××—×¨ ××•×‘×™×™×§×˜×™ ×”×§×©×¨ ×œ×¤×™ ×‘×§×©×” ×¢× ××˜× × ×ª×•× ×™× (××–×”×” ×‘×§×©×”, ×—×•×ª××•×ª ×–××Ÿ, ××™×“×¢ ×¢×œ ×¡×¤×§) ×œ×¦×•×¨×š × ×™×¤×•×™ ×‘××’×™× ×•×¨×™×©×•×.                                                                                                                                                           |
| `ipFilter.ts`        | ×‘×§×¨×ª ×’×™×©×” ××‘×•×¡×¡×ª IP: ×ª×•××š ×‘××¦×‘×™ ×¨×©×™××ª ×”×™×ª×¨×™× ×•×¨×©×™××ª ×—×¡×™××”. ××××ª ××ª ×”-IP ×©×œ ×”×œ×§×•×— ××•×œ ×›×œ×œ×™× ××•×’×“×¨×™× ×œ×¤× ×™ ×¢×™×‘×•×“ ×‘×§×©×•×ª API.                                                                                                                                                                                     |
| `sessionManager.ts`  | ××¢×§×‘ ××—×¨ ×¤×¢×™×œ×•×™×•×ª ×¢× ×˜×‘×™×¢×ª ××¦×‘×¢ ×©×œ ×œ×§×•×—: ×¢×•×§×‘ ××—×¨ ×¤×¢×™×œ×•×™×•×ª ×¤×¢×™×œ×•×ª ×‘×××¦×¢×•×ª ××–×”×™ ×œ×§×•×— ××’×•×‘×‘×™×, ×¢×•×§×‘ ××—×¨ ×¡×¤×™×¨×ª ×‘×§×©×•×ª ×•××¡×¤×§ ××“×“×™ ×”×¤×¢×œ×”.                                                                                                                                                                          |
| `signatureCache.ts`  | ××˜××•×Ÿ ×‘×™×˜×•×œ ×›×¤×™×œ×•×™×•×ª ××‘×•×¡×¡ ×‘×§×©×ª ×—×ª×™××”: ××•× ×¢ ×‘×§×©×•×ª ×›×¤×•×œ×•×ª ×¢×œ ×™×“×™ ×©××™×¨×” ×‘××˜××•×Ÿ ×©×œ ×—×ª×™××•×ª ×‘×§×©×•×ª ××—×¨×•× ×•×ª ×•×”×—×–×¨×ª ×ª×’×•×‘×•×ª ×©××•×¨ ×¢×‘×•×¨ ×‘×§×©×•×ª ×–×”×•×ª ×‘×ª×•×š ×—×œ×•×Ÿ ×–××Ÿ.                                                                                                                                                       |
| `systemPrompt.ts`    | ×”×–×¨×§×ª ×”× ×—×™×” ×¢×•×œ××™×ª ×œ××¢×¨×›×ª: ×”×•×¡×¤×” ××• ×”×•×¡×¤×” ×©×œ ×”× ×—×™×” ××¢×¨×›×ª ×”× ×™×ª× ×ª ×œ×”×’×“×¨×” ×œ×›×œ ×”×‘×§×©×•×ª, ×¢× ×˜×™×¤×•×œ ×‘×ª××™××•×ª ×œ×›×œ ×¡×¤×§.                                                                                                                                                                                                 |
| `thinkingBudget.ts`  | × ×™×”×•×œ ×ª×§×¦×™×‘ ××¡×™××•×Ÿ × ×™××•×§: ×ª×•××š ×‘××¦×‘×™ ××¢×‘×¨, ××•×˜×•××˜×™ (×ª×¦×•×¨×ª ×—×©×™×‘×” ×¨×¦×•×¢×ª), ××•×ª×× ××™×©×™×ª (×ª×§×¦×™×‘ ×§×‘×•×¢) ×•××¦×‘×™ ×”×¡×ª×’×œ×•×ª (×‘×’×•×“×œ ××•×¨×›×‘×•×ª) ×œ×©×œ×™×˜×” ×‘××¡×™××•× ×™ ×—×©×™×‘×”/×”×™×’×™×•×Ÿ.                                                                                                                                                 |
| `wildcardRouter.ts`  | × ×™×ª×•×‘ ×“×¤×•×¡×™ ××•×“×œ ×ª×•×•×™× ×›×œ×œ×™×™×: ×¤×•×ª×¨ ×“×¤×•×¡×™ ×ª×•×•×™× ×›×œ×œ×™×™× (×œ××©×œ, `*/claude-*`) ×œ×¦××“×™ ×¡×¤×§/××•×“×œ ×§×•× ×§×¨×˜×™×™× ×¢×œ ×¡××š ×–××™× ×•×ª ×•×¢×“×™×¤×•×ª.                                                                                                                                                                                  |

#### ×‘×™×˜×•×œ ×›×¤×™×œ×•×™×•×ª ×©×œ ×¨×¢× ×•×Ÿ ××¡×™××•×Ÿ

```mermaid
sequenceDiagram
    participant R1 as Request 1
    participant R2 as Request 2
    participant Cache as refreshPromiseCache
    participant OAuth as OAuth Provider

    R1->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: No in-flight promise
    Cache->>OAuth: Start refresh
    R2->>Cache: getAccessToken("gemini", token)
    Cache->>Cache: Found in-flight promise
    Cache-->>R2: Return existing promise
    OAuth-->>Cache: New access token
    Cache-->>R1: New access token
    Cache-->>R2: Same access token (shared)
    Cache->>Cache: Delete cache entry
```

#### Account Fallback State Machine

```mermaid
stateDiagram-v2
    [*] --> Active
    Active --> Error: Request fails (401/429/500)
    Error --> Cooldown: Apply backoff
    Cooldown --> Active: Cooldown expires
    Active --> Active: Request succeeds (reset backoff)

    state Error {
        [*] --> ClassifyError
        ClassifyError --> ShouldFallback: Rate limit / Auth / Transient
        ClassifyError --> NoFallback: 400 Bad Request
    }

    state Cooldown {
        [*] --> ExponentialBackoff
        ExponentialBackoff: Level 0 = 1s
        ExponentialBackoff: Level 1 = 2s
        ExponentialBackoff: Level 2 = 4s
        ExponentialBackoff: Max = 2min
    }
```

#### ×©×¨×©×¨×ª ×“×’× ××©×•×œ×‘×ª

```mermaid
flowchart LR
    A["Request with\ncombo model"] --> B["Model A"]
    B -->|"2xx Success"| C["Return response"]
    B -->|"429/401/500"| D{"Fallback\neligible?"}
    D -->|Yes| E["Model B"]
    D -->|No| F["Return error"]
    E -->|"2xx Success"| C
    E -->|"429/401/500"| G{"Fallback\neligible?"}
    G -->|Yes| H["Model C"]
    G -->|No| F
    H -->|"2xx Success"| C
    H -->|"Fail"| I["All failed â†’\nReturn last status"]
```

---

### 4.5 ××ª×¨×’× (`open-sse/translator/`)

The **format translation engine** using a self-registering plugin system.

#### ××¨×›×™×˜×§×˜×•×¨×”

```mermaid
graph TD
    subgraph "Request Translation"
        A["Claude â†’ OpenAI"]
        B["Gemini â†’ OpenAI"]
        C["Antigravity â†’ OpenAI"]
        D["OpenAI Responses â†’ OpenAI"]
        E["OpenAI â†’ Claude"]
        F["OpenAI â†’ Gemini"]
        G["OpenAI â†’ Kiro"]
        H["OpenAI â†’ Cursor"]
    end

    subgraph "Response Translation"
        I["Claude â†’ OpenAI"]
        J["Gemini â†’ OpenAI"]
        K["Kiro â†’ OpenAI"]
        L["Cursor â†’ OpenAI"]
        M["OpenAI â†’ Claude"]
        N["OpenAI â†’ Antigravity"]
        O["OpenAI â†’ Responses"]
    end
```

| ××“×¨×™×š        | ×§×‘×¦×™×     | ×ª×™××•×¨                                                                                                                                                                                                                         |
| ------------ | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `request/`   | 8 ××ª×¨×’××™× | ×”××¨×ª ×’×•×¤×™ ×‘×§×©×” ×‘×™×Ÿ ×¤×•×¨××˜×™×. ×›×œ ×§×•×‘×¥ × ×¨×©× ×‘×¢×¦××• ×‘×××¦×¢×•×ª `register(from, to, fn)` ×‘×™×™×‘×•×.                                                                                                                                       |
| `response/`  | 7 ××ª×¨×’××™× | ×”××¨ × ×ª×—×™ ×ª×’×•×‘×” ×–×•×¨××ª ×‘×™×Ÿ ×¤×•×¨××˜×™×. ××˜×¤×œ ×‘×¡×•×’×™ ××™×¨×•×¢×™ SSE, ×‘×œ×•×§×™ ×—×©×™×‘×”, ×§×¨×™××•×ª ×œ×›×œ×™×.                                                                                                                                           |
| `helpers/`   | 6 ×¢×•×–×¨×™×  | ×›×œ×™ ×¢×–×¨ ××©×•×ª×¤×™×: `claudeHelper` (×—×™×œ×•×¥ ×”× ×—×™×•×ª ××¢×¨×›×ª, ×ª×¦×•×¨×ª ×—×©×™×‘×”), `geminiHelper` (××™×¤×•×™ ×—×œ×§×™×/×ª×•×›×Ÿ), `openaiHelper` (×¡×™× ×•×Ÿ ×¤×•×¨××˜), `toolCallHelper` (×™×¦×™×¨×ª ××–×”×”, ×”×–×¨×§×ª ×ª×’×•×‘×” ×—×¡×¨×”), `maxTokensHelper`, `responsesApiHelper`. |
| `index.ts`   | â€”         | ×× ×•×¢ ×ª×¨×’×•×: `translateRequest()`, `translateResponse()`, ×”× ×”×œ×ª ××“×™× ×”, ×¨×™×©×•×.                                                                                                                                                  |
| `formats.ts` | â€”         | ×§×‘×•×¢×™ ×¤×•×¨××˜: `OPENAI`, `CLAUDE`, `GEMINI`, `ANTIGRAVITY`, `KIRO`, `CURSOR`, `OPENAI_RESPONSES`.                                                                                                                               |

#### ×¢×™×¦×•×‘ ××¤×ª×—: ×ª×•×¡×¤×™× ×œ×¨×™×©×•× ×¢×¦××™

```javascript
// Each translator file calls register() on import:
import { register } from "../index.js";
register("claude", "openai", translateClaudeToOpenAI);

// The index.js imports all translator files, triggering registration:
import "./request/claude-to-openai.js"; // â† self-registers
```

---

### 4.6 Utils (`open-sse/utils/`)

| ×§×•×‘×¥               | ××˜×¨×”                                                                                                                                                                                                                                     |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `error.ts`         | ×‘× ×™×™×ª ×ª×’×•×‘×ª ×©×’×™××” (×¤×•×¨××˜ ×ª×•×× OpenAI), × ×™×ª×•×— ×©×’×™××•×ª ×‘××¢×œ×” ×”×–×¨×, ×—×™×œ×•×¥ ×‘×–××Ÿ × ×™×¡×™×•×Ÿ ×—×•×–×¨ × ×’×“ ×›×‘×™×“×” ××”×•×“×¢×•×ª ×©×’×™××”, ×”×–×¨××ª ×©×’×™××•×ª SSE.                                                                                                        |
| `stream.ts`        | **SSE Transform Stream** - ×¦×™× ×•×¨ ×”×¡×˜×¨×™××™× ×’ ×”××¨×›×–×™. ×©× ×™ ××¦×‘×™×: `TRANSLATE` (×ª×¨×’×•× ×‘×¤×•×¨××˜ ××œ×) ×•-`PASSTHROUGH` (× ×¨××œ + ×—×™×œ×•×¥ ×©×™××•×©). ××˜×¤×œ ×‘×—×¦×™×¦×” ×©×œ × ×ª×—×™×, ×”×¢×¨×›×ª ×©×™××•×©, ××¢×§×‘ ××—×¨ ××•×¨×š ×ª×•×›×Ÿ. ××•×¤×¢×™ ××§×•×“×“/××¤×¢× ×—×™× ×œ×›×œ ×–×¨× × ×× ×¢×™× ×××¦×‘ ××©×•×ª×£. |
| `streamHelpers.ts` | ×›×œ×™ ×¢×–×¨ SSE ×‘×¨××” × ××•×›×”: `parseSSELine` (×¡×•×‘×œ× ×•×ª ×œ×¨×•×•×—×™× ×œ×‘× ×™×), `hasValuableContent` (××¡× × ×™× × ×ª×—×™× ×¨×™×§×™× ×¢×‘×•×¨ OpenAI/Claude/Gemini), `fixInvalidId`, `formatSSE` (× ×™×§×•×™ SSE-TOKEN_103\*\* ×”××•×“×¢ ×œ×¤×•×¨××˜ ×¢× ).                             |
| `usageTracking.ts` | ×—×™×œ×•×¥ ×©×™××•×© ×‘××¡×™××•× ×™× ××›×œ ×¤×•×¨××˜ (Claude/OpenAI/Gemini/Responses), ××•××“×Ÿ ×¢× ×™×—×¡×™ ×ª×•×•×™×/×”×•×“×¢×” × ×¤×¨×“×™× ×©×œ ×›×œ×™/×”×•×“×¢×”, ×”×•×¡×¤×ª ×—×™×¥ (××¨×•×•×— ×‘×˜×™×—×•×ª ×©×œ 2000 ××¡×™××•× ×™×), ×¡×™× ×•×Ÿ ×©×“×•×ª ×¡×¤×¦×™×¤×™ ×œ×¤×•×¨××˜, ×¨×™×©×•× ××¡×•×£ ×¢× ×¦×‘×¢×™ ANSI.                           |
| `requestLogger.ts` | ×¨×™×©×•× ×‘×§×©×•×ª ××‘×•×¡×¡ ×§×‘×¦×™× (×”×¦×˜×¨×¤×•×ª ×“×¨×š `ENABLE_REQUEST_LOGS=true`). ×™×•×¦×¨ ×ª×™×§×™×•×ª ×”×¤×¢×œ×” ×¢× ×§×‘×¦×™× ×××•×¡×¤×¨×™×: `1_req_client.json` â†’ `7_res_client.txt`. ×›×œ ×”×§×œ×˜/×¤×œ×˜ ×”×•× ××¡×™× ×›×¨×•×Ÿ (××© ×•×©×›×—). ××¡×›×” ×›×•×ª×¨×•×ª ×¨×’×™×©×•×ª.                                 |
| `bypassHandler.ts` | ××™×™×¨×˜ ×“×¤×•×¡×™× ×¡×¤×¦×™×¤×™×™× ×©×œ ×§×œ×•×“ CLI (×—×™×œ×•×¥ ×›×•×ª×¨×ª, ×—×™××•×, ×¡×¤×™×¨×”) ×•××—×–×™×¨ ×ª×’×•×‘×•×ª ××–×•×™×¤×•×ª ××‘×œ×™ ×œ×”×ª×§×©×¨ ×œ××£ ×¡×¤×§. ×ª×•××š ×’× ×‘×¡×˜×¨×™××™× ×’ ×•×’× ×œ× ×‘×¡×˜×¨×™××™× ×’. ××•×’×‘×œ ×‘×›×•×•× ×” ×œ×”×™×§×£ ×§×œ×•×“ CLI.                                                                |
| `networkProxy.ts`  | ×¤×•×ª×¨ ×›×ª×•×‘×ª URL ×©×œ proxy ×™×•×¦××ª ×¢×‘×•×¨ ×¡×¤×§ × ×ª×•×Ÿ ×¢× ×¢×“×™×¤×•×ª: ×ª×¦×•×¨×” ×¡×¤×¦×™×¤×™×ª ×œ×¡×¤×§ â†’ ×ª×¦×•×¨×” ×’×œ×•×‘×œ×™×ª â†’ ××©×ª× ×™ ×¡×‘×™×‘×” (`HTTPS_PROXY`/`HTTP_PROXY`/`ALL_PROXY`). ×ª×•××š ×‘×”×—×¨×’×•×ª `NO_PROXY`. ×ª×¦×•×¨×ª ××˜××•×Ÿ ×¢×‘×•×¨ ×©× ×•×ª ×”-30.                                   |

#### ×¦×™× ×•×¨ ×”×–×¨××ª SSE

```mermaid
flowchart TD
    A["Provider SSE stream"] --> B["TextDecoder\n(per-stream instance)"]
    B --> C["Buffer lines\n(split on newline)"]
    C --> D["parseSSELine()\n(trim whitespace, parse JSON)"]
    D --> E{"Mode?"}
    E -->|TRANSLATE| F["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E -->|PASSTHROUGH| G["fixInvalidId()\nnormalize chunk"]
    F --> H["hasValuableContent()\nfilter empty chunks"]
    G --> H
    H -->|"Has content"| I["extractUsage()\ntrack token counts"]
    H -->|"Empty"| J["Skip chunk"]
    I --> K["formatSSE()\nserialize + clean perf_metrics"]
    K --> L["TextEncoder\n(per-stream instance)"]
    L --> M["Enqueue to\nclient stream"]

    style A fill:#f9f,stroke:#333
    style M fill:#9f9,stroke:#333
```

#### ×‘×§×© ××‘× ×” ×”×¤×¢×œ×” ×©×œ ×œ×•×’×¨

```
logs/
â””â”€â”€ claude_gemini_claude-sonnet_20260208_143045/
    â”œâ”€â”€ 1_req_client.json      â† Raw client request
    â”œâ”€â”€ 2_req_source.json      â† After initial conversion
    â”œâ”€â”€ 3_req_openai.json      â† OpenAI intermediate format
    â”œâ”€â”€ 4_req_target.json      â† Final target format
    â”œâ”€â”€ 5_res_provider.txt     â† Provider SSE chunks (streaming)
    â”œâ”€â”€ 5_res_provider.json    â† Provider response (non-streaming)
    â”œâ”€â”€ 6_res_openai.txt       â† OpenAI intermediate chunks
    â”œâ”€â”€ 7_res_client.txt       â† Client-facing SSE chunks
    â””â”€â”€ 6_error.json           â† Error details (if any)
```

---

### 4.7 ×©×›×‘×ª ×™×™×©×•××™× (`src/`)

| ××“×¨×™×š         | ××˜×¨×”                                                                                |
| ------------- | ----------------------------------------------------------------------------------- |
| `src/app/`    | ×××©×§ ××©×ª××© ××™× ×˜×¨× ×˜, ××¡×œ×•×œ×™ API, ×ª×•×›× ×ª ×‘×™× ×™×™× ××§×¡×¤×¨×¡, ××˜×¤×œ×™× ×‘×”×ª×§×©×¨×•×ª ×—×•×–×¨×ª ×©×œ OAuth |
| `src/lib/`    | ×’×™×©×” ×œ××¡×“ × ×ª×•× ×™× (`localDb.ts`, `usageDb.ts`), ××™××•×ª, ××©×•×ª×£                         |
| `src/mitm/`   | ×›×œ×™ ×¤×¨×•×§×¡×™ ×©×œ ××“×-×‘×××¦×¢ ×œ×™×™×¨×•×˜ ×ª×¢×‘×•×¨×ª ×¡×¤×§×™×                                         |
| `src/models/` | ×”×’×“×¨×•×ª ××•×“×œ ××¡×“ × ×ª×•× ×™×                                                              |
| `src/shared/` | ×¢×•×˜×¤×™× ×¡×‘×™×‘ ×¤×•× ×§×¦×™×•×ª Open-sse (×¡×¤×§, ×–×¨×, ×©×’×™××” ×•×›×•')                                |
| `src/sse/`    | ××˜×¤×œ×™ × ×§×•×“×•×ª ×§×¦×” SSE ×”××—×•×‘×¨×™× ××ª ×¡×¤×¨×™×™×ª ×”-Open-sse ×œ× ×ª×™×‘×™ Express                   |
| `src/store/`  | × ×™×”×•×œ ××¦×‘ ×™×™×©×•××™×                                                                   |

#### × ×ª×™×‘×™ API ×‘×•×œ×˜×™×

| ××¡×œ×•×œ                                         | ×©×™×˜×•×ª          | ××˜×¨×”                                                                       |
| --------------------------------------------- | -------------- | -------------------------------------------------------------------------- |
| `/api/provider-models`                        | ×§×‘×œ/×¤×¨×¡×/××—×§   | CRUD ×¢×‘×•×¨ ×“×’××™× ××•×ª×××™× ××™×©×™×ª ×œ×›×œ ×¡×¤×§                                      |
| `/api/models/catalog`                         | ×§×‘×œ            | ×§×˜×œ×•×’ ××¦×˜×‘×¨ ×©×œ ×›×œ ×”×“×’××™× (×¦'××˜, ×”×˜××¢×”, ×ª××•× ×”, ××•×ª×× ××™×©×™×ª) ××§×•×‘×¦×™× ×œ×¤×™ ×¡×¤×§ |
| `/api/settings/proxy`                         | GET/PUT/DELETE | ×ª×¦×•×¨×ª proxy ×™×•×¦××ª ×”×™×¨×¨×›×™×ª (`global/providers/combos/keys`)                 |
| `/api/settings/proxy/test`                    | ×¤×•×¡×˜           | ××××ª ××ª ×§×™×©×•×¨×™×•×ª ×”-proxy ×•××—×–×™×¨×” IP/×”×©×”×™×™×” ×¦×™×‘×•×¨×™×ª                         |
| `/v1/providers/[provider]/chat/completions`   | ×¤×•×¡×˜           | ×”×©×œ××•×ª ×¦'××˜ ×™×™×¢×•×“×™×•×ª ×œ×›×œ ×¡×¤×§ ×¢× ××™××•×ª ××•×“×œ                                 |
| `/v1/providers/[provider]/embeddings`         | ×¤×•×¡×˜           | ×”×˜××¢×•×ª ×™×™×¢×•×“×™×•×ª ×œ×›×œ ×¡×¤×§ ×¢× ××™××•×ª ××•×“×œ                                      |
| `/v1/providers/[provider]/images/generations` | ×¤×•×¡×˜           | ×™×¦×™×¨×ª ×ª××•× ×” ×™×™×¢×•×“×™×ª ×œ×›×œ ×¡×¤×§ ×¢× ××™××•×ª ××•×“×œ                                  |
| `/api/settings/ip-filter`                     | GET/PUT        | × ×™×”×•×œ ×¨×©×™××ª ×”×¨×©××•×ª IP/×¨×©×™××ª ×—×¡×™××”                                          |
| `/api/settings/thinking-budget`               | GET/PUT        | ×ª×¦×•×¨×ª ×ª×§×¦×™×‘ ××¡×™××•×Ÿ × ×™××•×§ (××¢×‘×¨/××•×˜×•××˜×™/××•×ª×× ××™×©×™×ª/××•×ª××)                  |
| `/api/settings/system-prompt`                 | GET/PUT        | ×”×–×¨×§×” ××”×™×¨×” ×©×œ ××¢×¨×›×ª ×’×œ×•×‘×œ×™×ª ×œ×›×œ ×”×‘×§×©×•×ª                                    |
| `/api/sessions`                               | ×§×‘×œ            | ××¢×§×‘ ×•××“×“×™ ×”×¤×¢×œ×” ×¤×¢×™×œ×™×                                                    |
| `/api/rate-limits`                            | ×§×‘×œ            | ×¡×˜×˜×•×¡ ××’×‘×œ×ª ×ª×¢×¨×™×£ ×œ×›×œ ×—×©×‘×•×Ÿ                                                |

---

## 5. ×“×¤×•×¡×™ ×¢×™×¦×•×‘ ××¤×ª×—

### 5.1 ×ª×¨×’×•× ×¨×›×–×ª ×•×“×™×‘×•×¨

×›×œ ×”×¤×•×¨××˜×™× ××ª×•×¨×’××™× ×‘×××¦×¢×•×ª **×¤×•×¨××˜ OpenAI ×›××¨×›×–**. ×”×•×¡×¤×ª ×¡×¤×§ ×—×“×© ×“×•×¨×©×ª ×¨×§ ×›×ª×™×‘×ª **×–×•×’ ××—×“** ×©×œ ××ª×¨×’××™× (×œ/× OpenAI), ×œ× N ×–×•×’×•×ª.

### 5.2 ×“×¤×•×¡ ××¡×˜×¨×˜×’×™×™×ª ××‘×¦×¢×™×

×œ×›×œ ×¡×¤×§ ×™×© ××—×œ×§×ª ××‘×¦×¢×™× ×™×™×¢×•×“×™×ª ×©×™×•×¨×©×ª ×`BaseExecutor`. ×”××¤×¢×œ ×‘`executors/index.ts` ×‘×•×—×¨ ××ª ×”××ª××™× ×‘×–××Ÿ ×”×¨×™×¦×”.

### 5.3 ××¢×¨×›×ª ×¤×œ××’×™×Ÿ ×œ×¨×™×©×•× ×¢×¦××™

××•×“×•×œ×™ ××ª×¨×’× ×¨×•×©××™× ××ª ×¢×¦×× ×‘×™×™×‘×•× ×“×¨×š `register()`. ×”×•×¡×¤×ª ××ª×¨×’× ×—×“×© ×”×™× ×¨×§ ×™×¦×™×¨×ª ×§×•×‘×¥ ×•×™×‘×•××•.

### 5.4 ×—×–×¨×” ×‘×—×©×‘×•×Ÿ ×¢× ×’×™×‘×•×™ ××§×¡×¤×•× × ×¦×™××œ×™

×›××©×¨ ×¡×¤×§ ××—×–×™×¨ 429/401/500, ×”××¢×¨×›×ª ×™×›×•×œ×” ×œ×¢×‘×•×¨ ×œ×—×©×‘×•×Ÿ ×”×‘×, ×ª×•×š ×”×¤×¢×œ×ª ×¦×™× ×•×Ÿ ××§×¡×¤×•× × ×¦×™××œ×™ (1s â†’ 2s â†’ 4s â†’ max 2mins).

### ×©×¨×©×¨××•×ª ×“×’× 5.5 ××©×•×œ×‘×•×ª

"×§×•××‘×•" ××§×‘×¥ `provider/model` ××—×¨×•×–×•×ª ××¨×•×‘×•×ª. ×× ×”×¨××©×•×Ÿ × ×›×©×œ, ×—×–×•×¨ ××œ ×”×‘× ×‘××•×¤×Ÿ ××•×˜×•××˜×™.

### 5.6 ×ª×¨×’×•× ×¡×˜×¨×™××™× ×’ ×××œ×›×ª×™

×ª×¨×’×•× ×ª×’×•×‘×” ×©×•××¨ ×¢×œ ××¦×‘ ×¢×œ ×¤× ×™ × ×ª×—×™ SSE (××¢×§×‘ ××—×¨ ×‘×œ×•×§ ×—×©×™×‘×”, ×¦×‘×™×¨×ª ×§×¨×™××•×ª ×œ×›×œ×™, ××™× ×“×§×¡ ×©×œ ×—×¡×™××•×ª ×ª×•×›×Ÿ) ×‘×××¦×¢×•×ª ×× ×’× ×•×Ÿ `initState()`.

### 5.7 ×××’×¨ ×‘×˜×™×—×•×ª ×œ×©×™××•×©

×××’×¨ ×©×œ 2000 ××¡×™××•×Ÿ × ×•×¡×£ ×œ×©×™××•×© ×”××“×•×•×— ×›×“×™ ×œ×× ×•×¢ ××œ×§×•×—×•×ª ×œ×”×’×™×¢ ×œ××’×‘×œ×•×ª ×—×œ×•× ×•×ª ×”×”×§×©×¨ ×¢×§×‘ ×ª×§×•×¨×” ××”× ×—×™×•×ª ××¢×¨×›×ª ×•×ª×¨×’×•× ×¤×•×¨××˜×™×.

---

## 6. ×¤×•×¨××˜×™× × ×ª××›×™×

| ×¤×•×¨××˜                 | ×›×™×•×•×Ÿ      | ××–×”×”               |
| --------------------- | ---------- | ------------------ |
| ×”×©×œ××•×ª ×¦'××˜ ×©×œ OpenAI | ××§×•×¨ + ×™×¢×“ | `openai`           |
| OpenAI Responses API  | ××§×•×¨ + ×™×¢×“ | `openai-responses` |
| ×”×× ×ª×¨×•×¤×™ ×§×œ×•×“         | ××§×•×¨ + ×™×¢×“ | `claude`           |
| Google Gemini         | ××§×•×¨ + ×™×¢×“ | `gemini`           |
| Google Gemini CLI     | ×”×™×¢×“ ×‘×œ×‘×“  | `gemini-cli`       |
| ×× ×˜×™ ×›×‘×™×“×”            | ××§×•×¨ + ×™×¢×“ | `antigravity`      |
| AWS Kiro              | ×”×™×¢×“ ×‘×œ×‘×“  | `kiro`             |
| ×¡××Ÿ                   | ×”×™×¢×“ ×‘×œ×‘×“  | `cursor`           |

---

## 7. ×¡×¤×§×™× × ×ª××›×™×

| ×¡×¤×§                      | ×©×™×˜×ª ××™×©×•×¨            | ××•×¦×™× ×œ×¤×•×¢×œ | ×”×¢×¨×•×ª ××¤×ª×—                                     |
| ------------------------ | --------------------- | ----------- | ---------------------------------------------- |
| ×”×× ×ª×¨×•×¤×™×ª ×§×œ×•×“           | ××¤×ª×— API ××• OAuth     | ×‘×¨×™×¨×ª ××—×“×œ  | ××©×ª××© ×‘×›×•×ª×¨×ª `x-api-key`                       |
| Google Gemini            | ××¤×ª×— API ××• OAuth     | ×‘×¨×™×¨×ª ××—×“×œ  | ××©×ª××© ×‘×›×•×ª×¨×ª `x-goog-api-key`                  |
| Google Gemini CLI        | OAuth                 | GeminiCLI   | ××©×ª××© ×‘× ×§×•×“×ª ×§×¦×” `streamGenerateContent`       |
| ×× ×˜×™ ×›×‘×™×“×”               | OAuth                 | ×× ×˜×™ ×›×‘×™×“×”  | × ×™×ª×•×§ ×¨×‘ ×›×ª×•×‘×•×ª ××ª×¨×™×, × ×™×¡×™×•×Ÿ ×—×•×–×¨ ××•×ª×× ××™×©×™×ª |
| OpenAI                   | ××¤×ª×— API              | ×‘×¨×™×¨×ª ××—×“×œ  | ××™×©×•×¨ × ×•×©× ×ª×§×Ÿ                                 |
| ×§×•×“×§×¡                    | OAuth                 | ×§×•×“×§×¡       | ××–×¨×™×§ ×”×•×¨××•×ª ××¢×¨×›×ª, ×× ×”×œ ×—×©×™×‘×”                 |
| GitHub Copilot           | OAuth + ××¡×™××•×Ÿ ×¤×™×™×œ×•×˜ | Github      | ××¡×™××•×Ÿ ×›×¤×•×œ, ××—×§×” ×›×•×ª×¨×ª VSCode                 |
| ×§×™×¨×• (AWS)               | AWS SSO OIDC ××• ×—×‘×¨×ª×™ | ×§×™×¨×•        | × ×™×ª×•×— EventStream ×‘×™× ××¨×™                       |
| ×”×¡××Ÿ IDE                 | Checksum Auth         | ×¡××Ÿ         | ×§×™×“×•×“ ×¤×¨×•×˜×•×‘×•×£, ×¡×™×›×•××™ ×‘×™×§×•×¨×ª SHA-256          |
| ×§×•×•×Ÿ                     | OAuth                 | ×‘×¨×™×¨×ª ××—×“×œ  | ××™×©×•×¨ ×¨×’×™×œ                                     |
| iFlow                    | OAuth (×‘×¡×™×¡×™ + × ×•×©×)  | ×‘×¨×™×¨×ª ××—×“×œ  | ×›×•×ª×¨×ª ××™×©×•×¨ ×›×¤×•×œ×”                              |
| OpenRouter               | ××¤×ª×— API              | ×‘×¨×™×¨×ª ××—×“×œ  | ××™×©×•×¨ × ×•×©× ×ª×§×Ÿ                                 |
| GLM, Kimi, MiniMax       | ××¤×ª×— API              | ×‘×¨×™×¨×ª ××—×“×œ  | ×ª×•×× ×§×œ×•×“, ×”×©×ª××© ×‘-`x-api-key`                 |
| `openai-compatible-*`    | ××¤×ª×— API              | ×‘×¨×™×¨×ª ××—×“×œ  | ×“×™× ××™: ×›×œ × ×§×•×“×ª ×§×¦×” ×ª×•×××ª OpenAI               |
| `anthropic-compatible-*` | ××¤×ª×— API              | ×‘×¨×™×¨×ª ××—×“×œ  | ×“×™× ××™: ×›×œ × ×§×•×“×ª ×§×¦×” ×ª×•×××ª ×§×œ×•×“                 |

---

## 8. ×¡×™×›×•× ×–×¨×™××ª × ×ª×•× ×™×

### ×‘×§×©×ª ×¡×˜×¨×™××™× ×’

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor\nbuildUrl + buildHeaders"]
    D --> E["fetch(providerURL)"]
    E --> F["createSSEStream()\nTRANSLATE mode"]
    F --> G["parseSSELine()"]
    G --> H["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    H --> I["extractUsage()\n+ addBuffer"]
    I --> J["formatSSE()"]
    J --> K["Client receives\ntranslated SSE"]
    K --> L["logUsage()\nsaveRequestUsage()"]
```

### ×‘×§×©×” ×œ×œ× ×¡×˜×¨×™××™× ×’

```mermaid
flowchart LR
    A["Client"] --> B["detectFormat()"]
    B --> C["translateRequest()\nsource â†’ OpenAI â†’ target"]
    C --> D["Executor.execute()"]
    D --> E["translateResponse()\ntarget â†’ OpenAI â†’ source"]
    E --> F["Return JSON\nresponse"]
```

### ×–×¨×™××” ×¢×•×§×¤×ª (×§×œ×•×“ CLI)

```mermaid
flowchart LR
    A["Claude CLI request"] --> B{"Match bypass\npattern?"}
    B -->|"Title/Warmup/Count"| C["Generate fake\nOpenAI response"]
    B -->|"No match"| D["Normal flow"]
    C --> E["Translate to\nsource format"]
    E --> F["Return without\ncalling provider"]
```
